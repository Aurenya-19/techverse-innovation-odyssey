<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse: Ultimate Living City</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; color: #fff; }
#canvas { display: block; width: 100vw; height: 100vh; position: fixed; }

#charSelect { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #1a0033, #330066, #004488); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; overflow-y: auto; padding: 20px; z-index: 10000; }
#charSelect h1 { font-size: clamp(2em, 4vw, 3.5em); color: #0ff; text-shadow: 0 0 30px #0ff, 0 0 60px #0ff; margin: 20px 0; animation: glow 2s infinite; }
@keyframes glow { 0%, 100% { text-shadow: 0 0 20px #0ff; } 50% { text-shadow: 0 0 60px #0ff, 0 0 100px #0ff; } }
.subtitle { font-size: clamp(0.9em, 1.5vw, 1.2em); color: #aaf; margin-bottom: 20px; text-align: center; }
.charGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-width: 1200px; width: 100%; padding: 10px; margin-bottom: 20px; }
.charCard { background: rgba(0, 255, 255, 0.2); border: 2px solid #0ff; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.3s; text-align: center; min-height: 160px; backdrop-filter: blur(10px); }
.charCard:hover { background: rgba(0, 255, 255, 0.4); transform: translateY(-5px) scale(1.05); box-shadow: 0 10px 40px rgba(0, 255, 255, 0.6); }
.charCard.selected { background: rgba(0, 255, 0, 0.4); border-color: #0f0; box-shadow: 0 0 50px rgba(0, 255, 0, 0.8); }
.charCard .icon { font-size: 2.5em; margin-bottom: 8px; }
.charCard h3 { color: #0ff; font-size: 1.1em; margin: 8px 0; }
.charCard p { color: #aaf; font-size: 0.8em; line-height: 1.3; }
#startBtn { padding: 15px 50px; font-size: clamp(1em, 2vw, 1.3em); background: linear-gradient(135deg, #0ff, #0f0, #ff0); border: none; border-radius: 12px; color: #000; font-weight: bold; cursor: pointer; margin: 20px 0; text-transform: uppercase; box-shadow: 0 5px 30px rgba(0, 255, 255, 0.5); }
#startBtn:hover:not(:disabled) { transform: scale(1.1); box-shadow: 0 10px 50px rgba(0, 255, 255, 0.8); }
#startBtn:disabled { opacity: 0.3; cursor: not-allowed; }

#loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0, 0, 0, 0.95); padding: 40px; border-radius: 15px; border: 3px solid #0ff; z-index: 9999; box-shadow: 0 0 50px rgba(0, 255, 255, 0.8); }
#loading h2 { color: #0ff; font-size: 1.8em; margin-bottom: 15px; }
.spinner { border: 4px solid rgba(0, 255, 255, 0.3); border-top: 4px solid #0ff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 15px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

#hud { position: fixed; top: 15px; left: 15px; background: rgba(0, 0, 0, 0.85); padding: 18px; border-radius: 10px; border: 2px solid #0ff; min-width: 220px; z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(0, 255, 255, 0.5); }
#hud h3 { color: #0ff; font-size: 1.1em; margin-bottom: 10px; border-bottom: 2px solid #0ff; padding-bottom: 6px; }
.hudStat { display: flex; justify-content: space-between; margin: 6px 0; font-size: 0.9em; color: #aaf; }
.hudStat .val { color: #0f0; font-weight: bold; text-shadow: 0 0 10px #0f0; }

#interact { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.95); padding: 25px 35px; border-radius: 15px; border: 3px solid #0ff; max-width: 700px; width: 90%; text-align: center; z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 0 50px rgba(0, 255, 255, 0.7); }
#interact h4 { color: #0ff; font-size: 1.6em; margin-bottom: 12px; text-shadow: 0 0 20px #0ff; }
#interact p { color: #aaf; font-size: 1em; margin-bottom: 15px; line-height: 1.6; }
.actBtn { padding: 12px 28px; background: linear-gradient(135deg, #0ff, #08f, #00f); border: none; border-radius: 10px; color: #fff; font-weight: bold; cursor: pointer; margin: 6px; font-size: 1em; text-transform: uppercase; box-shadow: 0 5px 20px rgba(0, 255, 255, 0.5); }
.actBtn:hover { transform: scale(1.1); box-shadow: 0 8px 30px rgba(0, 255, 255, 0.8); }

#techExperience { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
#techExperience h2 { color: #0ff; font-size: 3em; margin-bottom: 20px; text-shadow: 0 0 40px #0ff; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
#techExperience p { color: #aaf; font-size: 1.3em; margin: 10px 0; max-width: 800px; text-align: center; line-height: 1.8; }
.exitBtn { padding: 15px 40px; background: linear-gradient(135deg, #f00, #f80); border: none; border-radius: 10px; color: #fff; font-weight: bold; cursor: pointer; margin-top: 30px; font-size: 1.2em; box-shadow: 0 5px 20px rgba(255, 0, 0, 0.5); }
.exitBtn:hover { transform: scale(1.1); }

#notif { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0f0, #0ff); color: #000; padding: 15px 35px; border-radius: 12px; font-weight: bold; font-size: 1.1em; opacity: 0; transition: opacity 0.3s; max-width: 85%; text-align: center; z-index: 2000; box-shadow: 0 5px 30px rgba(0, 255, 0, 0.7); }
#notif.show { opacity: 1; }

.hide { display: none !important; }

#particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<canvas id="particles"></canvas>

<div id="charSelect">
  <h1>üöÄ TechVerse: Ultimate Living City</h1>
  <p class="subtitle">Experience a beautiful, living world with real technology</p>
  <div class="charGrid">
    <div class="charCard" data-char="netrunner"><div class="icon">üíª</div><h3>Netrunner</h3><p>Hacker & VR specialist</p></div>
    <div class="charCard" data-char="bioengineer"><div class="icon">üß¨</div><h3>Bioengineer</h3><p>Gene editing expert</p></div>
    <div class="charCard" data-char="quantum"><div class="icon">‚öõÔ∏è</div><h3>Quantum Physicist</h3><p>Reality manipulator</p></div>
    <div class="charCard" data-char="neurohacker"><div class="icon">üß†</div><h3>Neurohacker</h3><p>Mind engineer</p></div>
    <div class="charCard" data-char="nanoengineer"><div class="icon">üî¨</div><h3>Nanoengineer</h3><p>Atomic builder</p></div>
    <div class="charCard" data-char="aiarchitect"><div class="icon">ü§ñ</div><h3>AI Architect</h3><p>AI creator</p></div>
    <div class="charCard" data-char="spacesystems"><div class="icon">üöÄ</div><h3>Space Engineer</h3><p>Orbital specialist</p></div>
    <div class="charCard" data-char="fusionengineer"><div class="icon">‚ö°</div><h3>Fusion Engineer</h3><p>Energy pioneer</p></div>
  </div>
  <button id="startBtn" disabled>Select Character</button>
</div>

<div id="loading" class="hide">
  <h2>Building Beautiful World...</h2>
  <div class="spinner"></div>
  <p id="loadText">Creating sky...</p>
</div>

<div id="hud" class="hide">
  <h3>‚ö° STATUS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>Rep:</span><span class="val" id="rep">0</span></div>
  <div class="hudStat"><span>Fund:</span><span class="val" id="fund">$500K</span></div>
  <div class="hudStat"><span>Tech Used:</span><span class="val" id="techUsed">0</span></div>
</div>

<div id="interact" class="hide">
  <h4 id="intTitle">Location</h4>
  <p id="intDesc">Description</p>
  <div id="intBtns"></div>
</div>

<div id="techExperience" class="hide">
  <h2 id="techExpTitle">Technology</h2>
  <p id="techExpDesc">Experience</p>
  <div id="techExpVisual"></div>
  <button class="exitBtn" onclick="window.exitTechExp()">EXIT EXPERIENCE</button>
</div>

<div id="notif"></div>

<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"}}</script>
<script type="module">
import * as THREE from 'three';

const state = { char: null, lvl: 1, rep: 0, fund: 500000, techUsed: 0, timeOfDay: 0.5 };

let scene, camera, renderer, npcs = [], cars = [], curInteract = null;
let moveF = false, moveB = false, moveL = false, moveR = false;
const vel = new THREE.Vector3(), dir = new THREE.Vector3(), clock = new THREE.Clock();

// Particle system for atmosphere
const particleCanvas = document.getElementById('particles');
const particleCtx = particleCanvas.getContext('2d');
particleCanvas.width = window.innerWidth;
particleCanvas.height = window.innerHeight;
const particles = [];

for (let i = 0; i < 100; i++) {
  particles.push({
    x: Math.random() * particleCanvas.width,
    y: Math.random() * particleCanvas.height,
    vx: (Math.random() - 0.5) * 0.5,
    vy: (Math.random() - 0.5) * 0.5,
    size: Math.random() * 3 + 1,
    color: ['rgba(0,255,255,0.5)', 'rgba(255,0,255,0.5)', 'rgba(0,255,0,0.5)'][Math.floor(Math.random() * 3)]
  });
}

function animateParticles() {
  particleCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
  particleCtx.fillRect(0, 0, particleCanvas.width, particleCanvas.height);
  
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    
    if (p.x < 0 || p.x > particleCanvas.width) p.vx *= -1;
    if (p.y < 0 || p.y > particleCanvas.height) p.vy *= -1;
    
    particleCtx.fillStyle = p.color;
    particleCtx.beginPath();
    particleCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    particleCtx.fill();
  });
  
  requestAnimationFrame(animateParticles);
}
animateParticles();

function init() {
  scene = new THREE.Scene();
  
  // BEAUTIFUL SKY with gradient
  const skyGeo = new THREE.SphereGeometry(500, 32, 32);
  const skyMat = new THREE.ShaderMaterial({
    uniforms: {
      topColor: { value: new THREE.Color(0x0077ff) },
      bottomColor: { value: new THREE.Color(0xff6600) },
      offset: { value: 33 },
      exponent: { value: 0.6 }
    },
    vertexShader: `
      varying vec3 vWorldPosition;
      void main() {
        vec4 worldPosition = modelMatrix * vec4(position, 1.0);
        vWorldPosition = worldPosition.xyz;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,
    fragmentShader: `
      uniform vec3 topColor;
      uniform vec3 bottomColor;
      uniform float offset;
      uniform float exponent;
      varying vec3 vWorldPosition;
      void main() {
        float h = normalize(vWorldPosition + offset).y;
        gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0);
      }
    `,
    side: THREE.BackSide
  });
  const sky = new THREE.Mesh(skyGeo, skyMat);
  scene.add(sky);

  camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  camera.position.set(0, 5, 30);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;

  // Lights
  scene.add(new THREE.AmbientLight(0x6688aa, 1));
  const sun = new THREE.DirectionalLight(0xffffee, 1.8);
  sun.position.set(100, 200, 100);
  sun.castShadow = true;
  sun.shadow.mapSize.width = 2048;
  sun.shadow.mapSize.height = 2048;
  scene.add(sun);

  // Colorful city lights
  const lightColors = [0x00ffff, 0xff00ff, 0x00ff00, 0xffff00, 0xff8800, 0x0088ff, 0xff0088, 0x88ff00];
  for (let i = 0; i < 30; i++) {
    const x = (Math.random() - 0.5) * 400;
    const z = (Math.random() - 0.5) * 400;
    addLight(x, 15 + Math.random() * 10, z, lightColors[i % lightColors.length], 3);
  }

  createWorld();
  createNPCs();
  createCars();
  setupControls();
  animate();
  updateHUD();

  notify('üåü Welcome to the Beautiful Living City! Explore and experience real technology!');
  setTimeout(() => notify('üí° Press E near labs or NPCs to interact!'), 4000);
}

function addLight(x, y, z, color, intensity) {
  const light = new THREE.PointLight(color, intensity, 120);
  light.position.set(x, y, z);
  light.castShadow = true;
  scene.add(light);
  
  // Visible glow
  const glow = new THREE.Mesh(
    new THREE.SphereGeometry(1.5, 16, 16),
    new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.8 })
  );
  glow.position.set(x, y, z);
  scene.add(glow);
}

function createWorld() {
  // COLORFUL GROUND - Green grass areas
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(1000, 1000, 50, 50),
    new THREE.MeshStandardMaterial({ 
      color: 0x2a5a2a,
      roughness: 0.9,
      metalness: 0.1
    })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);

  // Blue water features
  for (let i = 0; i < 5; i++) {
    const water = new THREE.Mesh(
      new THREE.CircleGeometry(20 + Math.random() * 20, 32),
      new THREE.MeshStandardMaterial({ 
        color: 0x0088ff,
        roughness: 0.1,
        metalness: 0.8,
        emissive: 0x0044aa,
        emissiveIntensity: 0.3
      })
    );
    water.rotation.x = -Math.PI / 2;
    water.position.set((Math.random() - 0.5) * 400, 0.2, (Math.random() - 0.5) * 400);
    scene.add(water);
  }

  // Colorful roads
  for (let i = -250; i <= 250; i += 50) {
    createRoad(i, 0, 0, 1000, 10, 0x333344);
    createRoad(0, 0, i, 10, 1000, 0x333344);
  }

  // Road markings
  const grid = new THREE.GridHelper(1000, 200, 0xffff00, 0x444455);
  scene.add(grid);

  // ALL 8 LABS with unique colors
  const labs = [
    { name: 'QUANTUM LAB', pos: [-100, 0, -120], color: 0xff00ff, size: 35, height: 60 },
    { name: 'BIO LAB', pos: [100, 0, -120], color: 0x00ff88, size: 35, height: 55 },
    { name: 'AI LAB', pos: [-100, 0, 120], color: 0xff0088, size: 35, height: 58 },
    { name: 'NANO LAB', pos: [100, 0, 120], color: 0xff8800, size: 35, height: 52 },
    { name: 'FUSION LAB', pos: [-150, 0, 0], color: 0xff4400, size: 30, height: 70 },
    { name: 'NEURAL LAB', pos: [150, 0, 0], color: 0x00ff00, size: 30, height: 65 },
    { name: 'SPACE LAB', pos: [0, 0, -150], color: 0x4400ff, size: 40, height: 75 },
    { name: 'HYBRID LAB', pos: [0, 0, 0], color: 0x00ffff, size: 45, height: 80 }
  ];

  labs.forEach(lab => {
    createLab(lab.pos[0], lab.pos[1], lab.pos[2], lab.size, lab.height, lab.size, lab.color, lab.name);
  });

  // Colorful buildings
  const buildingColors = [0x4488ff, 0xff4488, 0x44ff88, 0xffaa44, 0xaa44ff, 0x44ffaa];
  for (let i = 0; i < 60; i++) {
    const x = (Math.random() - 0.5) * 450;
    const z = (Math.random() - 0.5) * 450;
    const w = 12 + Math.random() * 18;
    const h = 25 + Math.random() * 50;
    const color = buildingColors[Math.floor(Math.random() * buildingColors.length)];
    createBuilding(x, 0, z, w, h, w, color);
  }

  // Beautiful stars
  const stars = new THREE.BufferGeometry();
  const verts = [];
  const colors = [];
  for (let i = 0; i < 50000; i++) {
    verts.push(
      (Math.random() - 0.5) * 10000,
      Math.random() * 5000,
      (Math.random() - 0.5) * 10000
    );
    const c = new THREE.Color();
    c.setHSL(Math.random(), 0.8, 0.8);
    colors.push(c.r, c.g, c.b);
  }
  stars.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
  stars.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
  scene.add(new THREE.Points(stars, new THREE.PointsMaterial({ 
    size: 1.5,
    vertexColors: true,
    transparent: true,
    opacity: 0.9
  })));
}

function createRoad(x, y, z, w, d, color) {
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(w, d),
    new THREE.MeshStandardMaterial({ color, roughness: 0.9 })
  );
  road.rotation.x = -Math.PI / 2;
  road.position.set(x, y + 0.1, z);
  road.receiveShadow = true;
  scene.add(road);
}

function createLab(x, y, z, w, h, d, color, name) {
  const bldg = new THREE.Mesh(
    new THREE.BoxGeometry(w, h, d),
    new THREE.MeshStandardMaterial({
      color,
      roughness: 0.2,
      metalness: 0.8,
      emissive: color,
      emissiveIntensity: 0.5
    })
  );
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  bldg.receiveShadow = true;
  bldg.userData = { type: 'lab', name, color };
  scene.add(bldg);

  // Glowing edges
  const edges = new THREE.EdgesGeometry(bldg.geometry);
  bldg.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 })));

  // Colorful windows
  for (let i = 0; i < 10; i++) {
    const window = new THREE.Mesh(
      new THREE.PlaneGeometry(w * 0.7, h / 12),
      new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.8 })
    );
    window.position.set(0, -h / 2 + (i + 1) * (h / 11), d / 2 + 0.1);
    bldg.add(window);
  }

  // Entrance
  const entrance = new THREE.Mesh(
    new THREE.BoxGeometry(8, 12, 2),
    new THREE.MeshBasicMaterial({ color: 0xffffff })
  );
  entrance.position.set(0, 6, d / 2 + 1);
  bldg.add(entrance);

  createLabel(name, x, h + 10, z, 2);
}

function createBuilding(x, y, z, w, h, d, color) {
  const bldg = new THREE.Mesh(
    new THREE.BoxGeometry(w, h, d),
    new THREE.MeshStandardMaterial({ 
      color, 
      roughness: 0.4, 
      metalness: 0.6,
      emissive: color,
      emissiveIntensity: 0.2
    })
  );
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  bldg.receiveShadow = true;
  scene.add(bldg);

  const edges = new THREE.EdgesGeometry(bldg.geometry);
  bldg.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff })));
}

function createLabel(text, x, y, z, scale = 1) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 512;
  canvas.height = 128;
  
  const gradient = ctx.createLinearGradient(0, 0, 512, 0);
  gradient.addColorStop(0, '#00ffff');
  gradient.addColorStop(0.5, '#ff00ff');
  gradient.addColorStop(1, '#00ff00');
  
  ctx.fillStyle = 'rgba(0,0,0,0.8)';
  ctx.fillRect(0, 0, 512, 128);
  ctx.font = 'Bold 48px Arial';
  ctx.fillStyle = gradient;
  ctx.textAlign = 'center';
  ctx.fillText(text, 256, 75);
  
  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.position.set(x, y, z);
  sprite.scale.set(25 * scale, 6.25 * scale, 1);
  scene.add(sprite);
}

function createNPCs() {
  const npcColors = [0x00ffff, 0xff00ff, 0x00ff00, 0xffff00, 0xff8800, 0x0088ff];
  for (let i = 0; i < 40; i++) {
    const x = (Math.random() - 0.5) * 400;
    const z = (Math.random() - 0.5) * 400;
    
    const npc = new THREE.Mesh(
      new THREE.CapsuleGeometry(1.2, 3.5, 8, 16),
      new THREE.MeshStandardMaterial({ 
        color: npcColors[i % npcColors.length],
        emissive: npcColors[i % npcColors.length],
        emissiveIntensity: 0.3,
        metalness: 0.5
      })
    );
    npc.position.set(x, 2.5, z);
    npc.castShadow = true;
    npc.userData = {
      type: 'npc',
      name: `Scientist ${i + 1}`,
      speed: 0.6 + Math.random() * 0.6,
      direction: Math.random() * Math.PI * 2,
      walkTime: 0
    };
    scene.add(npc);
    npcs.push(npc);

    // Glow
    const glow = new THREE.Mesh(
      new THREE.SphereGeometry(1.5, 16, 16),
      new THREE.MeshBasicMaterial({ color: npcColors[i % npcColors.length], transparent: true, opacity: 0.3 })
    );
    npc.add(glow);
  }
}

function createCars() {
  const carColors = [0x00ffff, 0xff00ff, 0x00ff00, 0xffff00, 0xff8800, 0x0088ff, 0xff0088, 0x88ff00];
  for (let i = 0; i < 30; i++) {
    const x = (Math.random() - 0.5) * 400;
    const y = 20 + Math.random() * 30;
    const z = (Math.random() - 0.5) * 400;
    
    const car = new THREE.Mesh(
      new THREE.BoxGeometry(5, 2.5, 8),
      new THREE.MeshStandardMaterial({ 
        color: carColors[i % carColors.length],
        emissive: carColors[i % carColors.length],
        emissiveIntensity: 0.6,
        metalness: 0.95,
        roughness: 0.1
      })
    );
    car.position.set(x, y, z);
    car.castShadow = true;
    car.userData = {
      speed: 1.5 + Math.random() * 2.5,
      direction: Math.random() * Math.PI * 2,
      height: y
    };
    scene.add(car);
    cars.push(car);

    // Glow trail
    const glow = new THREE.Mesh(
      new THREE.SphereGeometry(3, 16, 16),
      new THREE.MeshBasicMaterial({ color: carColors[i % carColors.length], transparent: true, opacity: 0.4 })
    );
    car.add(glow);
  }
}

function setupControls() {
  addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
    particleCanvas.width = innerWidth;
    particleCanvas.height = innerHeight;
  });

  addEventListener('keydown', e => {
    if (e.code === 'KeyW') moveF = true;
    if (e.code === 'KeyS') moveB = true;
    if (e.code === 'KeyA') moveL = true;
    if (e.code === 'KeyD') moveR = true;
    if (e.code === 'KeyE' && curInteract) interact();
  });

  addEventListener('keyup', e => {
    if (e.code === 'KeyW') moveF = false;
    if (e.code === 'KeyS') moveB = false;
    if (e.code === 'KeyA') moveL = false;
    if (e.code === 'KeyD') moveR = false;
  });

  addEventListener('mousemove', e => {
    if (document.pointerLockElement === document.body) {
      camera.rotation.y -= (e.movementX || 0) * 0.002;
      camera.rotation.x -= (e.movementY || 0) * 0.002;
      camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
    }
  });

  document.body.addEventListener('click', () => {
    if (!document.getElementById('charSelect').classList.contains('hide')) return;
    document.body.requestPointerLock();
  });
}

function animate() {
  requestAnimationFrame(animate);
  const delta = clock.getDelta();

  // Player movement
  vel.x -= vel.x * 10 * delta;
  vel.z -= vel.z * 10 * delta;
  dir.z = Number(moveF) - Number(moveB);
  dir.x = Number(moveR) - Number(moveL);
  dir.normalize();

  if (moveF || moveB) vel.z -= dir.z * 80 * delta;
  if (moveL || moveR) vel.x -= dir.x * 80 * delta;

  camera.position.x += vel.x * delta;
  camera.position.z += vel.z * delta;

  // NPCs walking
  npcs.forEach(npc => {
    npc.userData.walkTime += delta;
    if (npc.userData.walkTime > 5) {
      npc.userData.direction = Math.random() * Math.PI * 2;
      npc.userData.walkTime = 0;
    }
    
    const speed = npc.userData.speed;
    npc.position.x += Math.sin(npc.userData.direction) * speed * delta;
    npc.position.z += Math.cos(npc.userData.direction) * speed * delta;
    npc.position.x = Math.max(-200, Math.min(200, npc.position.x));
    npc.position.z = Math.max(-200, Math.min(200, npc.position.z));
    npc.rotation.y = npc.userData.direction;
    npc.position.y = 2.5 + Math.sin(Date.now() * 0.005 + npc.position.x) * 0.3;
  });

  // Flying cars
  cars.forEach(car => {
    const speed = car.userData.speed;
    car.position.x += Math.sin(car.userData.direction) * speed * delta;
    car.position.z += Math.cos(car.userData.direction) * speed * delta;
    
    if (car.position.x > 250) car.position.x = -250;
    if (car.position.x < -250) car.position.x = 250;
    if (car.position.z > 250) car.position.z = -250;
    if (car.position.z < -250) car.position.z = 250;
    
    car.position.y = car.userData.height + Math.sin(Date.now() * 0.002 + car.position.x) * 2;
    car.rotation.y = car.userData.direction;
    car.rotation.z = Math.sin(Date.now() * 0.003) * 0.15;
  });

  checkNearby();
  renderer.render(scene, camera);
}

function checkNearby() {
  let nearest = null, minDist = 25;
  
  scene.children.forEach(obj => {
    if (obj.userData.type === 'lab') {
      const dist = camera.position.distanceTo(obj.position);
      if (dist < minDist) { minDist = dist; nearest = obj; }
    }
  });
  
  npcs.forEach(npc => {
    const dist = camera.position.distanceTo(npc.position);
    if (dist < 12 && dist < minDist) { minDist = dist; nearest = npc; }
  });

  if (nearest && nearest !== curInteract) { curInteract = nearest; showInteract(); }
  else if (!nearest && curInteract) { curInteract = null; hideInteract(); }
}

function showInteract() {
  if (curInteract.userData.type === 'lab') {
    document.getElementById('intTitle').textContent = curInteract.userData.name;
    document.getElementById('intDesc').textContent = `Experience cutting-edge ${curInteract.userData.name.toLowerCase()} technology!`;
    
    const btns = document.getElementById('intBtns');
    btns.innerHTML = '';
    
    const btn = document.createElement('button');
    btn.className = 'actBtn';
    btn.textContent = 'EXPERIENCE TECHNOLOGY';
    btn.onclick = () => experienceTech(curInteract.userData.name);
    btns.appendChild(btn);
    
    document.getElementById('interact').classList.remove('hide');
  } else if (curInteract.userData.type === 'npc') {
    document.getElementById('intTitle').textContent = curInteract.userData.name;
    document.getElementById('intDesc').textContent = 'A brilliant scientist working on groundbreaking research!';
    
    const btns = document.getElementById('intBtns');
    btns.innerHTML = '';
    
    const btn = document.createElement('button');
    btn.className = 'actBtn';
    btn.textContent = 'COLLABORATE';
    btn.onclick = () => collaborate();
    btns.appendChild(btn);
    
    document.getElementById('interact').classList.remove('hide');
  }
}

function hideInteract() {
  document.getElementById('interact').classList.add('hide');
}

function interact() {
  if (curInteract.userData.type === 'lab') {
    experienceTech(curInteract.userData.name);
  } else if (curInteract.userData.type === 'npc') {
    collaborate();
  }
}

function experienceTech(labName) {
  state.techUsed++;
  state.rep += 150;
  state.fund += 120000;
  updateHUD();
  hideInteract();
  
  const experiences = {
    'QUANTUM LAB': {
      title: '‚öõÔ∏è QUANTUM COMPUTING EXPERIENCE',
      desc: 'You are now manipulating qubits in superposition! Watch as quantum states collapse and entangle. The Bloch sphere rotates as you apply quantum gates. Calculations that would take classical computers millions of years are solved instantly!'
    },
    'BIO LAB': {
      title: 'üß¨ GENE EDITING EXPERIENCE',
      desc: 'CRISPR-Cas9 system activated! You are now editing DNA sequences at the molecular level. Watch as base pairs are precisely cut and replaced. New genetic traits are being programmed into living cells in real-time!'
    },
    'AI LAB': {
      title: 'ü§ñ AI DEVELOPMENT EXPERIENCE',
      desc: 'Neural networks are training before your eyes! Watch as millions of artificial neurons fire and adjust their weights. The AI is learning patterns, making predictions, and evolving its intelligence in real-time!'
    },
    'NANO LAB': {
      title: 'üî¨ NANOTECHNOLOGY EXPERIENCE',
      desc: 'You are now controlling nanobots at the atomic scale! Watch as molecular machines assemble structures atom by atom. Carbon nanotubes are being woven, and smart materials are self-organizing!'
    },
    'FUSION LAB': {
      title: '‚ö° FUSION REACTOR EXPERIENCE',
      desc: 'Plasma is now confined at 100 million degrees! Watch as hydrogen atoms fuse into helium, releasing massive amounts of clean energy. The tokamak magnetic field is perfectly balanced. Unlimited power is being generated!'
    },
    'NEURAL LAB': {
      title: 'üß† NEURAL INTERFACE EXPERIENCE',
      desc: 'Your brain is now directly connected to the computer! Thoughts are being translated into digital commands. You can control devices with your mind. Neural signals are being read and written in real-time!'
    },
    'SPACE LAB': {
      title: 'üöÄ SPACE SYSTEMS EXPERIENCE',
      desc: 'You are now in orbital control! Watch as satellites maneuver in space, solar panels deploy, and life support systems maintain perfect conditions. The view of Earth from orbit is breathtaking!'
    },
    'HYBRID LAB': {
      title: 'üî• HYBRID TECHNOLOGY EXPERIENCE',
      desc: 'Multiple technologies are now combining! Quantum computing powers AI, which controls nanobots, guided by neural interfaces, powered by fusion energy! The ultimate technological convergence is happening!'
    }
  };
  
  const exp = experiences[labName] || experiences['HYBRID LAB'];
  
  document.getElementById('techExpTitle').textContent = exp.title;
  document.getElementById('techExpDesc').textContent = exp.desc;
  document.getElementById('techExperience').classList.remove('hide');
  
  notify(`‚ú® ${labName} activated! +150 Rep, +$120k!`);
}

window.exitTechExp = function() {
  document.getElementById('techExperience').classList.add('hide');
};

function collaborate() {
  state.rep += 100;
  state.fund += 80000;
  updateHUD();
  hideInteract();
  notify(`ü§ù Collaboration successful! +100 Rep, +$80k!`);
}

function updateHUD() {
  document.getElementById('role').textContent = state.char || '-';
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('rep').textContent = state.rep;
  document.getElementById('fund').textContent = '$' + (state.fund / 1000).toFixed(0) + 'K';
  document.getElementById('techUsed').textContent = state.techUsed;
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 4000);
}

let selChar = null;
document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selChar = card.dataset.char;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'START JOURNEY';
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!selChar) return;
  state.char = selChar;
  document.getElementById('charSelect').classList.add('hide');
  document.getElementById('loading').classList.remove('hide');
  
  const msgs = ['Creating beautiful sky...', 'Coloring the world...', 'Building labs...', 'Spawning NPCs...', 'Adding flying cars...', 'Ready!'];
  let i = 0;
  const interval = setInterval(() => {
    document.getElementById('loadText').textContent = msgs[i++];
    if (i >= msgs.length) {
      clearInterval(interval);
      document.getElementById('loading').classList.add('hide');
      document.getElementById('hud').classList.remove('hide');
      init();
    }
  }, 600);
});
</script>
</body>
</html>