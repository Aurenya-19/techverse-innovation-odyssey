<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse: Living Innovation City</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; color: #fff; }
#canvas { display: block; width: 100vw; height: 100vh; position: fixed; }

#charSelect { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #000428, #004e92); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; overflow-y: auto; padding: 20px; z-index: 10000; }
#charSelect h1 { font-size: clamp(2em, 4vw, 3.5em); color: #0ff; text-shadow: 0 0 30px #0ff; margin: 20px 0; animation: glow 2s infinite; }
@keyframes glow { 0%, 100% { text-shadow: 0 0 20px #0ff; } 50% { text-shadow: 0 0 50px #0ff; } }
.subtitle { font-size: clamp(0.9em, 1.5vw, 1.2em); color: #aaa; margin-bottom: 20px; text-align: center; }
.charGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-width: 1200px; width: 100%; padding: 10px; margin-bottom: 20px; }
.charCard { background: rgba(0, 255, 255, 0.15); border: 2px solid #0ff; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.3s; text-align: center; min-height: 160px; }
.charCard:hover { background: rgba(0, 255, 255, 0.3); transform: translateY(-5px); }
.charCard.selected { background: rgba(0, 255, 0, 0.3); border-color: #0f0; box-shadow: 0 0 40px rgba(0, 255, 0, 0.7); }
.charCard .icon { font-size: 2.5em; margin-bottom: 8px; }
.charCard h3 { color: #0ff; font-size: 1.1em; margin: 8px 0; }
.charCard p { color: #aaa; font-size: 0.8em; line-height: 1.3; }
#startBtn { padding: 15px 50px; font-size: clamp(1em, 2vw, 1.3em); background: linear-gradient(135deg, #0ff, #0f0); border: none; border-radius: 12px; color: #000; font-weight: bold; cursor: pointer; margin: 20px 0; text-transform: uppercase; }
#startBtn:hover:not(:disabled) { transform: scale(1.05); }
#startBtn:disabled { opacity: 0.3; cursor: not-allowed; }

#loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0, 0, 0, 0.95); padding: 40px; border-radius: 15px; border: 3px solid #0ff; z-index: 9999; }
#loading h2 { color: #0ff; font-size: 1.8em; margin-bottom: 15px; }
.spinner { border: 4px solid rgba(0, 255, 255, 0.3); border-top: 4px solid #0ff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 15px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

#hud { position: fixed; top: 15px; left: 15px; background: rgba(0, 0, 0, 0.9); padding: 18px; border-radius: 10px; border: 2px solid #0ff; min-width: 220px; z-index: 1000; }
#hud h3 { color: #0ff; font-size: 1.1em; margin-bottom: 10px; border-bottom: 2px solid #0ff; padding-bottom: 6px; }
.hudStat { display: flex; justify-content: space-between; margin: 6px 0; font-size: 0.9em; color: #aaa; }
.hudStat .val { color: #0f0; font-weight: bold; }

#interact { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.95); padding: 25px 35px; border-radius: 15px; border: 3px solid #0ff; max-width: 700px; width: 90%; text-align: center; z-index: 1000; }
#interact h4 { color: #0ff; font-size: 1.6em; margin-bottom: 12px; }
#interact p { color: #aaa; font-size: 1em; margin-bottom: 15px; line-height: 1.6; }
.actBtn { padding: 12px 28px; background: linear-gradient(135deg, #0ff, #08f); border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer; margin: 6px; font-size: 1em; text-transform: uppercase; }
.actBtn:hover { transform: scale(1.08); }

#npcDialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.95); padding: 30px; border-radius: 15px; border: 3px solid #0ff; max-width: 600px; width: 90%; z-index: 2000; }
#npcDialog h3 { color: #0ff; font-size: 1.5em; margin-bottom: 15px; }
#npcDialog p { color: #aaa; font-size: 1em; margin-bottom: 20px; line-height: 1.6; }
.dialogBtn { padding: 10px 25px; background: #0ff; border: none; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; margin: 5px; }

#minimap { position: fixed; bottom: 20px; right: 20px; width: 200px; height: 200px; background: rgba(0, 0, 0, 0.9); border: 2px solid #0ff; border-radius: 10px; z-index: 1000; }

#notif { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0, 255, 0, 0.95); color: #000; padding: 15px 35px; border-radius: 12px; font-weight: bold; font-size: 1.1em; opacity: 0; transition: opacity 0.3s; max-width: 85%; text-align: center; z-index: 2000; }
#notif.show { opacity: 1; }

.hide { display: none !important; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="charSelect">
  <h1>üöÄ TechVerse: Living Innovation City</h1>
  <p class="subtitle">Enter a living cyberpunk city with NPCs, labs, and flying cars</p>
  <div class="charGrid">
    <div class="charCard" data-char="netrunner"><div class="icon">üíª</div><h3>Netrunner</h3><p>Hacker & VR specialist</p></div>
    <div class="charCard" data-char="bioengineer"><div class="icon">üß¨</div><h3>Bioengineer</h3><p>Gene editing expert</p></div>
    <div class="charCard" data-char="quantum"><div class="icon">‚öõÔ∏è</div><h3>Quantum Physicist</h3><p>Reality manipulator</p></div>
    <div class="charCard" data-char="neurohacker"><div class="icon">üß†</div><h3>Neurohacker</h3><p>Mind engineer</p></div>
    <div class="charCard" data-char="nanoengineer"><div class="icon">üî¨</div><h3>Nanoengineer</h3><p>Atomic builder</p></div>
    <div class="charCard" data-char="aiarchitect"><div class="icon">ü§ñ</div><h3>AI Architect</h3><p>AI creator</p></div>
    <div class="charCard" data-char="spacesystems"><div class="icon">üöÄ</div><h3>Space Engineer</h3><p>Orbital specialist</p></div>
    <div class="charCard" data-char="fusionengineer"><div class="icon">‚ö°</div><h3>Fusion Engineer</h3><p>Energy pioneer</p></div>
  </div>
  <button id="startBtn" disabled>Select Character</button>
</div>

<div id="loading" class="hide">
  <h2>Building Living City...</h2>
  <div class="spinner"></div>
  <p id="loadText">Generating roads...</p>
</div>

<div id="hud" class="hide">
  <h3>‚ö° STATUS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>Rep:</span><span class="val" id="rep">0</span></div>
  <div class="hudStat"><span>Fund:</span><span class="val" id="fund">$300K</span></div>
  <div class="hudStat"><span>Collabs:</span><span class="val" id="collabs">0</span></div>
</div>

<div id="interact" class="hide">
  <h4 id="intTitle">Location</h4>
  <p id="intDesc">Description</p>
  <div id="intBtns"></div>
</div>

<div id="npcDialog" class="hide">
  <h3 id="npcName">NPC</h3>
  <p id="npcText">Dialog</p>
  <button class="dialogBtn" onclick="window.collaborate()">Collaborate</button>
  <button class="dialogBtn" onclick="window.closeDialog()">Leave</button>
</div>

<canvas id="minimap"></canvas>

<div id="notif"></div>

<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"}}</script>
<script type="module">
import * as THREE from 'three';

const state = { char: null, lvl: 1, xp: 0, xpMax: 100, rep: 0, fund: 300000, collabs: 0, currentNPC: null };

const labs = {
  quantum: { name: 'Quantum Lab', pos: [-80, 0, -100], desc: 'Research quantum computing and entanglement', color: 0xff00ff },
  bio: { name: 'Bio Lab', pos: [80, 0, -100], desc: 'Gene editing and synthetic biology', color: 0x00ff88 },
  ai: { name: 'AI Lab', pos: [-80, 0, 100], desc: 'Develop artificial intelligence', color: 0xff0088 },
  nano: { name: 'Nano Lab', pos: [80, 0, 100], desc: 'Molecular fabrication', color: 0xff8800 },
  fusion: { name: 'Fusion Lab', pos: [-120, 0, 0], desc: 'Clean energy research', color: 0xff4400 },
  neural: { name: 'Neural Lab', pos: [120, 0, 0], desc: 'Brain-computer interfaces', color: 0x00ff00 },
  space: { name: 'Space Lab', pos: [0, 0, -120], desc: 'Orbital systems', color: 0x4400ff },
  hybrid: { name: 'HYBRID LAB', pos: [0, 0, 0], desc: 'Combine technologies to create new innovations!', color: 0x00ffff }
};

const npcNames = ['Dr. Chen', 'Prof. Nakamura', 'Dr. Rodriguez', 'Dr. Kim', 'Prof. Patel', 'Dr. Johnson', 'Dr. Silva', 'Prof. Anderson', 'Dr. Zhang', 'Dr. Williams'];
const npcDialogs = [
  "I'm working on quantum entanglement. Want to collaborate?",
  "My neural interface project needs a partner. Interested?",
  "I'm developing a new AI algorithm. Let's work together!",
  "Gene editing breakthrough! Need help testing it.",
  "Fusion reactor optimization - could use your expertise!",
  "Nanobot swarm control system. Want to join?",
  "Space habitat design. Let's collaborate!",
  "Hybrid tech project - combining quantum and AI!"
];

let scene, camera, renderer, npcs = [], cars = [], curInteract = null;
let moveF = false, moveB = false, moveL = false, moveR = false;
const vel = new THREE.Vector3(), dir = new THREE.Vector3(), clock = new THREE.Clock();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000510);
  scene.fog = new THREE.Fog(0x000510, 50, 600);

  camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  camera.position.set(0, 5, 30);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;

  // Lights
  scene.add(new THREE.AmbientLight(0x404060, 0.9));
  const sun = new THREE.DirectionalLight(0xffffff, 1.6);
  sun.position.set(100, 200, 100);
  sun.castShadow = true;
  scene.add(sun);

  // City lights
  for (let i = 0; i < 20; i++) {
    const x = (Math.random() - 0.5) * 300;
    const z = (Math.random() - 0.5) * 300;
    const colors = [0x00ffff, 0xff00ff, 0x00ff00, 0xff8800, 0x0088ff];
    addLight(x, 15, z, colors[i % colors.length], 2.5);
  }

  createCity();
  createNPCs();
  createCars();
  setupControls();
  animate();
  updateHUD();

  notify('Welcome to the Living City! Explore labs, talk to NPCs, watch flying cars!');
  setTimeout(() => notify('Press E near NPCs to collaborate!'), 4000);
}

function addLight(x, y, z, color, intensity) {
  const light = new THREE.PointLight(color, intensity, 100);
  light.position.set(x, y, z);
  scene.add(light);
}

function createCity() {
  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(800, 800),
    new THREE.MeshStandardMaterial({ color: 0x0a0a1e, roughness: 0.8 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);

  // Roads - Grid pattern
  for (let i = -200; i <= 200; i += 40) {
    createRoad(i, 0, 0, 800, 8, 0x1a1a2e); // Vertical roads
    createRoad(0, 0, i, 8, 800, 0x1a1a2e); // Horizontal roads
  }

  // Road lines
  const grid = new THREE.GridHelper(800, 160, 0x00ffff, 0x003344);
  scene.add(grid);

  // LABS - Major buildings
  Object.entries(labs).forEach(([id, lab]) => {
    const [x, y, z] = lab.pos;
    const isHybrid = id === 'hybrid';
    const size = isHybrid ? 40 : 30;
    const height = isHybrid ? 60 : 50;
    
    createLab(x, y, z, size, height, size, lab.color, lab.name, isHybrid);
  });

  // City buildings - Procedural
  for (let i = 0; i < 50; i++) {
    const x = (Math.random() - 0.5) * 350;
    const z = (Math.random() - 0.5) * 350;
    const w = 10 + Math.random() * 15;
    const h = 20 + Math.random() * 40;
    const d = 10 + Math.random() * 15;
    const color = [0x16213e, 0x1a1a2e, 0x0f3460, 0x2e1a1a, 0x1a1a3e][Math.floor(Math.random() * 5)];
    
    createBuilding(x, 0, z, w, h, d, color);
  }

  // Stars
  const stars = new THREE.BufferGeometry();
  const verts = [];
  for (let i = 0; i < 40000; i++) {
    verts.push((Math.random() - 0.5) * 8000, Math.random() * 4000, (Math.random() - 0.5) * 8000);
  }
  stars.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
  scene.add(new THREE.Points(stars, new THREE.PointsMaterial({ color: 0xffffff, size: 1.2 })));
}

function createRoad(x, y, z, w, d, color) {
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(w, d),
    new THREE.MeshStandardMaterial({ color, roughness: 0.9 })
  );
  road.rotation.x = -Math.PI / 2;
  road.position.set(x, y + 0.1, z);
  scene.add(road);
}

function createLab(x, y, z, w, h, d, color, label, isHybrid) {
  const bldg = new THREE.Mesh(
    new THREE.BoxGeometry(w, h, d),
    new THREE.MeshStandardMaterial({
      color,
      roughness: 0.3,
      metalness: 0.7,
      emissive: color,
      emissiveIntensity: isHybrid ? 0.5 : 0.35
    })
  );
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  bldg.receiveShadow = true;
  bldg.userData = { type: 'lab', name: label, desc: labs[Object.keys(labs).find(k => labs[k].name === label)].desc };
  scene.add(bldg);

  // Neon edges
  const edges = new THREE.EdgesGeometry(bldg.geometry);
  bldg.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: isHybrid ? 0xffffff : color })));

  // Windows
  for (let i = 0; i < 8; i++) {
    const window = new THREE.Mesh(
      new THREE.PlaneGeometry(w * 0.7, h / 10),
      new THREE.MeshBasicMaterial({ color: 0xffff00, transparent: true, opacity: 0.7 })
    );
    window.position.set(0, -h / 2 + (i + 1) * (h / 9), d / 2 + 0.1);
    bldg.add(window);
  }

  // Entrance marker
  const entrance = new THREE.Mesh(
    new THREE.BoxGeometry(5, 8, 1),
    new THREE.MeshBasicMaterial({ color: 0x00ff00 })
  );
  entrance.position.set(0, 4, d / 2 + 0.5);
  bldg.add(entrance);

  createLbl(label, x, h + 8, z, isHybrid ? 2 : 1.5);
}

function createBuilding(x, y, z, w, h, d, color) {
  const bldg = new THREE.Mesh(
    new THREE.BoxGeometry(w, h, d),
    new THREE.MeshStandardMaterial({ color, roughness: 0.5, metalness: 0.5, emissive: 0x00ffff, emissiveIntensity: 0.2 })
  );
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  scene.add(bldg);

  const edges = new THREE.EdgesGeometry(bldg.geometry);
  bldg.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ffff })));
}

function createLbl(text, x, y, z, scale = 1) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 512;
  canvas.height = 128;
  ctx.fillStyle = 'rgba(0,0,0,0.85)';
  ctx.fillRect(0, 0, 512, 128);
  ctx.font = 'Bold 44px Arial';
  ctx.fillStyle = '#00ffff';
  ctx.textAlign = 'center';
  ctx.fillText(text, 256, 70);
  
  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.position.set(x, y, z);
  sprite.scale.set(20 * scale, 5 * scale, 1);
  scene.add(sprite);
}

function createNPCs() {
  // Create 30 NPCs walking around
  for (let i = 0; i < 30; i++) {
    const x = (Math.random() - 0.5) * 300;
    const z = (Math.random() - 0.5) * 300;
    
    const npc = new THREE.Mesh(
      new THREE.CapsuleGeometry(1, 3, 8, 16),
      new THREE.MeshStandardMaterial({ color: [0x00ffff, 0xff00ff, 0x00ff00, 0xffff00][i % 4] })
    );
    npc.position.set(x, 2, z);
    npc.castShadow = true;
    npc.userData = {
      type: 'npc',
      name: npcNames[i % npcNames.length],
      dialog: npcDialogs[i % npcDialogs.length],
      speed: 0.5 + Math.random() * 0.5,
      direction: Math.random() * Math.PI * 2,
      walkTime: 0
    };
    scene.add(npc);
    npcs.push(npc);

    // Name label
    createLbl(npc.userData.name, x, 6, z, 0.5);
  }
}

function createCars() {
  // Create 20 flying cars
  for (let i = 0; i < 20; i++) {
    const x = (Math.random() - 0.5) * 300;
    const y = 15 + Math.random() * 20;
    const z = (Math.random() - 0.5) * 300;
    
    const car = new THREE.Mesh(
      new THREE.BoxGeometry(4, 2, 6),
      new THREE.MeshStandardMaterial({ 
        color: [0x00ffff, 0xff00ff, 0x00ff00, 0xff8800, 0x0088ff][i % 5],
        emissive: [0x00ffff, 0xff00ff, 0x00ff00, 0xff8800, 0x0088ff][i % 5],
        emissiveIntensity: 0.5,
        metalness: 0.9
      })
    );
    car.position.set(x, y, z);
    car.userData = {
      speed: 1 + Math.random() * 2,
      direction: Math.random() * Math.PI * 2,
      height: y
    };
    scene.add(car);
    cars.push(car);

    // Glow
    const glow = new THREE.Mesh(
      new THREE.SphereGeometry(2, 16, 16),
      new THREE.MeshBasicMaterial({ color: car.material.color, transparent: true, opacity: 0.3 })
    );
    car.add(glow);
  }
}

function setupControls() {
  addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  addEventListener('keydown', e => {
    if (e.code === 'KeyW') moveF = true;
    if (e.code === 'KeyS') moveB = true;
    if (e.code === 'KeyA') moveL = true;
    if (e.code === 'KeyD') moveR = true;
    if (e.code === 'KeyE' && curInteract) interact();
  });

  addEventListener('keyup', e => {
    if (e.code === 'KeyW') moveF = false;
    if (e.code === 'KeyS') moveB = false;
    if (e.code === 'KeyA') moveL = false;
    if (e.code === 'KeyD') moveR = false;
  });

  addEventListener('mousemove', e => {
    if (document.pointerLockElement === document.body) {
      camera.rotation.y -= (e.movementX || 0) * 0.002;
      camera.rotation.x -= (e.movementY || 0) * 0.002;
      camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
    }
  });

  document.body.addEventListener('click', () => {
    if (!document.getElementById('charSelect').classList.contains('hide')) return;
    document.body.requestPointerLock();
  });
}

function animate() {
  requestAnimationFrame(animate);
  const delta = clock.getDelta();

  // Player movement
  vel.x -= vel.x * 10 * delta;
  vel.z -= vel.z * 10 * delta;
  dir.z = Number(moveF) - Number(moveB);
  dir.x = Number(moveR) - Number(moveL);
  dir.normalize();

  if (moveF || moveB) vel.z -= dir.z * 70 * delta;
  if (moveL || moveR) vel.x -= dir.x * 70 * delta;

  camera.position.x += vel.x * delta;
  camera.position.z += vel.z * delta;

  // NPCs walking
  npcs.forEach(npc => {
    npc.userData.walkTime += delta;
    
    if (npc.userData.walkTime > 5) {
      npc.userData.direction = Math.random() * Math.PI * 2;
      npc.userData.walkTime = 0;
    }
    
    const speed = npc.userData.speed;
    npc.position.x += Math.sin(npc.userData.direction) * speed * delta;
    npc.position.z += Math.cos(npc.userData.direction) * speed * delta;
    
    // Keep in bounds
    npc.position.x = Math.max(-150, Math.min(150, npc.position.x));
    npc.position.z = Math.max(-150, Math.min(150, npc.position.z));
    
    // Animate
    npc.rotation.y = npc.userData.direction;
    npc.position.y = 2 + Math.sin(Date.now() * 0.005 + npc.position.x) * 0.2;
  });

  // Flying cars
  cars.forEach(car => {
    const speed = car.userData.speed;
    car.position.x += Math.sin(car.userData.direction) * speed * delta;
    car.position.z += Math.cos(car.userData.direction) * speed * delta;
    
    // Wrap around
    if (car.position.x > 200) car.position.x = -200;
    if (car.position.x < -200) car.position.x = 200;
    if (car.position.z > 200) car.position.z = -200;
    if (car.position.z < -200) car.position.z = 200;
    
    // Hover animation
    car.position.y = car.userData.height + Math.sin(Date.now() * 0.002 + car.position.x) * 1;
    car.rotation.y = car.userData.direction;
    car.rotation.z = Math.sin(Date.now() * 0.003) * 0.1;
  });

  checkNearby();
  renderer.render(scene, camera);
}

function checkNearby() {
  let nearest = null, minDist = 20;
  
  // Check labs
  scene.children.forEach(obj => {
    if (obj.userData.type === 'lab') {
      const dist = camera.position.distanceTo(obj.position);
      if (dist < minDist) { minDist = dist; nearest = obj; }
    }
  });
  
  // Check NPCs
  npcs.forEach(npc => {
    const dist = camera.position.distanceTo(npc.position);
    if (dist < 10 && dist < minDist) { minDist = dist; nearest = npc; }
  });

  if (nearest && nearest !== curInteract) { curInteract = nearest; showInteract(); }
  else if (!nearest && curInteract) { curInteract = null; hideInteract(); }
}

function showInteract() {
  if (curInteract.userData.type === 'lab') {
    document.getElementById('intTitle').textContent = curInteract.userData.name;
    document.getElementById('intDesc').textContent = curInteract.userData.desc;
    
    const btns = document.getElementById('intBtns');
    btns.innerHTML = '';
    
    const enterBtn = document.createElement('button');
    enterBtn.className = 'actBtn';
    enterBtn.textContent = 'ENTER LAB';
    enterBtn.onclick = () => enterLab(curInteract.userData.name);
    btns.appendChild(enterBtn);
    
    document.getElementById('interact').classList.remove('hide');
  } else if (curInteract.userData.type === 'npc') {
    state.currentNPC = curInteract.userData;
    document.getElementById('npcName').textContent = curInteract.userData.name;
    document.getElementById('npcText').textContent = curInteract.userData.dialog;
    document.getElementById('npcDialog').classList.remove('hide');
  }
}

function hideInteract() {
  document.getElementById('interact').classList.add('hide');
}

function interact() {
  if (curInteract.userData.type === 'lab') {
    enterLab(curInteract.userData.name);
  }
}

function enterLab(labName) {
  if (labName === 'HYBRID LAB') {
    state.rep += 200;
    state.fund += 150000;
    notify('üî¨ HYBRID LAB! Combining technologies! +200 Rep, +$150k!');
  } else {
    state.rep += 100;
    state.fund += 80000;
    notify(`üî¨ Entered ${labName}! Research in progress! +100 Rep, +$80k!`);
  }
  updateHUD();
  hideInteract();
}

window.collaborate = function() {
  if (state.currentNPC) {
    state.collabs++;
    state.rep += 150;
    state.fund += 100000;
    notify(`ü§ù Collaborated with ${state.currentNPC.name}! +150 Rep, +$100k!`);
    updateHUD();
    window.closeDialog();
  }
};

window.closeDialog = function() {
  document.getElementById('npcDialog').classList.add('hide');
  state.currentNPC = null;
};

function updateHUD() {
  document.getElementById('role').textContent = state.char || '-';
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('rep').textContent = state.rep;
  document.getElementById('fund').textContent = '$' + (state.fund / 1000).toFixed(0) + 'K';
  document.getElementById('collabs').textContent = state.collabs;
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 3500);
}

let selChar = null;
document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selChar = card.dataset.char;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'START JOURNEY';
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!selChar) return;
  state.char = selChar;
  document.getElementById('charSelect').classList.add('hide');
  document.getElementById('loading').classList.remove('hide');
  
  const msgs = ['Generating roads...', 'Building labs...', 'Spawning NPCs...', 'Adding flying cars...', 'Ready!'];
  let i = 0;
  const interval = setInterval(() => {
    document.getElementById('loadText').textContent = msgs[i++];
    if (i >= msgs.length) {
      clearInterval(interval);
      document.getElementById('loading').classList.add('hide');
      document.getElementById('hud').classList.remove('hide');
      init();
    }
  }, 600);
});
</script>
</body>
</html>