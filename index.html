<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse: AI-Powered Collaboration Platform</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; overflow: hidden; background: #1a1a1a; color: #e0e0e0; }
#canvas { display: block; width: 100vw; height: 100vh; }

#charSelect { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; overflow-y: auto; padding: 20px; z-index: 10000; }
#charSelect h1 { font-size: clamp(2em, 4vw, 3em); color: #ecf0f1; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 20px 0; font-weight: 600; }
.subtitle { font-size: clamp(0.9em, 1.5vw, 1.1em); color: #bdc3c7; margin-bottom: 20px; text-align: center; }
.charGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-width: 1200px; width: 100%; padding: 10px; margin-bottom: 20px; }
.charCard { background: rgba(52, 73, 94, 0.8); border: 2px solid #7f8c8d; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s; text-align: center; min-height: 160px; }
.charCard:hover { background: rgba(52, 73, 94, 1); transform: translateY(-3px); }
.charCard.selected { background: rgba(46, 204, 113, 0.3); border-color: #27ae60; }
.charCard .icon { font-size: 2.5em; margin-bottom: 8px; }
.charCard h3 { color: #ecf0f1; font-size: 1.1em; margin: 8px 0; }
.charCard p { color: #95a5a6; font-size: 0.8em; line-height: 1.3; }
#startBtn { padding: 15px 50px; font-size: clamp(1em, 2vw, 1.3em); background: linear-gradient(135deg, #27ae60, #229954); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; margin: 20px 0; text-transform: uppercase; }
#startBtn:hover:not(:disabled) { transform: translateY(-2px); }
#startBtn:disabled { opacity: 0.4; cursor: not-allowed; }

#loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(44, 62, 80, 0.95); padding: 40px; border-radius: 10px; border: 2px solid #7f8c8d; z-index: 9999; }
.spinner { border: 4px solid rgba(127, 140, 141, 0.3); border-top: 4px solid #7f8c8d; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 15px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

#hud { position: fixed; top: 15px; left: 15px; background: rgba(44, 62, 80, 0.95); padding: 20px; border-radius: 8px; border: 2px solid #7f8c8d; min-width: 240px; z-index: 1000; }
#hud h3 { color: #ecf0f1; font-size: 1.2em; margin-bottom: 12px; border-bottom: 2px solid #7f8c8d; padding-bottom: 8px; }
.hudStat { display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.95em; color: #bdc3c7; }
.hudStat .val { color: #27ae60; font-weight: 700; }

#aiAssistant { position: fixed; top: 15px; right: 15px; width: 350px; background: rgba(44, 62, 80, 0.98); border-radius: 12px; border: 3px solid #9b59b6; z-index: 1000; box-shadow: 0 8px 32px rgba(155, 89, 182, 0.4); }
#aiHeader { background: linear-gradient(135deg, #9b59b6, #8e44ad); padding: 15px; border-radius: 9px 9px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
#aiHeader h3 { color: #fff; font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
#aiToggle { background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; }
#aiBody { max-height: 500px; overflow-y: auto; padding: 15px; display: none; }
#aiBody.open { display: block; }
#aiChat { margin-bottom: 15px; max-height: 350px; overflow-y: auto; }
.aiMsg { margin: 10px 0; padding: 12px; border-radius: 8px; line-height: 1.6; }
.aiMsg.ai { background: rgba(155, 89, 182, 0.2); border-left: 3px solid #9b59b6; }
.aiMsg.user { background: rgba(52, 152, 219, 0.2); border-left: 3px solid #3498db; text-align: right; }
.aiMsg strong { color: #9b59b6; }
#aiInputArea { display: flex; gap: 8px; }
#aiInput { flex: 1; padding: 10px; background: rgba(52, 73, 94, 0.6); border: 2px solid #7f8c8d; border-radius: 6px; color: #ecf0f1; font-size: 0.95em; }
#aiSend { padding: 10px 20px; background: linear-gradient(135deg, #9b59b6, #8e44ad); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; }
#aiSend:hover { transform: translateY(-2px); }

#interact { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.98); padding: 30px 40px; border-radius: 10px; border: 2px solid #3498db; max-width: 750px; width: 90%; text-align: center; z-index: 1000; }
#interact h4 { color: #3498db; font-size: 1.8em; margin-bottom: 15px; }
#interact p { color: #bdc3c7; font-size: 1.05em; margin-bottom: 20px; line-height: 1.7; }
.actBtn { padding: 14px 30px; background: linear-gradient(135deg, #3498db, #2980b9); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; margin: 8px; font-size: 1em; transition: all 0.3s; }
.actBtn:hover { transform: translateY(-2px); }

#collaboration { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.95); z-index: 5000; overflow-y: auto; padding: 20px; }
#collabContent { max-width: 1400px; margin: 0 auto; background: rgba(44, 62, 80, 0.98); padding: 30px; border-radius: 12px; border: 3px solid #27ae60; }
#collabContent h2 { color: #27ae60; font-size: 2em; margin-bottom: 20px; text-align: center; }
#collabInfo { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.collabPanel { background: rgba(52, 73, 94, 0.6); padding: 20px; border-radius: 8px; border: 2px solid #7f8c8d; }
.collabPanel h3 { color: #3498db; margin-bottom: 15px; font-size: 1.3em; }
.collabPanel p { color: #ecf0f1; line-height: 1.7; margin: 8px 0; }
.expertTag { display: inline-block; background: rgba(155, 89, 182, 0.3); padding: 4px 12px; border-radius: 15px; margin: 4px; font-size: 0.85em; color: #9b59b6; border: 1px solid #9b59b6; }
#projectArea { background: rgba(26, 26, 26, 0.8); padding: 25px; border-radius: 10px; margin: 20px 0; border: 2px solid #27ae60; }
#projectArea h3 { color: #27ae60; margin-bottom: 15px; }
.taskItem { background: rgba(52, 73, 94, 0.6); padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3498db; display: flex; justify-content: space-between; align-items: center; }
.taskItem.completed { border-left-color: #27ae60; opacity: 0.7; }
.taskItem h4 { color: #ecf0f1; margin-bottom: 5px; }
.taskItem p { color: #95a5a6; font-size: 0.9em; }
.taskBtn { padding: 8px 20px; background: linear-gradient(135deg, #3498db, #2980b9); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; font-size: 0.9em; }
.taskBtn:hover { transform: translateY(-2px); }
.taskBtn.complete { background: linear-gradient(135deg, #27ae60, #229954); }
#codeEditor { background: #1e1e1e; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; color: #d4d4d4; font-size: 0.95em; line-height: 1.6; margin: 15px 0; border: 2px solid #3498db; min-height: 200px; }
.codeLine { margin: 5px 0; }
.keyword { color: #569cd6; }
.string { color: #ce9178; }
.comment { color: #6a9955; }
.function { color: #dcdcaa; }
#collabChat { background: rgba(52, 73, 94, 0.6); padding: 20px; border-radius: 8px; max-height: 300px; overflow-y: auto; margin: 20px 0; }
.collabMsg { margin: 10px 0; padding: 10px; border-radius: 6px; }
.collabMsg.npc { background: rgba(155, 89, 182, 0.2); border-left: 3px solid #9b59b6; }
.collabMsg.you { background: rgba(52, 152, 219, 0.2); border-left: 3px solid #3498db; }
.collabMsg strong { color: #3498db; }
.collabBtn { padding: 12px 30px; background: linear-gradient(135deg, #27ae60, #229954); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; margin: 10px 5px; font-size: 1em; }
.collabBtn:hover { transform: translateY(-2px); }
.collabBtn.secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

#controls { position: fixed; bottom: 30px; left: 30px; background: rgba(44, 62, 80, 0.95); padding: 18px; border-radius: 8px; border: 2px solid #7f8c8d; z-index: 1000; }
#controls h4 { color: #ecf0f1; margin-bottom: 10px; font-size: 1.05em; }
.ctrl { color: #bdc3c7; margin: 6px 0; font-size: 0.9em; }
.key { color: #27ae60; font-weight: 700; background: rgba(39, 174, 96, 0.2); padding: 3px 8px; border-radius: 4px; }

#notif { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background: rgba(39, 174, 96, 0.95); color: #fff; padding: 16px 40px; border-radius: 8px; font-weight: 600; font-size: 1.1em; opacity: 0; transition: opacity 0.3s; max-width: 85%; text-align: center; z-index: 2000; }
#notif.show { opacity: 1; }

.hide { display: none !important; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
::-webkit-scrollbar-thumb { background: #7f8c8d; border-radius: 4px; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="charSelect">
  <h1>TechVerse: AI-Powered Collaboration</h1>
  <p class="subtitle">Work on real projects with AI experts and smart collaborators</p>
  <div class="charGrid">
    <div class="charCard" data-char="Developer"><div class="icon">üíª</div><h3>Developer</h3><p>Code & build systems</p></div>
    <div class="charCard" data-char="Researcher"><div class="icon">üî¨</div><h3>Researcher</h3><p>Explore & discover</p></div>
    <div class="charCard" data-char="Engineer"><div class="icon">‚öôÔ∏è</div><h3>Engineer</h3><p>Design & create</p></div>
    <div class="charCard" data-char="Scientist"><div class="icon">üß™</div><h3>Scientist</h3><p>Experiment & innovate</p></div>
  </div>
  <button id="startBtn" disabled>Select Role</button>
</div>

<div id="loading" class="hide">
  <h2>Loading Platform...</h2>
  <div class="spinner"></div>
  <p id="loadText">Initializing AI...</p>
</div>

<div id="hud" class="hide">
  <h3>PROGRESS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>Projects:</span><span class="val" id="projects">0/10</span></div>
  <div class="hudStat"><span>Collabs:</span><span class="val" id="collabs">0</span></div>
  <div class="hudStat"><span>Rep:</span><span class="val" id="rep">0</span></div>
</div>

<div id="aiAssistant">
  <div id="aiHeader" onclick="toggleAI()">
    <h3>ü§ñ AI Assistant</h3>
    <button id="aiToggle">‚ñº</button>
  </div>
  <div id="aiBody">
    <div id="aiChat">
      <div class="aiMsg ai">
        <strong>AI:</strong> Hi! I'm your AI assistant. Ask me anything about technology - quantum computing, AI, circuits, DNA, or any tech topic!
      </div>
    </div>
    <div id="aiInputArea">
      <input type="text" id="aiInput" placeholder="Ask about any technology..." onkeypress="if(event.key==='Enter') askAI()">
      <button id="aiSend" onclick="askAI()">Send</button>
    </div>
  </div>
</div>

<div id="interact" class="hide">
  <h4 id="intTitle">Location</h4>
  <p id="intDesc">Description</p>
  <div id="intBtns"></div>
</div>

<div id="collaboration" class="hide">
  <div id="collabContent"></div>
</div>

<div id="controls" class="hide">
  <h4>CONTROLS</h4>
  <div class="ctrl"><span class="key">WASD</span> Move</div>
  <div class="ctrl"><span class="key">MOUSE</span> Look</div>
  <div class="ctrl"><span class="key">E</span> Interact</div>
  <div class="ctrl"><span class="key">T</span> Toggle AI</div>
</div>

<div id="notif"></div>

<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"}}</script>
<script type="module">
import * as THREE from 'three';

const state = {
  char: null,
  lvl: 1,
  projectsCompleted: 0,
  collabs: 0,
  rep: 0,
  currentCollab: null,
  aiOpen: false
};

const aiKnowledge = {
  quantum: "Quantum computing uses qubits that can be in superposition (0 AND 1 simultaneously). Key concepts: Superposition allows parallel processing, Entanglement creates correlated qubits, Quantum gates (Hadamard, CNOT) manipulate states. Applications: cryptography, optimization, drug discovery. Example: Shor's algorithm can factor large numbers exponentially faster than classical computers.",
  
  ai: "Neural networks mimic brain structure with layers of neurons. Training process: 1) Forward pass - data flows through network, 2) Loss calculation - measure error, 3) Backpropagation - calculate gradients, 4) Weight update - adjust using optimizer (Adam, SGD). Key architectures: CNN for images, RNN for sequences, Transformers for language. Deep learning requires large datasets and GPU computing.",
  
  circuit: "Electronic circuits follow Ohm's Law: V=I√óR. Components: Resistors limit current (measured in Ohms), Capacitors store charge, LEDs emit light (need current-limiting resistor), Transistors act as switches. Series circuits: same current, voltages add. Parallel circuits: same voltage, currents add. Always calculate power: P=V√óI to avoid overheating.",
  
  dna: "DNA is double helix with base pairs: A-T and G-C. CRISPR-Cas9 gene editing: 1) Guide RNA designed for target sequence, 2) Cas9 enzyme cuts DNA at precise location, 3) Cell repairs cut, allowing insertion/deletion. Applications: cure genetic diseases (sickle cell), improve crops, create disease models. Ethical considerations: germline editing affects future generations.",
  
  neural: "Brain-computer interfaces read neural signals using electrodes. Signal processing: 1) Record electrical activity, 2) Filter noise, 3) Extract features, 4) Decode intent using ML. Applications: control prosthetics, restore communication for paralyzed patients, enhance cognition. Challenges: signal quality, biocompatibility, long-term stability.",
  
  nano: "Nanotechnology manipulates matter at 1-100nm scale. Techniques: Electron microscopy for imaging, Atomic force microscopy for manipulation, Self-assembly for fabrication. Applications: Drug delivery (target specific cells), Materials (carbon nanotubes stronger than steel), Electronics (quantum dots for displays). Bottom-up vs top-down approaches.",
  
  fusion: "Nuclear fusion combines light atoms (hydrogen) to release energy. Requirements: Temperature >100 million¬∞C, Pressure to overcome electrostatic repulsion, Confinement (magnetic or inertial). Tokamak design: toroidal magnetic field confines plasma. Challenges: achieving net energy gain (Q>1), materials that withstand neutron bombardment, tritium breeding.",
  
  space: "Spacecraft design considers: Propulsion (chemical, ion, nuclear), Life support (oxygen, water recycling), Radiation shielding, Thermal control. Orbital mechanics: Hohmann transfer for efficiency, Gravity assists for deep space. Mars mission challenges: 6-9 month transit, entry/descent/landing, in-situ resource utilization (ISRU)."
};

const collaborators = {
  'Dr. Sarah Chen': {
    expertise: ['Quantum Computing', 'Cryptography', 'Algorithm Design'],
    personality: 'analytical and precise',
    greeting: "Hello! I specialize in quantum algorithms. Let's work on optimizing quantum circuits together.",
    projects: ['quantum-optimization', 'quantum-crypto']
  },
  'Prof. James Rodriguez': {
    expertise: ['Neural Networks', 'Deep Learning', 'Computer Vision'],
    personality: 'enthusiastic and creative',
    greeting: "Hey! I love building AI systems. Want to train a neural network together?",
    projects: ['image-classifier', 'nlp-model']
  },
  'Dr. Emily Patel': {
    expertise: ['CRISPR', 'Gene Therapy', 'Synthetic Biology'],
    personality: 'careful and methodical',
    greeting: "Hi! Gene editing requires precision. Let's design a CRISPR experiment carefully.",
    projects: ['gene-knockout', 'protein-engineering']
  },
  'Dr. Michael Kim': {
    expertise: ['Circuit Design', 'Embedded Systems', 'IoT'],
    personality: 'practical and hands-on',
    greeting: "What's up! Let's build something cool. I'll help you design the circuit.",
    projects: ['iot-sensor', 'robot-controller']
  }
};

const projects = {
  'quantum-optimization': {
    title: 'Quantum Optimization Algorithm',
    description: 'Build a quantum circuit to solve optimization problems using QAOA',
    collaborator: 'Dr. Sarah Chen',
    tasks: [
      { id: 1, title: 'Design Problem Hamiltonian', desc: 'Define the cost function for optimization', code: 'def hamiltonian(x):\n    return sum(x[i] * x[i+1] for i in range(len(x)-1))' },
      { id: 2, title: 'Create Mixer Hamiltonian', desc: 'Apply X gates for quantum mixing', code: 'circuit.h(qubits)  # Hadamard for superposition\ncircuit.rx(theta, qubits)  # Rotation for mixing' },
      { id: 3, title: 'Implement QAOA Layers', desc: 'Alternate between problem and mixer', code: 'for p in range(layers):\n    apply_problem_hamiltonian(beta[p])\n    apply_mixer_hamiltonian(gamma[p])' },
      { id: 4, title: 'Optimize Parameters', desc: 'Use classical optimizer to find best angles', code: 'result = minimize(cost_function, params, method="COBYLA")' },
      { id: 5, title: 'Measure and Analyze', desc: 'Get solution from quantum measurements', code: 'counts = circuit.measure_all()\nsolution = max(counts, key=counts.get)' }
    ]
  },
  'image-classifier': {
    title: 'CNN Image Classifier',
    description: 'Train a convolutional neural network to classify images',
    collaborator: 'Prof. James Rodriguez',
    tasks: [
      { id: 1, title: 'Load and Preprocess Data', desc: 'Prepare image dataset with augmentation', code: 'from tensorflow.keras.preprocessing.image import ImageDataGenerator\ntrain_gen = ImageDataGenerator(rescale=1./255, rotation_range=20)' },
      { id: 2, title: 'Design CNN Architecture', desc: 'Build convolutional and pooling layers', code: 'model = Sequential([\n    Conv2D(32, (3,3), activation="relu"),\n    MaxPooling2D(2,2),\n    Conv2D(64, (3,3), activation="relu")\n])' },
      { id: 3, title: 'Add Dense Layers', desc: 'Flatten and add fully connected layers', code: 'model.add(Flatten())\nmodel.add(Dense(128, activation="relu"))\nmodel.add(Dense(10, activation="softmax"))' },
      { id: 4, title: 'Compile and Train', desc: 'Set optimizer and train on dataset', code: 'model.compile(optimizer="adam", loss="categorical_crossentropy")\nmodel.fit(train_gen, epochs=20, validation_data=val_gen)' },
      { id: 5, title: 'Evaluate Performance', desc: 'Test accuracy and analyze results', code: 'test_loss, test_acc = model.evaluate(test_data)\nprint(f"Test accuracy: {test_acc:.2%}")' }
    ]
  },
  'gene-knockout': {
    title: 'CRISPR Gene Knockout',
    description: 'Design CRISPR system to knockout a target gene',
    collaborator: 'Dr. Emily Patel',
    tasks: [
      { id: 1, title: 'Select Target Gene', desc: 'Identify gene sequence to knockout', code: 'target_gene = "ATGCGATCGATCGATCG"  # Example sequence\ntarget_location = find_gene_location(genome, target_gene)' },
      { id: 2, title: 'Design Guide RNA', desc: 'Create 20bp guide complementary to target', code: 'guide_rna = target_gene[target_location:target_location+20]\ncheck_off_targets(guide_rna)  # Ensure specificity' },
      { id: 3, title: 'Prepare Cas9 Complex', desc: 'Combine guide RNA with Cas9 enzyme', code: 'crispr_complex = {\n    "guide_rna": guide_rna,\n    "cas9": "SpCas9",\n    "pam": "NGG"\n}' },
      { id: 4, title: 'Deliver to Cells', desc: 'Use viral vector or electroporation', code: 'delivery_method = "AAV_vector"  # Adeno-associated virus\ntransfection_efficiency = deliver_crispr(cells, crispr_complex)' },
      { id: 5, title: 'Verify Knockout', desc: 'Sequence DNA to confirm gene disruption', code: 'edited_cells = sequence_genome(transfected_cells)\nknockout_rate = count_indels(edited_cells) / total_cells' }
    ]
  },
  'iot-sensor': {
    title: 'IoT Temperature Sensor',
    description: 'Build circuit and code for WiFi-enabled temperature sensor',
    collaborator: 'Dr. Michael Kim',
    tasks: [
      { id: 1, title: 'Wire Temperature Sensor', desc: 'Connect DHT22 to microcontroller', code: '// DHT22 connections:\n// VCC -> 3.3V\n// DATA -> GPIO4 (with 10K pullup resistor)\n// GND -> GND' },
      { id: 2, title: 'Setup WiFi Connection', desc: 'Configure ESP8266 to connect to network', code: '#include <ESP8266WiFi.h>\nWiFi.begin("SSID", "password");\nwhile (WiFi.status() != WL_CONNECTED) { delay(500); }' },
      { id: 3, title: 'Read Sensor Data', desc: 'Get temperature and humidity readings', code: '#include <DHT.h>\nDHT dht(4, DHT22);\nfloat temp = dht.readTemperature();\nfloat humidity = dht.readHumidity();' },
      { id: 4, title: 'Send Data to Server', desc: 'POST readings to cloud API', code: 'HTTPClient http;\nhttp.begin("http://api.example.com/data");\nhttp.addHeader("Content-Type", "application/json");\nhttp.POST(json_data);' },
      { id: 5, title: 'Add Sleep Mode', desc: 'Optimize power consumption', code: 'ESP.deepSleep(60e6);  // Sleep for 60 seconds\n// Device will wake up and repeat cycle' }
    ]
  }
};

let scene, camera, renderer, buildings = [], npcs = [], curInteract = null;
let moveF = false, moveB = false, moveL = false, moveR = false;
const vel = new THREE.Vector3(), dir = new THREE.Vector3(), clock = new THREE.Clock();

const locations = {
  quantum: { name: 'Quantum Computing Lab', pos: [-100, 0, -100], color: 0x5a6c7d, size: 40, height: 70 },
  ai: { name: 'AI Research Center', pos: [100, 0, -100], color: 0x6b8e7f, size: 40, height: 68 },
  biotech: { name: 'Biotech Laboratory', pos: [-100, 0, 100], color: 0x7d6b5a, size: 40, height: 65 },
  electronics: { name: 'Electronics Workshop', pos: [100, 0, 100], color: 0x5a7d8e, size: 40, height: 72 }
};

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);
  scene.fog = new THREE.Fog(0x87CEEB, 100, 800);

  camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  camera.position.set(0, 5, 30);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);

  const sun = new THREE.DirectionalLight(0xffffff, 1.2);
  sun.position.set(200, 400, 200);
  sun.castShadow = true;
  scene.add(sun);

  createWorld();
  createNPCs();
  setupControls();
  animate();
  updateHUD();

  notify('Welcome! Ask AI assistant anything (press T) or collaborate with experts on real projects!');
}

function createWorld() {
  const groundGeo = new THREE.PlaneGeometry(1000, 1000);
  const groundMat = new THREE.MeshStandardMaterial({ color: 0x3d5a3d, roughness: 0.9 });
  const ground = new THREE.Mesh(groundGeo, groundMat);
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);

  Object.entries(locations).forEach(([id, loc]) => {
    createBuilding(loc.pos[0], loc.pos[1], loc.pos[2], loc.size, loc.height, loc.size, loc.color, loc.name, id);
  });
}

function createBuilding(x, y, z, w, h, d, color, name, id) {
  const bldgGeo = new THREE.BoxGeometry(w, h, d);
  const bldgMat = new THREE.MeshStandardMaterial({ color, roughness: 0.7, metalness: 0.3 });
  const bldg = new THREE.Mesh(bldgGeo, bldgMat);
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  bldg.userData = { type: 'building', id, name };
  scene.add(bldg);
  buildings.push(bldg);

  createLabel(name, x, h + 12, z, 2.5);
}

function createLabel(text, x, y, z, scale = 1) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 1024;
  canvas.height = 256;
  ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
  ctx.fillRect(0, 0, 1024, 256);
  ctx.strokeStyle = '#7f8c8d';
  ctx.lineWidth = 4;
  ctx.strokeRect(10, 10, 1004, 236);
  ctx.font = 'Bold 70px Arial';
  ctx.fillStyle = '#ecf0f1';
  ctx.textAlign = 'center';
  ctx.fillText(text, 512, 128);
  
  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.position.set(x, y, z);
  sprite.scale.set(30 * scale, 7.5 * scale, 1);
  scene.add(sprite);
}

function createNPCs() {
  const npcList = Object.keys(collaborators);
  npcList.forEach((name, i) => {
    const angle = (i / npcList.length) * Math.PI * 2;
    const x = Math.cos(angle) * 80;
    const z = Math.sin(angle) * 80;
    
    const npcGeo = new THREE.CapsuleGeometry(1.2, 3.5, 8, 16);
    const npcMat = new THREE.MeshStandardMaterial({ color: 0x4a5568, roughness: 0.8, metalness: 0.2 });
    const npc = new THREE.Mesh(npcGeo, npcMat);
    npc.position.set(x, 2.5, z);
    npc.castShadow = true;
    npc.userData = { type: 'npc', name };
    scene.add(npc);
    npcs.push(npc);
    
    createLabel(name, x, 7, z, 0.6);
  });
}

function setupControls() {
  addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  addEventListener('keydown', e => {
    if (e.code === 'KeyW') moveF = true;
    if (e.code === 'KeyS') moveB = true;
    if (e.code === 'KeyA') moveL = true;
    if (e.code === 'KeyD') moveR = true;
    if (e.code === 'KeyE' && curInteract) interact();
    if (e.code === 'KeyT') toggleAI();
  });

  addEventListener('keyup', e => {
    if (e.code === 'KeyW') moveF = false;
    if (e.code === 'KeyS') moveB = false;
    if (e.code === 'KeyA') moveL = false;
    if (e.code === 'KeyD') moveR = false;
  });

  addEventListener('mousemove', e => {
    if (document.pointerLockElement === document.body) {
      camera.rotation.y -= (e.movementX || 0) * 0.002;
      camera.rotation.x -= (e.movementY || 0) * 0.002;
      camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
    }
  });

  document.body.addEventListener('click', () => {
    if (!document.getElementById('charSelect').classList.contains('hide')) return;
    document.body.requestPointerLock();
  });
}

function animate() {
  requestAnimationFrame(animate);
  const delta = clock.getDelta();

  vel.x -= vel.x * 10 * delta;
  vel.z -= vel.z * 10 * delta;
  dir.z = Number(moveF) - Number(moveB);
  dir.x = Number(moveR) - Number(moveL);
  dir.normalize();

  if (moveF || moveB) vel.z -= dir.z * 70 * delta;
  if (moveL || moveR) vel.x -= dir.x * 70 * delta;

  camera.position.x += vel.x * delta;
  camera.position.z += vel.z * delta;

  checkNearby();
  renderer.render(scene, camera);
}

function checkNearby() {
  let nearest = null, minDist = 35;
  
  npcs.forEach(npc => {
    const dist = camera.position.distanceTo(npc.position);
    if (dist < 15 && dist < minDist) { minDist = dist; nearest = npc; }
  });

  if (nearest && nearest !== curInteract) { curInteract = nearest; showNPCInteract(); }
  else if (!nearest && curInteract) { curInteract = null; hideInteract(); }
}

function showNPCInteract() {
  const collab = collaborators[curInteract.userData.name];
  document.getElementById('intTitle').textContent = curInteract.userData.name;
  document.getElementById('intDesc').textContent = collab.greeting;
  
  const btns = document.getElementById('intBtns');
  btns.innerHTML = '';
  
  const collabBtn = document.createElement('button');
  collabBtn.className = 'actBtn';
  collabBtn.textContent = 'START PROJECT COLLABORATION';
  collabBtn.onclick = () => startCollaboration(curInteract.userData.name);
  btns.appendChild(collabBtn);
  
  const closeBtn = document.createElement('button');
  closeBtn.className = 'actBtn';
  closeBtn.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
  closeBtn.textContent = 'LEAVE';
  closeBtn.onclick = hideInteract;
  btns.appendChild(closeBtn);
  
  document.getElementById('interact').classList.remove('hide');
}

function hideInteract() {
  document.getElementById('interact').classList.add('hide');
}

function interact() {}

function startCollaboration(npcName) {
  hideInteract();
  const collab = collaborators[npcName];
  const projectId = collab.projects[Math.floor(Math.random() * collab.projects.length)];
  const project = projects[projectId];
  
  state.currentCollab = { npc: npcName, project: projectId, completedTasks: [] };
  
  let html = `<h2>ü§ù Collaboration: ${project.title}</h2>`;
  
  html += `<div id="collabInfo">`;
  html += `<div class="collabPanel">`;
  html += `<h3>Collaborator</h3>`;
  html += `<p><strong>${npcName}</strong></p>`;
  html += `<p style="font-style: italic; color: #95a5a6;">"${collab.greeting}"</p>`;
  html += `<p><strong>Expertise:</strong></p>`;
  collab.expertise.forEach(exp => {
    html += `<span class="expertTag">${exp}</span>`;
  });
  html += `</div>`;
  
  html += `<div class="collabPanel">`;
  html += `<h3>Project Details</h3>`;
  html += `<p><strong>Goal:</strong> ${project.description}</p>`;
  html += `<p><strong>Tasks:</strong> ${project.tasks.length} steps</p>`;
  html += `<p><strong>Difficulty:</strong> Intermediate</p>`;
  html += `</div>`;
  html += `</div>`;
  
  html += `<div id="projectArea">`;
  html += `<h3>Project Tasks</h3>`;
  project.tasks.forEach((task, i) => {
    html += `<div class="taskItem" id="task${i}">`;
    html += `<div>`;
    html += `<h4>${i + 1}. ${task.title}</h4>`;
    html += `<p>${task.desc}</p>`;
    html += `</div>`;
    html += `<button class="taskBtn" onclick="window.workOnTask(${i})">Work On This</button>`;
    html += `</div>`;
  });
  html += `</div>`;
  
  html += `<div id="collabChat">`;
  html += `<div class="collabMsg npc"><strong>${npcName}:</strong> Let's start with the first task. I'll guide you through it!</div>`;
  html += `</div>`;
  
  html += `<div style="text-align: center; margin-top: 20px;">`;
  html += `<button class="collabBtn secondary" onclick="window.closeCollaboration()">END COLLABORATION</button>`;
  html += `</div>`;
  
  document.getElementById('collabContent').innerHTML = html;
  document.getElementById('collaboration').classList.remove('hide');
}

window.workOnTask = function(taskIndex) {
  const project = projects[state.currentCollab.project];
  const task = project.tasks[taskIndex];
  const npcName = state.currentCollab.npc;
  
  const chat = document.getElementById('collabChat');
  
  chat.innerHTML += `<div class="collabMsg you"><strong>You:</strong> Let's work on "${task.title}"</div>`;
  
  setTimeout(() => {
    chat.innerHTML += `<div class="collabMsg npc"><strong>${npcName}:</strong> Great! ${task.desc}. Here's the code we need:</div>`;
    chat.innerHTML += `<div id="codeEditor">${formatCode(task.code)}</div>`;
    chat.innerHTML += `<div class="collabMsg npc"><strong>${npcName}:</strong> This code ${explainCode(task.title)}. Ready to implement it?</div>`;
    chat.innerHTML += `<div style="text-align: center; margin: 15px 0;"><button class="taskBtn complete" onclick="window.completeTask(${taskIndex})">‚úì Complete Task</button></div>`;
    chat.scrollTop = chat.scrollHeight;
  }, 1000);
};

function formatCode(code) {
  return code
    .replace(/\n/g, '<br>')
    .replace(/(def|class|import|from|for|if|return|while)/g, '<span class="keyword">$1</span>')
    .replace(/(".*?"|'.*?')/g, '<span class="string">$1</span>')
    .replace(/(#.*?)(<br>|$)/g, '<span class="comment">$1</span>$2')
    .replace(/([a-zA-Z_][a-zA-Z0-9_]*)\(/g, '<span class="function">$1</span>(');
}

function explainCode(title) {
  const explanations = {
    'Design Problem Hamiltonian': 'defines the optimization problem we want to solve',
    'Create Mixer Hamiltonian': 'creates quantum superposition for exploring solutions',
    'Implement QAOA Layers': 'alternates between problem and mixing to find optimal solution',
    'Optimize Parameters': 'uses classical optimization to tune quantum circuit parameters',
    'Measure and Analyze': 'extracts the solution from quantum measurements',
    'Load and Preprocess Data': 'prepares images for training with augmentation',
    'Design CNN Architecture': 'builds convolutional layers to extract image features',
    'Add Dense Layers': 'adds fully connected layers for classification',
    'Compile and Train': 'trains the network on the dataset',
    'Evaluate Performance': 'tests the model accuracy on unseen data',
    'Select Target Gene': 'identifies the specific gene we want to edit',
    'Design Guide RNA': 'creates RNA sequence that targets our gene',
    'Prepare Cas9 Complex': 'combines guide RNA with Cas9 cutting enzyme',
    'Deliver to Cells': 'introduces CRISPR system into target cells',
    'Verify Knockout': 'confirms the gene was successfully disrupted',
    'Wire Temperature Sensor': 'connects DHT22 sensor to microcontroller pins',
    'Setup WiFi Connection': 'configures ESP8266 to connect to network',
    'Read Sensor Data': 'gets temperature and humidity from sensor',
    'Send Data to Server': 'transmits readings to cloud API',
    'Add Sleep Mode': 'reduces power consumption between readings'
  };
  return explanations[title] || 'implements this functionality';
}

window.completeTask = function(taskIndex) {
  state.currentCollab.completedTasks.push(taskIndex);
  document.getElementById('task' + taskIndex).classList.add('completed');
  
  const project = projects[state.currentCollab.project];
  const npcName = state.currentCollab.npc;
  const chat = document.getElementById('collabChat');
  
  chat.innerHTML += `<div class="collabMsg npc"><strong>${npcName}:</strong> Excellent work! Task completed successfully. ${state.currentCollab.completedTasks.length}/${project.tasks.length} done.</div>`;
  
  if (state.currentCollab.completedTasks.length === project.tasks.length) {
    state.projectsCompleted++;
    state.collabs++;
    state.rep += 500;
    updateHUD();
    
    setTimeout(() => {
      chat.innerHTML += `<div class="collabMsg npc"><strong>${npcName}:</strong> üéâ Amazing! We completed the entire project together! You've learned so much. +500 Rep!</div>`;
      chat.scrollTop = chat.scrollHeight;
      notify('üéâ Project completed! +500 Rep, +1 Collaboration');
    }, 1000);
  }
  
  chat.scrollTop = chat.scrollHeight;
};

window.closeCollaboration = function() {
  document.getElementById('collaboration').classList.add('hide');
  state.currentCollab = null;
};

function toggleAI() {
  state.aiOpen = !state.aiOpen;
  const body = document.getElementById('aiBody');
  const toggle = document.getElementById('aiToggle');
  
  if (state.aiOpen) {
    body.classList.add('open');
    toggle.textContent = '‚ñ≤';
  } else {
    body.classList.remove('open');
    toggle.textContent = '‚ñº';
  }
}

window.toggleAI = toggleAI;

function askAI() {
  const input = document.getElementById('aiInput');
  const question = input.value.trim();
  if (!question) return;
  
  const chat = document.getElementById('aiChat');
  chat.innerHTML += `<div class="aiMsg user"><strong>You:</strong> ${question}</div>`;
  input.value = '';
  
  setTimeout(() => {
    const answer = getAIResponse(question);
    chat.innerHTML += `<div class="aiMsg ai"><strong>AI:</strong> ${answer}</div>`;
    chat.scrollTop = chat.scrollHeight;
  }, 500);
}

window.askAI = askAI;

function getAIResponse(question) {
  const q = question.toLowerCase();
  
  if (q.includes('quantum')) return aiKnowledge.quantum;
  if (q.includes('ai') || q.includes('neural') || q.includes('machine learning')) return aiKnowledge.ai;
  if (q.includes('circuit') || q.includes('electronic') || q.includes('resistor')) return aiKnowledge.circuit;
  if (q.includes('dna') || q.includes('gene') || q.includes('crispr')) return aiKnowledge.dna;
  if (q.includes('brain') || q.includes('neural interface')) return aiKnowledge.neural;
  if (q.includes('nano')) return aiKnowledge.nano;
  if (q.includes('fusion') || q.includes('nuclear')) return aiKnowledge.fusion;
  if (q.includes('space') || q.includes('rocket') || q.includes('orbit')) return aiKnowledge.space;
  
  return "I can explain quantum computing, AI/neural networks, circuits, DNA/CRISPR, brain interfaces, nanotechnology, fusion energy, and space systems. What would you like to know about?";
}

function updateHUD() {
  document.getElementById('role').textContent = state.char || '-';
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('projects').textContent = `${state.projectsCompleted}/10`;
  document.getElementById('collabs').textContent = state.collabs;
  document.getElementById('rep').textContent = state.rep;
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 3500);
}

let selChar = null;
document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selChar = card.dataset.char;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'START';
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!selChar) return;
  state.char = selChar;
  document.getElementById('charSelect').classList.add('hide');
  document.getElementById('loading').classList.remove('hide');
  
  const msgs = ['Initializing AI assistant...', 'Loading collaborators...', 'Preparing projects...', 'Ready!'];
  let i = 0;
  const interval = setInterval(() => {
    document.getElementById('loadText').textContent = msgs[i++];
    if (i >= msgs.length) {
      clearInterval(interval);
      document.getElementById('loading').classList.add('hide');
      document.getElementById('hud').classList.remove('hide');
      document.getElementById('controls').classList.remove('hide');
      init();
    }
  }, 600);
});
</script>
</body>
</html>