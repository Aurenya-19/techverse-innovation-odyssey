<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse: Underground Tech + Startup Hub</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Courier New', monospace; overflow: hidden; background: #000; color: #0ff; }
#canvas { display: block; width: 100vw; height: 100vh; }

#startScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #0a0a0a, #1a0a2e, #0f0a1e); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
#startScreen h1 { font-size: clamp(2.5em, 7vw, 5em); color: #0ff; text-shadow: 0 0 30px #0ff, 0 0 60px #f0f; margin-bottom: 20px; font-weight: 900; animation: glowCyber 2s ease-in-out infinite; letter-spacing: 5px; }
@keyframes glowCyber { 0%, 100% { text-shadow: 0 0 30px #0ff, 0 0 60px #f0f; } 50% { text-shadow: 0 0 50px #0ff, 0 0 100px #f0f; } }
.subtitle { font-size: clamp(1em, 2.5vw, 1.3em); color: #f0f; margin-bottom: 30px; text-align: center; max-width: 90%; line-height: 1.8; text-shadow: 0 0 10px #f0f; }
.charGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-width: 1100px; width: 90%; margin-bottom: 30px; }
.charCard { background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 255, 0.1)); border: 2px solid #0ff; border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center; min-height: 150px; display: flex; flex-direction: column; justify-content: center; }
.charCard:hover { transform: translateY(-8px); border-color: #f0f; box-shadow: 0 0 30px #0ff, 0 0 60px #f0f; }
.charCard.selected { background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3)); border-color: #f0f; box-shadow: 0 0 40px #f0f; }
.charCard .icon { font-size: clamp(2.5em, 5vw, 3.5em); margin-bottom: 10px; }
.charCard h3 { color: #0ff; font-size: clamp(1.1em, 2.5vw, 1.3em); margin: 8px 0; font-weight: 800; text-shadow: 0 0 10px #0ff; }
.charCard p { color: #f0f; font-size: clamp(0.8em, 1.8vw, 0.95em); text-shadow: 0 0 5px #f0f; }
#startBtn { padding: clamp(15px, 3.5vw, 22px) clamp(50px, 10vw, 90px); font-size: clamp(1.2em, 2.8vw, 1.6em); background: linear-gradient(135deg, #0ff, #f0f); border: none; border-radius: 10px; color: #000; font-weight: 900; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 30px #0ff, 0 0 60px #f0f; transition: all 0.4s; }
#startBtn:hover { transform: scale(1.05); box-shadow: 0 0 50px #0ff, 0 0 100px #f0f; }

#loading { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #0a0a0a, #1a0a2e, #0f0a1e); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
#loading h2 { color: #0ff; font-size: clamp(2em, 5vw, 3em); margin-bottom: 30px; font-weight: 900; animation: pulse 1.5s ease-in-out infinite; text-shadow: 0 0 20px #0ff; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.spinner { border: 8px solid rgba(0, 255, 255, 0.2); border-top: 8px solid #0ff; border-radius: 50%; width: clamp(70px, 12vw, 100px); height: clamp(70px, 12vw, 100px); animation: spin 1s linear infinite; box-shadow: 0 0 30px #0ff; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#loadText { color: #f0f; font-size: clamp(1.1em, 2.3vw, 1.4em); margin-top: 25px; text-align: center; padding: 0 20px; text-shadow: 0 0 10px #f0f; }

#hud { position: fixed; top: 15px; left: 15px; background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(26, 10, 46, 0.9)); padding: clamp(15px, 2.5vw, 25px); border-radius: 10px; border: 2px solid #0ff; min-width: clamp(200px, 28vw, 300px); z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 0 30px #0ff; }
#hud h3 { color: #0ff; font-size: clamp(1.1em, 2.2vw, 1.5em); margin-bottom: 12px; border-bottom: 2px solid #0ff; padding-bottom: 10px; font-weight: 900; text-shadow: 0 0 10px #0ff; }
.hudStat { display: flex; justify-content: space-between; margin: 10px 0; font-size: clamp(0.9em, 1.7vw, 1.1em); color: #0ff; }
.hudStat .val { color: #f0f; font-weight: 900; text-shadow: 0 0 8px #f0f; }

#locationInfo { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(26, 10, 46, 0.9)); padding: 18px 40px; border-radius: 10px; border: 2px solid #f0f; z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 0 30px #f0f; }
#locationInfo h3 { color: #f0f; font-size: clamp(1.3em, 2.8vw, 1.7em); font-weight: 900; text-shadow: 0 0 10px #f0f; }

#interactPrompt { position: fixed; bottom: clamp(120px, 18vh, 180px); left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0ff, #f0f); padding: clamp(12px, 2.5vw, 18px) clamp(30px, 6vw, 50px); border-radius: 10px; font-size: clamp(1em, 2vw, 1.2em); font-weight: 900; color: #000; z-index: 1000; box-shadow: 0 0 30px #0ff; display: none; animation: bounce 1s ease-in-out infinite; }
@keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

#infoPanel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: clamp(350px, 92vw, 1000px); max-height: 88vh; overflow-y: auto; background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 10, 46, 0.95)); padding: clamp(25px, 5vw, 45px); border-radius: 15px; border: 3px solid #0ff; z-index: 6000; backdrop-filter: blur(20px); box-shadow: 0 0 50px #0ff, 0 0 100px #f0f; display: none; }
#infoPanel h2 { color: #0ff; font-size: clamp(1.8em, 4.5vw, 2.8em); margin-bottom: 25px; text-align: center; font-weight: 900; text-shadow: 0 0 20px #0ff; }
#infoPanel p { color: #f0f; font-size: clamp(0.95em, 1.9vw, 1.15em); line-height: 1.9; margin: 18px 0; }
.infoBtn { padding: clamp(12px, 2.5vw, 16px) clamp(25px, 4vw, 35px); background: linear-gradient(135deg, #0ff, #f0f); border: none; border-radius: 10px; color: #000; font-weight: 900; cursor: pointer; margin: clamp(8px, 1.5vw, 12px); font-size: clamp(0.9em, 1.7vw, 1.05em); transition: all 0.3s; box-shadow: 0 0 20px #0ff; display: inline-block; }
.infoBtn:hover { transform: scale(1.05); box-shadow: 0 0 40px #0ff, 0 0 80px #f0f; }
.infoBox { background: rgba(0, 255, 255, 0.1); padding: 18px; border-radius: 10px; margin: 18px 0; border-left: 5px solid #0ff; }
.successBox { background: rgba(255, 0, 255, 0.1); border-left-color: #f0f; }

#controls { position: fixed; bottom: clamp(25px, 5vh, 50px); left: clamp(15px, 2.5vw, 50px); background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(26, 10, 46, 0.9)); padding: clamp(18px, 3vw, 28px); border-radius: 10px; border: 2px solid #0ff; z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 0 30px #0ff; }
#controls h4 { color: #0ff; margin-bottom: 15px; font-size: clamp(1em, 2vw, 1.25em); font-weight: 900; text-shadow: 0 0 10px #0ff; }
.ctrl { color: #f0f; margin: 10px 0; font-size: clamp(0.85em, 1.6vw, 1em); }
.key { color: #000; font-weight: 900; background: linear-gradient(135deg, #0ff, #f0f); padding: clamp(4px, 1vw, 6px) clamp(10px, 2vw, 15px); border-radius: 5px; margin-right: 10px; display: inline-block; box-shadow: 0 0 10px #0ff; }

#notif { position: fixed; top: clamp(120px, 18vh, 180px); left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0ff, #f0f); color: #000; padding: clamp(18px, 3.5vw, 25px) clamp(40px, 7vw, 60px); border-radius: 10px; font-weight: 900; font-size: clamp(1.1em, 2.2vw, 1.3em); opacity: 0; transition: opacity 0.5s; max-width: 90%; text-align: center; z-index: 2000; box-shadow: 0 0 40px #0ff, 0 0 80px #f0f; }
#notif.show { opacity: 1; }

.hide { display: none !important; }

#crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25px; height: 25px; pointer-events: none; z-index: 999; }
#crosshair::before, #crosshair::after { content: ''; position: absolute; background: #0ff; box-shadow: 0 0 10px #0ff; }
#crosshair::before { width: 3px; height: 25px; left: 11px; }
#crosshair::after { width: 25px; height: 3px; top: 11px; }

::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.4); }
::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #0ff, #f0f); border-radius: 5px; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="crosshair"></div>

<div id="startScreen">
  <h1>‚ö° TECHVERSE 2077 ‚ö°</h1>
  <p class="subtitle">Underground Tech Labs + Startup Innovation Hub + Cyberpunk Future</p>
  
  <div class="charGrid">
    <div class="charCard" data-char="Bio-Hacker"><div class="icon">üß¨</div><h3>Bio-Hacker</h3><p>Synthetic life expert</p></div>
    <div class="charCard" data-char="Quantum Rebel"><div class="icon">‚öõÔ∏è</div><h3>Quantum Rebel</h3><p>Underground physicist</p></div>
    <div class="charCard" data-char="Neuro-Engineer"><div class="icon">üß†</div><h3>Neuro-Engineer</h3><p>Brain-tech specialist</p></div>
    <div class="charCard" data-char="Startup Founder"><div class="icon">üöÄ</div><h3>Startup Founder</h3><p>Tech entrepreneur</p></div>
  </div>
  
  <button id="startBtn">JACK IN</button>
</div>

<div id="loading" class="hide">
  <h2>Loading TechVerse...</h2>
  <div class="spinner"></div>
  <p id="loadText">Initializing...</p>
</div>

<div id="hud" class="hide">
  <h3>‚ö° STATUS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>XP:</span><span class="val" id="xp">0/1000</span></div>
  <div class="hudStat"><span>Labs:</span><span class="val" id="labsVisited">0/11</span></div>
</div>

<div id="locationInfo" class="hide">
  <h3 id="currentLocation">üìç Neo-City</h3>
</div>

<div id="interactPrompt">Press E to Hack</div>

<div id="infoPanel">
  <h2 id="panelTitle">Tech</h2>
  <div id="panelContent"></div>
</div>

<div id="controls" class="hide">
  <h4>‚ö° CONTROLS</h4>
  <div class="ctrl"><span class="key">WASD</span> Move</div>
  <div class="ctrl"><span class="key">MOUSE</span> Look</div>
  <div class="ctrl"><span class="key">E</span> Interact</div>
  <div class="ctrl"><span class="key">SHIFT</span> Sprint</div>
  <div class="ctrl"><span class="key">ESC</span> Exit</div>
</div>

<div id="notif"></div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

const state = {
  char: null, lvl: 1, xp: 0, xpMax: 1000, labsVisited: new Set(),
  insideLab: false, currentLab: null, nearInteractable: null
};

let scene, camera, renderer, controls;
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, canJump = false, sprint = false;
let velocity = new THREE.Vector3();
let direction = new THREE.Vector3();
let prevTime = performance.now();
let raycaster = new THREE.Raycaster();
let interactables = [];

const labConfigs = {
  'Startup Hub': { icon: 'üöÄ', color: 0xff00ff, pos: [0, 0, 0], desc: 'Garage-style innovation hub. Pitch ideas, get funding, build prototypes. Raw startup energy.' },
  'Xenobiology': { icon: 'üß¨', color: 0x00ff88, pos: [-60, 0, -80], desc: 'Synthetic life with non-natural DNA. XNA research. Create alien organisms. Controversial but revolutionary.' },
  'OTEC Energy': { icon: 'üåä', color: 0x0088ff, pos: [60, 0, -80], desc: 'Ocean Thermal Energy Conversion. Unlimited clean power from ocean temperature differences. Hawaii pilot plant.' },
  'Optogenetics': { icon: 'üß†', color: 0xff0088, pos: [-60, 0, -20], desc: 'Control neurons with light. Cure blindness, Parkinson\'s. Upload skills to brain. Stanford/MIT research.' },
  'Programmable Matter': { icon: 'üîÆ', color: 0x8800ff, pos: [60, 0, -20], desc: 'Shape-shifting materials. Claytronics - catoms that reconfigure. Carnegie Mellon. Instant manufacturing.' },
  'Wireless Power': { icon: '‚ö°', color: 0xffff00, pos: [-60, 0, 40], desc: 'Electricity through air. MIT WiTricity. No more charging. Power anywhere wirelessly.' },
  'Mycelium Computing': { icon: 'üçÑ', color: 0x88ff00, pos: [60, 0, 40], desc: 'Fungal networks as bio-computers. Living buildings. University of West England. Nature\'s internet.' },
  'Cryogenics': { icon: 'üßä', color: 0x00ffff, pos: [-60, 0, 100], desc: 'Reversible freezing. Organ storage. Space travel. 21st Century Medicine - rabbit kidney revival.' },
  'Metamaterials': { icon: 'üëª', color: 0xff00ff, pos: [60, 0, 100], desc: 'Invisibility cloaks. Duke University. Electromagnetic cloaking. Military classified. Perfect lenses.' },
  'Acoustic Levitation': { icon: 'üîä', color: 0xff8800, pos: [-60, 0, 160], desc: 'Levitate objects with sound. ETH Zurich. Contactless manufacturing. 3D printing in air.' },
  'Epigenetics': { icon: '‚è≥', color: 0x00ff00, pos: [60, 0, 160], desc: 'Reverse aging. Reset cell age markers. Harvard - David Sinclair. Altos Labs. Live 200+ years.' }
};

let selectedChar = null;

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0a1a);
  scene.fog = new THREE.FogExp2(0x0a0a1a, 0.002);
  
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 1.7, 100);
  
  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  
  controls = new PointerLockControls(camera, document.body);
  
  const ambientLight = new THREE.AmbientLight(0x0088ff, 0.3);
  scene.add(ambientLight);
  
  createCyberpunkCity();
  setupControls();
  
  window.addEventListener('resize', onWindowResize);
  
  animate();
  
  document.getElementById('hud').classList.remove('hide');
  document.getElementById('locationInfo').classList.remove('hide');
  document.getElementById('controls').classList.remove('hide');
  document.getElementById('role').textContent = state.char;
  updateHUD();
  updateLocation();
  notify('‚ö° Welcome to Neo-City 2077! Explore underground tech labs!');
}

function createCyberpunkCity() {
  const groundGeometry = new THREE.PlaneGeometry(500, 500);
  const groundMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x0a0a0a,
    roughness: 0.9,
    metalness: 0.1
  });
  const ground = new THREE.Mesh(groundGeometry, groundMaterial);
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);
  
  for (let i = 0; i < 50; i++) {
    const x = (Math.random() - 0.5) * 400;
    const z = (Math.random() - 0.5) * 400;
    const height = 20 + Math.random() * 80;
    const neonLight = new THREE.PointLight(
      Math.random() > 0.5 ? 0x00ffff : 0xff00ff,
      2,
      30
    );
    neonLight.position.set(x, height, z);
    scene.add(neonLight);
  }
  
  Object.entries(labConfigs).forEach(([name, config]) => {
    createCyberpunkLab(name, config);
  });
}

function createCyberpunkLab(name, config) {
  const labGroup = new THREE.Group();
  
  const size = name === 'Startup Hub' ? [60, 35, 70] : [40, 25, 50];
  const buildingGeometry = new THREE.BoxGeometry(...size);
  const buildingMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x1a1a2e,
    roughness: 0.7,
    metalness: 0.3,
    emissive: config.color,
    emissiveIntensity: 0.2
  });
  const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
  building.position.y = size[1] / 2;
  building.castShadow = true;
  building.receiveShadow = true;
  labGroup.add(building);
  
  for (let i = 0; i < 4; i++) {
    const neonBar = new THREE.Mesh(
      new THREE.BoxGeometry(size[0] * 0.8, 0.5, 0.5),
      new THREE.MeshStandardMaterial({ 
        color: config.color,
        emissive: config.color,
        emissiveIntensity: 1
      })
    );
    neonBar.position.set(0, 5 + i * 5, size[2] / 2 + 0.3);
    labGroup.add(neonBar);
  }
  
  const doorGeometry = new THREE.BoxGeometry(5, 7, 0.5);
  const doorMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x000000,
    emissive: config.color,
    emissiveIntensity: 0.5,
    roughness: 0.3,
    metalness: 0.7
  });
  const door = new THREE.Mesh(doorGeometry, doorMaterial);
  door.position.set(0, 3.5, size[2] / 2 + 0.3);
  door.userData = { type: 'entrance', lab: name, desc: config.desc };
  labGroup.add(door);
  interactables.push(door);
  
  const doorLight = new THREE.PointLight(config.color, 3, 15);
  doorLight.position.set(0, 7, size[2] / 2 + 2);
  labGroup.add(doorLight);
  
  labGroup.position.set(config.pos[0], config.pos[1], config.pos[2]);
  scene.add(labGroup);
}

function enterLab(labName, desc) {
  notify(`‚ö° Entering ${labName}...`);
  addXP(150);
  state.labsVisited.add(labName);
  state.insideLab = true;
  state.currentLab = labName;
  
  scene.clear();
  scene.background = new THREE.Color(0x0a0a0a);
  scene.fog = null;
  
  const ambientLight = new THREE.AmbientLight(0x0088ff, 0.2);
  scene.add(ambientLight);
  
  if (labName === 'Startup Hub') {
    createStartupHub();
  } else {
    createUndergroundLab(labName, desc);
  }
  
  camera.position.set(0, 1.7, 28);
  camera.rotation.set(0, 0, 0);
  velocity.set(0, 0, 0);
  
  updateLocation();
  updateHUD();
}

function createStartupHub() {
  const floorGeometry = new THREE.PlaneGeometry(60, 70);
  const floorMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x2a2a2a,
    roughness: 0.9
  });
  const floor = new THREE.Mesh(floorGeometry, floorMaterial);
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);
  
  const wallMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x3a3a3a,
    roughness: 0.9
  });
  
  [
    [0, 2.5, -35, 60, 5, 0.3],
    [-30, 2.5, 0, 0.3, 5, 70],
    [30, 2.5, 0, 0.3, 5, 70],
    [0, 2.5, 35, 60, 5, 0.3]
  ].forEach(w => {
    const wall = new THREE.Mesh(new THREE.BoxGeometry(w[3], w[4], w[5]), wallMaterial);
    wall.position.set(w[0], w[1], w[2]);
    wall.castShadow = true;
    wall.receiveShadow = true;
    scene.add(wall);
  });
  
  for (let i = 0; i < 10; i++) {
    const x = -25 + Math.random() * 50;
    const z = -30 + Math.random() * 60;
    const light = new THREE.PointLight(
      Math.random() > 0.5 ? 0x00ffff : 0xff00ff,
      1.5,
      20
    );
    light.position.set(x, 4, z);
    scene.add(light);
  }
  
  for (let i = 0; i < 5; i++) {
    const whiteboard = new THREE.Mesh(
      new THREE.PlaneGeometry(8, 4),
      new THREE.MeshStandardMaterial({ 
        color: 0xffffff,
        roughness: 0.8
      })
    );
    whiteboard.position.set(-29.8, 2.5, -25 + i * 12);
    whiteboard.rotation.y = Math.PI / 2;
    whiteboard.userData = { type: 'whiteboard', id: i };
    scene.add(whiteboard);
    interactables.push(whiteboard);
  }
  
  for (let i = 0; i < 6; i++) {
    const angle = (i / 6) * Math.PI * 2;
    const radius = 20;
    const x = Math.cos(angle) * radius;
    const z = Math.sin(angle) * radius;
    
    const station = new THREE.Mesh(
      new THREE.BoxGeometry(5, 2, 5),
      new THREE.MeshStandardMaterial({ 
        color: 0x1a1a2e,
        emissive: 0xff00ff,
        emissiveIntensity: 0.3
      })
    );
    station.position.set(x, 1, z);
    station.userData = { type: 'prototype', id: i };
    scene.add(station);
    interactables.push(station);
  }
  
  const pitchArea = new THREE.Mesh(
    new THREE.CylinderGeometry(8, 8, 0.2),
    new THREE.MeshStandardMaterial({ 
      color: 0x00ffff,
      emissive: 0x00ffff,
      emissiveIntensity: 0.5
    })
  );
  pitchArea.position.set(0, 0.1, 0);
  pitchArea.userData = { type: 'pitch' };
  scene.add(pitchArea);
  interactables.push(pitchArea);
  
  const exitDoor = new THREE.Mesh(
    new THREE.BoxGeometry(4, 5, 0.4),
    new THREE.MeshStandardMaterial({ 
      color: 0xff0000,
      emissive: 0xff0000,
      emissiveIntensity: 0.5
    })
  );
  exitDoor.position.set(0, 2.5, 34.8);
  exitDoor.userData = { type: 'exit' };
  scene.add(exitDoor);
  interactables.push(exitDoor);
}

function createUndergroundLab(labName, desc) {
  const floorGeometry = new THREE.PlaneGeometry(40, 50);
  const floorMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x1a1a1a,
    roughness: 0.8
  });
  const floor = new THREE.Mesh(floorGeometry, floorMaterial);
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);
  
  const wallMaterial = new THREE.MeshStandardMaterial({ 
    color: 0x2a2a2a,
    roughness: 0.9
  });
  
  [
    [0, 2.5, -25, 40, 5, 0.3],
    [-20, 2.5, 0, 0.3, 5, 50],
    [20, 2.5, 0, 0.3, 5, 50],
    [0, 2.5, 25, 40, 5, 0.3]
  ].forEach(w => {
    const wall = new THREE.Mesh(new THREE.BoxGeometry(w[3], w[4], w[5]), wallMaterial);
    wall.position.set(w[0], w[1], w[2]);
    wall.castShadow = true;
    wall.receiveShadow = true;
    scene.add(wall);
  });
  
  for (let i = 0; i < 8; i++) {
    const x = -15 + (i % 4) * 10;
    const z = -15 + Math.floor(i / 4) * 30;
    const light = new THREE.PointLight(0x00ffff, 1.5, 20);
    light.position.set(x, 4, z);
    scene.add(light);
  }
  
  const infoPanel = new THREE.Mesh(
    new THREE.PlaneGeometry(10, 6),
    new THREE.MeshStandardMaterial({ 
      color: 0x000000,
      emissive: 0x00ffff,
      emissiveIntensity: 0.5
    })
  );
  infoPanel.position.set(0, 3, -24.8);
  infoPanel.userData = { type: 'info', lab: labName, desc: desc };
  scene.add(infoPanel);
  interactables.push(infoPanel);
  
  for (let i = 0; i < 4; i++) {
    const equipment = new THREE.Mesh(
      new THREE.BoxGeometry(4, 3, 4),
      new THREE.MeshStandardMaterial({ 
        color: 0x1a1a2e,
        emissive: 0xff00ff,
        emissiveIntensity: 0.4
      })
    );
    equipment.position.set(-12 + i * 8, 1.5, 10);
    equipment.userData = { type: 'equipment', id: i };
    scene.add(equipment);
    interactables.push(equipment);
  }
  
  const exitDoor = new THREE.Mesh(
    new THREE.BoxGeometry(4, 5, 0.4),
    new THREE.MeshStandardMaterial({ 
      color: 0xff0000,
      emissive: 0xff0000,
      emissiveIntensity: 0.5
    })
  );
  exitDoor.position.set(0, 2.5, 24.8);
  exitDoor.userData = { type: 'exit' };
  scene.add(exitDoor);
  interactables.push(exitDoor);
}

function exitLab() {
  notify('‚ö° Exiting to Neo-City...');
  state.insideLab = false;
  state.currentLab = null;
  
  scene.clear();
  scene.background = new THREE.Color(0x0a0a1a);
  scene.fog = new THREE.FogExp2(0x0a0a1a, 0.002);
  
  const ambientLight = new THREE.AmbientLight(0x0088ff, 0.3);
  scene.add(ambientLight);
  
  interactables = [];
  createCyberpunkCity();
  
  camera.position.set(0, 1.7, 100);
  camera.rotation.set(0, 0, 0);
  velocity.set(0, 0, 0);
  
  updateLocation();
}

function setupControls() {
  document.addEventListener('keydown', (e) => {
    switch (e.code) {
      case 'KeyW': moveForward = true; break;
      case 'KeyS': moveBackward = true; break;
      case 'KeyA': moveLeft = true; break;
      case 'KeyD': moveRight = true; break;
      case 'ShiftLeft': sprint = true; break;
      case 'Space': if (canJump) { velocity.y += 5; canJump = false; } break;
      case 'KeyE': handleInteraction(); break;
      case 'Escape': 
        if (document.getElementById('infoPanel').style.display === 'block') {
          document.getElementById('infoPanel').style.display = 'none';
        } else if (state.insideLab) {
          exitLab();
        }
        break;
    }
  });
  
  document.addEventListener('keyup', (e) => {
    switch (e.code) {
      case 'KeyW': moveForward = false; break;
      case 'KeyS': moveBackward = false; break;
      case 'KeyA': moveLeft = false; break;
      case 'KeyD': moveRight = false; break;
      case 'ShiftLeft': sprint = false; break;
    }
  });
  
  document.getElementById('canvas').addEventListener('click', () => {
    if (document.getElementById('infoPanel').style.display !== 'block') {
      controls.lock();
    }
  });
}

function handleInteraction() {
  if (state.nearInteractable) {
    const userData = state.nearInteractable.userData;
    if (userData.type === 'entrance') {
      enterLab(userData.lab, userData.desc);
    } else if (userData.type === 'exit') {
      exitLab();
    } else if (userData.type === 'info') {
      showInfoPanel(userData.lab, userData.desc);
    } else if (userData.type === 'whiteboard') {
      showWhiteboardInfo(userData.id);
    } else if (userData.type === 'prototype') {
      showPrototypeInfo(userData.id);
    } else if (userData.type === 'pitch') {
      showPitchArea();
    } else if (userData.type === 'equipment') {
      notify('‚ö° Using equipment... +50 XP');
      addXP(50);
    }
  }
}

function showInfoPanel(lab, desc) {
  const panel = document.getElementById('infoPanel');
  const title = document.getElementById('panelTitle');
  const content = document.getElementById('panelContent');
  
  title.textContent = lab;
  content.innerHTML = `
    <div class="infoBox">
      <strong>‚ö° UNDERGROUND TECH:</strong><br><br>
      ${desc}
    </div>
    
    <div class="successBox">
      <strong>üî¨ WHY IT'S HIDDEN:</strong><br>
      Too controversial, expensive, or ahead of its time. But holds massive potential to change everything.
    </div>
    
    <button class="infoBtn" onclick="closeInfoPanel()">CLOSE</button>
  `;
  
  panel.style.display = 'block';
  controls.unlock();
}

function showWhiteboardInfo(id) {
  const ideas = [
    'Synthetic DNA sequences for alien life forms',
    'Ocean thermal gradient calculations - 100MW output',
    'Optogenetic neural pathway mapping',
    'Claytronics reconfiguration algorithms',
    'Wireless power transmission efficiency curves'
  ];
  
  notify(`üìù Whiteboard: ${ideas[id]}`);
  addXP(30);
}

function showPrototypeInfo(id) {
  const prototypes = [
    'Bio-reactor for XNA synthesis',
    'OTEC heat exchanger prototype',
    'Optogenetic implant v2.3',
    'Programmable matter demo unit',
    'Wireless power transmitter array',
    'Mycelium computing substrate'
  ];
  
  notify(`üîß Prototype: ${prototypes[id]} | +40 XP`);
  addXP(40);
}

function showPitchArea() {
  const panel = document.getElementById('infoPanel');
  const title = document.getElementById('panelTitle');
  const content = document.getElementById('panelContent');
  
  title.textContent = 'üöÄ PITCH YOUR IDEA';
  content.innerHTML = `
    <div class="infoBox">
      <strong>STARTUP PITCH AREA</strong><br><br>
      This is where founders pitch revolutionary ideas to investors. Present your tech, get funding, change the world.
    </div>
    
    <div class="successBox">
      <strong>üí∞ FUNDING AVAILABLE:</strong><br>
      ‚Ä¢ Seed: $500K<br>
      ‚Ä¢ Series A: $5M<br>
      ‚Ä¢ Series B: $20M<br>
      ‚Ä¢ IPO: $500M
    </div>
    
    <button class="infoBtn" onclick="pitchIdea()">PITCH IDEA (+100 XP)</button>
    <button class="infoBtn" onclick="closeInfoPanel()">CLOSE</button>
  `;
  
  panel.style.display = 'block';
  controls.unlock();
}

window.pitchIdea = function() {
  addXP(100);
  notify('üöÄ Pitch successful! Investors interested! +100 XP');
  closeInfoPanel();
};

window.closeInfoPanel = function() {
  document.getElementById('infoPanel').style.display = 'none';
};

function checkNearbyInteractables() {
  raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
  const intersects = raycaster.intersectObjects(interactables);
  
  if (intersects.length > 0 && intersects[0].distance < 6) {
    state.nearInteractable = intersects[0].object;
    document.getElementById('interactPrompt').style.display = 'block';
  } else {
    state.nearInteractable = null;
    document.getElementById('interactPrompt').style.display = 'none';
  }
}

function animate() {
  requestAnimationFrame(animate);
  
  const time = performance.now();
  
  if (controls.isLocked) {
    const delta = (time - prevTime) / 1000;
    
    velocity.x -= velocity.x * 8.0 * delta;
    velocity.z -= velocity.z * 8.0 * delta;
    velocity.y -= 9.8 * 10.0 * delta;
    
    direction.z = Number(moveForward) - Number(moveBackward);
    direction.x = Number(moveRight) - Number(moveLeft);
    direction.normalize();
    
    const speed = sprint ? 50 : 30;
    
    if (moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
    if (moveLeft || moveRight) velocity.x -= direction.x * speed * delta;
    
    controls.moveRight(-velocity.x * delta);
    controls.moveForward(-velocity.z * delta);
    
    camera.position.y += velocity.y * delta;
    
    if (camera.position.y < 1.7) {
      velocity.y = 0;
      camera.position.y = 1.7;
      canJump = true;
    }
    
    checkNearbyInteractables();
  }
  
  prevTime = time;
  
  renderer.render(scene, camera);
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function updateLocation() {
  const locText = document.getElementById('currentLocation');
  if (state.insideLab) {
    const config = labConfigs[state.currentLab];
    locText.textContent = `${config.icon} ${state.currentLab}`;
  } else {
    locText.textContent = 'üìç Neo-City 2077';
  }
}

function addXP(amount) {
  state.xp += amount;
  while (state.xp >= state.xpMax) {
    state.xp -= state.xpMax;
    state.lvl++;
    state.xpMax = Math.floor(state.xpMax * 1.5);
    notify(`‚ö° LEVEL UP! Level ${state.lvl}!`);
  }
  updateHUD();
}

function updateHUD() {
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('xp').textContent = `${state.xp}/${state.xpMax}`;
  document.getElementById('labsVisited').textContent = `${state.labsVisited.size}/11`;
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 4000);
}

document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedChar = card.dataset.char;
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!selectedChar) {
    alert('Select a character first!');
    return;
  }
  
  state.char = selectedChar;
  document.getElementById('startScreen').classList.add('hide');
  document.getElementById('loading').classList.remove('hide');
  
  const msgs = [
    'Initializing Neural Interface...',
    'Loading Underground Tech Database...',
    'Creating Startup Hub...',
    'Rendering Cyberpunk City...',
    'Activating Neon Lights...',
    'Ready to Jack In!'
  ];
  let i = 0;
  const interval = setInterval(() => {
    document.getElementById('loadText').textContent = msgs[i];
    i++;
    
    if (i >= msgs.length) {
      clearInterval(interval);
      setTimeout(() => {
        document.getElementById('loading').classList.add('hide');
        init();
      }, 500);
    }
  }, 700);
});
</script>
</body>
</html>