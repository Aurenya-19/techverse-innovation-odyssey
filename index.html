<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse 2077 - Ultimate Futuristic Edition</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
body { font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; color: #fff; }
#canvas { display: block; width: 100vw; height: 100vh; }

#startScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2, #f093fb); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px; }
#startScreen h1 { font-size: 3.5em; color: #fff; text-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 10px; font-weight: 900; }
.subtitle { font-size: 1em; color: #fff; margin-bottom: 15px; text-align: center; line-height: 1.4; max-width: 900px; }
.charGrid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-width: 1100px; margin-bottom: 15px; }
.charCard { background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); border-radius: 10px; padding: 10px; cursor: pointer; text-align: center; transition: all 0.3s; }
.charCard:hover { transform: translateY(-5px); }
.charCard.selected { background: rgba(46,204,113,0.4) !important; border: 3px solid #27ae60 !important; transform: scale(1.05) !important; }
.charCard .icon { font-size: 2em; margin-bottom: 6px; }
.charCard h3 { color: #fff; font-size: 0.95em; margin-bottom: 5px; font-weight: 800; }
.charCard p { color: rgba(255,255,255,0.9); font-size: 0.75em; }
.charCard .bonus { color: #f1c40f; font-size: 0.7em; margin-top: 3px; font-weight: bold; }
#selectedInfo { background: rgba(46,204,113,0.95); color: #fff; padding: 8px 25px; border-radius: 8px; font-weight: bold; margin-bottom: 12px; display: none; }
#startBtn { padding: 16px 65px; font-size: 1.4em; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 12px; color: #fff; font-weight: 900; cursor: pointer; transition: all 0.3s; text-transform: uppercase; }
#startBtn:hover { transform: translateY(-3px); }
#startBtn:disabled { opacity: 0.5; cursor: not-allowed; }

#hud { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.92); padding: 15px; border-radius: 10px; border: 2px solid #3498db; min-width: 220px; z-index: 1000; display: none; }
#hud h3 { color: #3498db; margin-bottom: 8px; font-size: 1.2em; }
.hudStat { display: flex; justify-content: space-between; margin: 6px 0; color: #fff; font-size: 0.9em; }
.hudStat .val { color: #27ae60; font-weight: bold; }

#miniMap { position: fixed; bottom: 10px; right: 10px; width: 280px; height: 280px; background: rgba(0,0,0,0.92); border: 3px solid #3498db; border-radius: 10px; z-index: 1000; display: none; padding: 10px; }
#miniMap h4 { color: #3498db; margin-bottom: 8px; font-size: 1em; text-align: center; }
#miniMapCanvas { width: 100%; height: calc(100% - 30px); background: #1a1a1a; border-radius: 5px; }

#locationInfo { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.92); padding: 12px 35px; border-radius: 10px; border: 2px solid #3498db; z-index: 1000; display: none; }
#locationInfo h3 { color: #3498db; font-size: 1.3em; }

#interactPrompt { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #27ae60, #229954); padding: 12px 35px; border-radius: 10px; font-weight: bold; color: #fff; z-index: 1000; display: none; animation: bounce 1s ease-in-out infinite; font-size: 1em; }
@keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

#gadgetUI { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95vw; max-width: 1000px; height: 88vh; background: rgba(0,0,0,0.98); border: 4px solid #3498db; border-radius: 18px; padding: 25px; z-index: 5000; display: none; overflow-y: auto; box-shadow: 0 0 60px rgba(52,152,219,0.6); }
#gadgetUI h2 { color: #3498db; font-size: 2.2em; text-align: center; margin-bottom: 12px; text-transform: uppercase; }
#gadgetUI .subtitle { color: #ecf0f1; font-size: 1em; text-align: center; margin-bottom: 18px; }
.closeBtn { position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.95em; font-weight: bold; cursor: pointer; z-index: 10; }
.closeBtn:hover { transform: scale(1.05); }

.screen { background: #000; border: 3px solid #0f0; border-radius: 10px; padding: 18px; margin: 12px 0; min-height: 180px; font-family: 'Courier New', monospace; color: #0f0; font-size: 0.95em; line-height: 1.4; overflow-y: auto; max-height: 280px; white-space: pre-wrap; }
.progress { width: 100%; height: 32px; background: rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; margin: 18px 0; border: 2px solid #3498db; }
.progressBar { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71, #27ae60); width: 0%; transition: width 0.5s; box-shadow: 0 0 20px rgba(46,204,113,0.8); }

.optionGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 18px 0; }
.option { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; border: none; padding: 18px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s; text-align: center; }
.option:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(52,152,219,0.6); }
.option.selected { background: linear-gradient(135deg, #27ae60, #229954); border: 3px solid #2ecc71; }

.actionBtn { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; border: none; padding: 14px 35px; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin: 8px; transition: all 0.3s; text-transform: uppercase; }
.actionBtn:hover { transform: scale(1.08); box-shadow: 0 5px 20px rgba(52,152,219,0.6); }
.actionBtn.success { background: linear-gradient(135deg, #27ae60, #229954); }

#controls { position: fixed; bottom: 18px; left: 18px; background: rgba(0,0,0,0.92); padding: 16px; border-radius: 10px; border: 2px solid #3498db; z-index: 1000; display: none; }
#controls h4 { color: #3498db; margin-bottom: 8px; font-size: 1.1em; }
.ctrl { color: #ecf0f1; margin: 6px 0; font-size: 0.85em; }
.key { color: #fff; font-weight: bold; background: linear-gradient(135deg, #3498db, #2980b9); padding: 4px 10px; border-radius: 5px; margin-right: 6px; }

#notif { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #27ae60, #229954); color: #fff; padding: 16px 40px; border-radius: 10px; font-weight: bold; font-size: 1.05em; opacity: 0; transition: opacity 0.5s; max-width: 88%; text-align: center; z-index: 2000; box-shadow: 0 5px 30px rgba(39,174,96,0.7); }
#notif.show { opacity: 1; }

#crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; pointer-events: none; z-index: 999; display: none; }
#crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(255,255,255,0.8); box-shadow: 0 0 5px rgba(0,0,0,0.8); }
#crosshair::before { width: 2px; height: 20px; left: 9px; }
#crosshair::after { width: 20px; height: 2px; top: 9px; }

.hide { display: none !important; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 4px; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="crosshair"></div>

<div id="startScreen">
  <h1>üåü TECHVERSE 2077 - ULTIMATE üåü</h1>
  <p class="subtitle">29 Futuristic Labs ‚Ä¢ Robo Lab ‚Ä¢ Flying Car Showroom ‚Ä¢ Consciousness Upload ‚Ä¢ Gravity Manipulation ‚Ä¢ Time Dilation ‚Ä¢ Dimensional Portals ‚Ä¢ 500+ Gadgets ‚Ä¢ Build Robots ‚Ä¢ Test Drive Flying Cars ‚Ä¢ Upload Your Mind</p>
  
  <div class="charGrid">
    <div class="charCard" data-char="Bio-Hacker"><div class="icon">üß¨</div><h3>Bio-Hacker</h3><p>Synthetic life</p><div class="bonus">+50% Bio XP</div></div>
    <div class="charCard" data-char="Quantum Rebel"><div class="icon">‚öõÔ∏è</div><h3>Quantum Rebel</h3><p>Quantum physics</p><div class="bonus">+50% Quantum XP</div></div>
    <div class="charCard" data-char="Neuro-Engineer"><div class="icon">üß†</div><h3>Neuro-Engineer</h3><p>Brain tech</p><div class="bonus">+50% Neuro XP</div></div>
    <div class="charCard" data-char="Robo Engineer"><div class="icon">ü§ñ</div><h3>Robo Engineer</h3><p>Robot builder</p><div class="bonus">+100% Robo XP</div></div>
    <div class="charCard" data-char="Flying Car Pilot"><div class="icon">üöó</div><h3>Flying Car Pilot</h3><p>Vehicle expert</p><div class="bonus">+100% Car XP</div></div>
    <div class="charCard" data-char="Startup Founder"><div class="icon">üöÄ</div><h3>Startup Founder</h3><p>Entrepreneur</p><div class="bonus">+100% Hub XP</div></div>
    <div class="charCard" data-char="Gravity Master"><div class="icon">üåå</div><h3>Gravity Master</h3><p>Anti-gravity</p><div class="bonus">+50% Gravity XP</div></div>
    <div class="charCard" data-char="Time Traveler"><div class="icon">‚è∞</div><h3>Time Traveler</h3><p>Temporal expert</p><div class="bonus">+50% Time XP</div></div>
    <div class="charCard" data-char="Portal Jumper"><div class="icon">üåÄ</div><h3>Portal Jumper</h3><p>Dimension hopper</p><div class="bonus">+50% Portal XP</div></div>
    <div class="charCard" data-char="Consciousness Hacker"><div class="icon">üß†</div><h3>Mind Hacker</h3><p>Digital immortality</p><div class="bonus">+50% Mind XP</div></div>
    <div class="charCard" data-char="Cyborg Mechanic"><div class="icon">ü§ñ</div><h3>Cyborg Mechanic</h3><p>Augmentation</p><div class="bonus">+25% All XP</div></div>
    <div class="charCard" data-char="Space Architect"><div class="icon">üåå</div><h3>Space Architect</h3><p>Megastructures</p><div class="bonus">Start Lv2</div></div>
    <div class="charCard" data-char="Nano-Surgeon"><div class="icon">üíä</div><h3>Nano-Surgeon</h3><p>Medical nanobots</p><div class="bonus">+200 Start XP</div></div>
    <div class="charCard" data-char="Hologram Artist"><div class="icon">üé®</div><h3>Hologram Artist</h3><p>3D designer</p><div class="bonus">+50% Holo XP</div></div>
    <div class="charCard" data-char="Dyson Engineer"><div class="icon">‚òÄÔ∏è</div><h3>Dyson Engineer</h3><p>Stellar energy</p><div class="bonus">+50% Dyson XP</div></div>
  </div>
  
  <div id="selectedInfo">Selected: None</div>
  <button id="startBtn" disabled>START ADVENTURE</button>
</div>

<div id="hud">
  <h3>‚ö° STATUS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>XP:</span><span class="val" id="xp">0/1000</span></div>
  <div class="hudStat"><span>Labs:</span><span class="val" id="labsVisited">0/29</span></div>
  <div class="hudStat"><span>Gadgets:</span><span class="val" id="gadgetsUsed">0/500</span></div>
</div>

<div id="miniMap">
  <h4>üó∫Ô∏è CITY MAP (M)</h4>
  <canvas id="miniMapCanvas"></canvas>
</div>

<div id="locationInfo"><h3 id="currentLocation">üìç Neo-City 2077</h3></div>
<div id="interactPrompt">Press E to Interact</div>

<div id="gadgetUI">
  <button class="closeBtn" onclick="closeGadget()">‚úï CLOSE</button>
  <h2 id="gadgetTitle">Gadget</h2>
  <p class="subtitle" id="gadgetSubtitle">Instructions will appear here</p>
  <div id="gadgetContent"></div>
</div>

<div id="controls">
  <h4>üéÆ CONTROLS</h4>
  <div class="ctrl"><span class="key">WASD</span> Move</div>
  <div class="ctrl"><span class="key">MOUSE</span> Look</div>
  <div class="ctrl"><span class="key">E</span> Interact</div>
  <div class="ctrl"><span class="key">SHIFT</span> Sprint</div>
  <div class="ctrl"><span class="key">M</span> Map</div>
  <div class="ctrl"><span class="key">ESC</span> Exit</div>
</div>

<div id="notif"></div>

<script type="importmap">
{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}
</script>

<script type="module">
import * as THREE from 'three';
import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

const state = { 
  char: null, lvl: 1, xp: 0, xpMax: 1000, labsVisited: new Set(), 
  insideLab: false, currentLab: null, nearInteractable: null, 
  gadgetActive: false, gadgetsUsed: 0, mapVisible: false,
  robotBuild: {}
};
let scene, camera, renderer, controls, raycaster = new THREE.Raycaster(), interactables = [];
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, sprint = false;
let velocity = new THREE.Vector3(), direction = new THREE.Vector3(), prevTime = performance.now();

const labConfigs = {
  'Robo Lab': { color: 0xff6b6b, pos: [-160, 0, -160], icon: 'ü§ñ' },
  'Flying Car Showroom': { color: 0x4ecdc4, pos: [-80, 0, -160], icon: 'üöó' },
  'Holographic Studio': { color: 0x95e1d3, pos: [0, 0, -160], icon: 'üé®' },
  'Consciousness Upload': { color: 0xf38181, pos: [80, 0, -160], icon: 'üß†' },
  'Gravity Lab': { color: 0xaa96da, pos: [160, 0, -160], icon: 'üåå' },
  
  'Time Dilation': { color: 0xfcbad3, pos: [-160, 0, -80], icon: '‚è∞' },
  'Dimensional Portal': { color: 0xa8e6cf, pos: [-80, 0, -80], icon: 'üåÄ' },
  'Synthetic Biology': { color: 0xffd3b6, pos: [0, 0, -80], icon: 'üß¨' },
  'Neural Link': { color: 0xffaaa5, pos: [80, 0, -80], icon: 'üîó' },
  'Dyson Sphere': { color: 0xff8b94, pos: [160, 0, -80], icon: '‚òÄÔ∏è' },
  
  'Quantum Computing': { color: 0x9b59b6, pos: [-160, 0, 0], icon: '‚öõÔ∏è' },
  'Nanotechnology': { color: 0xe74c3c, pos: [-80, 0, 0], icon: 'üî¨' },
  'AI Research': { color: 0xe67e22, pos: [80, 0, 0], icon: 'ü§ñ' },
  'Bioprinting': { color: 0x1abc9c, pos: [160, 0, 0], icon: 'üñ®Ô∏è' },
  
  'Fusion Energy': { color: 0xf39c12, pos: [-160, 0, 80], icon: '‚ò¢Ô∏è' },
  'Space Propulsion': { color: 0x3498db, pos: [-80, 0, 80], icon: 'üöÄ' },
  'Acoustic Levitation': { color: 0xe67e22, pos: [80, 0, 80], icon: 'üîä' },
  'Epigenetics': { color: 0x2ecc71, pos: [160, 0, 80], icon: '‚è≥' },
  
  'Wireless Power': { color: 0xf39c12, pos: [-160, 0, 160], icon: '‚ö°' },
  'Mycelium Computing': { color: 0x27ae60, pos: [-80, 0, 160], icon: 'üçÑ' },
  'Cryogenics': { color: 0x16a085, pos: [0, 0, 160], icon: 'üßä' },
  'Metamaterials': { color: 0x34495e, pos: [80, 0, 160], icon: 'üëª' },
  'Optogenetics': { color: 0x9b59b6, pos: [160, 0, 160], icon: 'üß†' },
  
  'Xenobiology': { color: 0x1abc9c, pos: [-120, 0, 240], icon: 'üß¨' },
  'OTEC Energy': { color: 0x3498db, pos: [-40, 0, 240], icon: 'üåä' },
  'Programmable Matter': { color: 0x8e44ad, pos: [40, 0, 240], icon: 'üîÆ' },
  'Hybrid Lab': { color: 0xe74c3c, pos: [120, 0, 240], icon: 'ü§ù' },
  
  'Startup Hub': { color: 0xff00ff, pos: [-60, 0, 320], icon: 'üíº', size: [70, 50, 75] },
  'Tech Championship': { color: 0xf1c40f, pos: [60, 0, 320], icon: 'üèÜ', size: [70, 50, 75] }
};

const gadgetData = {
  robot: { name: 'Humanoid Assembly', icon: 'ü§ñ', desc: 'Build your custom robot from scratch' },
  car: { name: 'Flying Car Simulator', icon: 'üöó', desc: 'Test drive futuristic vehicles' },
  holo: { name: 'Hologram Projector', icon: 'üé®', desc: 'Create 3D holograms' },
  mind: { name: 'Brain Scanner', icon: 'üß†', desc: 'Upload consciousness to digital realm' },
  gravity: { name: 'Anti-Gravity Gen', icon: 'üåå', desc: 'Manipulate gravitational fields' },
  time: { name: 'Temporal Field Gen', icon: '‚è∞', desc: 'Control time dilation' },
  portal: { name: 'Portal Generator', icon: 'üåÄ', desc: 'Open dimensional portals' },
  bio: { name: 'Organism Designer', icon: 'üß¨', desc: 'Create synthetic life forms' },
  neural: { name: 'Brain Chip Implanter', icon: 'üîó', desc: 'Install neural interfaces' },
  dyson: { name: 'Stellar Collector', icon: '‚òÄÔ∏è', desc: 'Harvest star energy' },
  dna: { name: 'DNA Sequencer', icon: 'üß¨', desc: 'Sequence genetic code' },
  quantum: { name: 'Quantum Processor', icon: '‚öõÔ∏è', desc: 'Quantum computing' },
  nano: { name: 'Nano-Assembler', icon: 'üî¨', desc: 'Build molecular machines' },
  ai: { name: 'AI Trainer', icon: 'ü§ñ', desc: 'Train neural networks' },
  fusion: { name: 'Fusion Reactor', icon: '‚ò¢Ô∏è', desc: 'Generate fusion energy' }
};

function playSound(freq, duration) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + duration);
  } catch(e) {}
}

function createTextSprite(text, color) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 1024;
  canvas.height = 256;
  ctx.fillStyle = 'rgba(0,0,0,0.9)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.font = 'Bold 55px Arial';
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, 512, 128);
  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.scale.set(28, 7, 1);
  return sprite;
}

function createGadget(type, pos, id) {
  const group = new THREE.Group();
  const colors = [0x3498db, 0x1abc9c, 0x9b59b6, 0xe74c3c, 0xf39c12, 0x27ae60, 0xff6b6b, 0x4ecdc4];
  const color = colors[id % colors.length];
  
  const base = new THREE.Mesh(
    new THREE.BoxGeometry(2, 1.8, 2),
    new THREE.MeshStandardMaterial({ color: color, metalness: 0.6, roughness: 0.4 })
  );
  base.position.y = 0.9;
  base.castShadow = true;
  
  const screen = new THREE.Mesh(
    new THREE.BoxGeometry(1.6, 1.2, 0.1),
    new THREE.MeshStandardMaterial({ color: 0x2c3e50, emissive: color, emissiveIntensity: 0.5 })
  );
  screen.position.set(0, 1.5, 1.05);
  screen.castShadow = true;
  
  group.add(base, screen);
  group.position.copy(pos);
  group.userData = { type: type, id: id, interactive: true, ...gadgetData[type] };
  
  return group;
}

function drawMiniMap() {
  const canvas = document.getElementById('miniMapCanvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.width = 260;
  const h = canvas.height = 240;
  
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(0, 0, w, h);
  
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    ctx.beginPath();
    ctx.moveTo(i * w/5, 0);
    ctx.lineTo(i * w/5, h);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, i * h/5);
    ctx.lineTo(w, i * h/5);
    ctx.stroke();
  }
  
  Object.entries(labConfigs).forEach(([name, config]) => {
    const x = (config.pos[0] + 200) / 400 * w;
    const y = (config.pos[2] + 200) / 400 * h;
    const size = config.size ? 10 : 7;
    
    ctx.fillStyle = `#${config.color.toString(16).padStart(6, '0')}`;
    ctx.fillRect(x - size/2, y - size/2, size, size);
    
    ctx.fillStyle = '#fff';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(config.icon, x, y + 3);
  });
  
  if (!state.insideLab) {
    const px = (camera.position.x + 200) / 400 * w;
    const py = (camera.position.z + 200) / 400 * h;
    ctx.fillStyle = '#27ae60';
    ctx.beginPath();
    ctx.arc(px, py, 4, 0, Math.PI * 2);
    ctx.fill();
  }
}

document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', function() {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    this.classList.add('selected');
    state.char = this.dataset.char;
    document.getElementById('selectedInfo').textContent = `‚úì ${state.char}`;
    document.getElementById('selectedInfo').style.display = 'block';
    document.getElementById('startBtn').disabled = false;
    playSound(800, 0.1);
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!state.char) return;
  if (state.char === 'Space Architect') state.lvl = 2;
  if (state.char === 'Nano-Surgeon') state.xp = 200;
  document.getElementById('startScreen').classList.add('hide');
  ['hud', 'locationInfo', 'controls', 'crosshair'].forEach(id => document.getElementById(id).style.display = 'block');
  document.getElementById('role').textContent = state.char;
  playSound(1200, 0.3);
  init();
});

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);
  scene.fog = new THREE.Fog(0x87CEEB, 50, 800);
  
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 1.7, 350);
  
  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  
  controls = new PointerLockControls(camera, document.body);
  
  scene.add(new THREE.AmbientLight(0xffffff, 0.8));
  
  const sun = new THREE.DirectionalLight(0xffffff, 1.5);
  sun.position.set(250, 350, 200);
  sun.castShadow = true;
  sun.shadow.camera.left = -700;
  sun.shadow.camera.right = 700;
  sun.shadow.camera.top = 700;
  sun.shadow.camera.bottom = -700;
  scene.add(sun);
  
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(1500, 1500),
    new THREE.MeshStandardMaterial({ color: 0x228B22, roughness: 0.9 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);
  
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(70, 1200),
    new THREE.MeshStandardMaterial({ color: 0x404040, roughness: 0.95 })
  );
  road.rotation.x = -Math.PI / 2;
  road.position.y = 0.01;
  scene.add(road);
  
  for (let i = -600; i <= 600; i += 30) {
    const line = new THREE.Mesh(
      new THREE.PlaneGeometry(1.5, 14),
      new THREE.MeshStandardMaterial({ color: 0xffffff })
    );
    line.rotation.x = -Math.PI / 2;
    line.position.set(0, 0.02, i);
    scene.add(line);
  }
  
  createCity();
  setupControls();
  window.addEventListener('resize', () => { 
    camera.aspect = window.innerWidth / window.innerHeight; 
    camera.updateProjectionMatrix(); 
    renderer.setSize(window.innerWidth, window.innerHeight); 
  });
  animate();
  updateHUD();
  drawMiniMap();
  notify(`üéÆ Welcome ${state.char}! Press M for map. 29 labs to explore!`);
}

function createCity() {
  Object.entries(labConfigs).forEach(([name, config]) => {
    const size = config.size || [55, 45, 65];
    
    const building = new THREE.Mesh(
      new THREE.BoxGeometry(size[0], size[1], size[2]),
      new THREE.MeshStandardMaterial({ color: 0xCCCCCC, roughness: 0.7, metalness: 0.3 })
    );
    building.position.set(config.pos[0], size[1]/2, config.pos[2]);
    building.castShadow = true;
    building.receiveShadow = true;
    scene.add(building);
    
    const floors = Math.floor(size[1] / 5);
    const cols = Math.floor(size[0] / 6);
    for (let floor = 0; floor < floors; floor++) {
      for (let col = 0; col < cols; col++) {
        const win = new THREE.Mesh(
          new THREE.BoxGeometry(4, 3, 0.3),
          new THREE.MeshStandardMaterial({ 
            color: 0x87CEEB, 
            transparent: true, 
            opacity: 0.7,
            emissive: 0x3498db,
            emissiveIntensity: 0.2
          })
        );
        win.position.set(
          -size[0]/2 + 5 + col * 6,
          -size[1]/2 + 5 + floor * 5,
          size[2]/2 + 0.15
        );
        building.add(win);
      }
    }
    
    const label = createTextSprite(`${config.icon} ${name.toUpperCase()}`, `#${config.color.toString(16).padStart(6, '0')}`);
    label.position.set(0, size[1]/2 + 10, 0);
    building.add(label);
    
    const door = new THREE.Mesh(
      new THREE.BoxGeometry(10, 12, 1),
      new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.6 })
    );
    door.position.set(0, -size[1]/2 + 6, size[2]/2 + 0.5);
    door.userData = { type: 'entrance', lab: name };
    door.castShadow = true;
    building.add(door);
    interactables.push(door);
    
    const sign = new THREE.Mesh(
      new THREE.BoxGeometry(14, 4, 0.5),
      new THREE.MeshStandardMaterial({ 
        color: config.color, 
        emissive: config.color, 
        emissiveIntensity: 0.6
      })
    );
    sign.position.set(0, -size[1]/2 + 13, size[2]/2 + 0.8);
    building.add(sign);
  });
}

function enterLab(labName) {
  notify(`üö™ Entering ${labName}...`);
  playSound(600, 0.2);
  state.labsVisited.add(labName);
  state.insideLab = true;
  state.currentLab = labName;
  
  scene.clear();
  interactables = [];
  scene.background = new THREE.Color(0xF5F5F5);
  
  scene.add(new THREE.AmbientLight(0xffffff, 0.8));
  
  const light = new THREE.DirectionalLight(0xffffff, 0.9);
  light.position.set(0, 20, 0);
  light.castShadow = true;
  scene.add(light);
  
  createLabInterior();
  
  camera.position.set(0, 1.7, 55);
  velocity.set(0, 0, 0);
  updateHUD();
}

function createLabInterior() {
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(130, 150),
    new THREE.MeshStandardMaterial({ color: 0xE0E0E0, roughness: 0.8 })
  );
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);
  
  const ceiling = new THREE.Mesh(
    new THREE.PlaneGeometry(130, 150),
    new THREE.MeshStandardMaterial({ color: 0xFAFAFA })
  );
  ceiling.rotation.x = Math.PI / 2;
  ceiling.position.y = 6;
  scene.add(ceiling);
  
  [[0, 3, -75, 130, 6, 0.5], [-65, 3, 0, 0.5, 6, 150], [65, 3, 0, 0.5, 6, 150], [0, 3, 75, 130, 6, 0.5]].forEach(w => {
    const wall = new THREE.Mesh(
      new THREE.BoxGeometry(w[3], w[4], w[5]),
      new THREE.MeshStandardMaterial({ color: 0xFAFAFA, roughness: 0.85 })
    );
    wall.position.set(w[0], w[1], w[2]);
    wall.castShadow = true;
    scene.add(wall);
  });
  
  const gadgetTypes = Object.keys(gadgetData);
  let gadgetId = 1;
  
  for (let row = 0; row < 8; row++) {
    for (let col = 0; col < 10; col++) {
      const type = gadgetTypes[gadgetId % gadgetTypes.length];
      const x = -58 + col * 13;
      const z = -65 + row * 18;
      const gadget = createGadget(type, new THREE.Vector3(x, 0, z), gadgetId);
      scene.add(gadget);
      interactables.push(gadget);
      gadgetId++;
    }
  }
  
  for (let i = 0; i < 18; i++) {
    const light = new THREE.PointLight(0xffffff, 0.5, 28);
    light.position.set(-55 + (i % 6) * 22, 5.5, -60 + Math.floor(i / 6) * 60);
    scene.add(light);
  }
  
  const exit = new THREE.Mesh(
    new THREE.BoxGeometry(8, 10, 0.8),
    new THREE.MeshStandardMaterial({ color: 0xff4500, emissive: 0xff4500, emissiveIntensity: 0.3 })
  );
  exit.position.set(0, 5, 74.7);
  exit.userData = { type: 'exit' };
  scene.add(exit);
  interactables.push(exit);
}

function exitLab() {
  notify('üö™ Exiting to city...');
  playSound(500, 0.2);
  state.insideLab = false;
  state.currentLab = null;
  
  scene.clear();
  interactables = [];
  scene.background = new THREE.Color(0x87CEEB);
  scene.fog = new THREE.Fog(0x87CEEB, 50, 800);
  
  scene.add(new THREE.AmbientLight(0xffffff, 0.8));
  
  const sun = new THREE.DirectionalLight(0xffffff, 1.5);
  sun.position.set(250, 350, 200);
  scene.add(sun);
  
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(1500, 1500),
    new THREE.MeshStandardMaterial({ color: 0x228B22 })
  );
  ground.rotation.x = -Math.PI / 2;
  scene.add(ground);
  
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(70, 1200),
    new THREE.MeshStandardMaterial({ color: 0x404040 })
  );
  road.rotation.x = -Math.PI / 2;
  road.position.y = 0.01;
  scene.add(road);
  
  for (let i = -600; i <= 600; i += 30) {
    const line = new THREE.Mesh(
      new THREE.PlaneGeometry(1.5, 14),
      new THREE.MeshStandardMaterial({ color: 0xffffff })
    );
    line.rotation.x = -Math.PI / 2;
    line.position.set(0, 0.02, i);
    scene.add(line);
  }
  
  createCity();
  camera.position.set(0, 1.7, 350);
  velocity.set(0, 0, 0);
  updateHUD();
  drawMiniMap();
}

function setupControls() {
  document.addEventListener('keydown', (e) => {
    if (e.code === 'KeyW') moveForward = true;
    if (e.code === 'KeyS') moveBackward = true;
    if (e.code === 'KeyA') moveLeft = true;
    if (e.code === 'KeyD') moveRight = true;
    if (e.code === 'ShiftLeft') sprint = true;
    if (e.code === 'KeyE') handleInteraction();
    if (e.code === 'KeyM') toggleMap();
    if (e.code === 'Escape') {
      if (state.gadgetActive) closeGadget();
      else if (state.insideLab) exitLab();
    }
  });
  
  document.addEventListener('keyup', (e) => {
    if (e.code === 'KeyW') moveForward = false;
    if (e.code === 'KeyS') moveBackward = false;
    if (e.code === 'KeyA') moveLeft = false;
    if (e.code === 'KeyD') moveRight = false;
    if (e.code === 'ShiftLeft') sprint = false;
  });
  
  document.getElementById('canvas').addEventListener('click', () => {
    if (!state.gadgetActive) controls.lock();
  });
}

function toggleMap() {
  state.mapVisible = !state.mapVisible;
  document.getElementById('miniMap').style.display = state.mapVisible ? 'block' : 'none';
  if (state.mapVisible) drawMiniMap();
  playSound(900, 0.1);
}

function handleInteraction() {
  if (!state.nearInteractable) return;
  const ud = state.nearInteractable.userData;
  
  if (ud.type === 'entrance') {
    enterLab(ud.lab);
  } else if (ud.type === 'exit') {
    exitLab();
  } else if (ud.interactive) {
    controls.unlock();
    state.gadgetActive = true;
    document.getElementById('gadgetUI').style.display = 'block';
    document.getElementById('gadgetTitle').textContent = `${ud.icon} ${ud.name}`;
    document.getElementById('gadgetSubtitle').textContent = ud.desc;
    playSound(800, 0.1);
    
    if (ud.type === 'robot') showRobotBuilder();
    else if (ud.type === 'car') showCarShowroom();
    else if (ud.type === 'mind') showMindUpload();
    else showGenericGadget(ud);
  }
}

function showRobotBuilder() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">HUMANOID ASSEMBLY STATION 2077
Welcome to Robot Builder

BUILD YOUR CUSTOM ROBOT:
Step 1: Select body type</div>
    <div class="optionGrid">
      <div class="option" onclick="selectRobotBody('humanoid')">ü§ñ Humanoid<br><small>Human-like</small></div>
      <div class="option" onclick="selectRobotBody('animal')">üêï Animal<br><small>Pet-like</small></div>
      <div class="option" onclick="selectRobotBody('custom')">‚öôÔ∏è Custom<br><small>Unique design</small></div>
    </div>
  `;
}

window.selectRobotBody = function(body) {
  state.robotBuild.body = body;
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">BODY TYPE: ${body.toUpperCase()}

Step 2: Select size</div>
    <div class="optionGrid">
      <div class="option" onclick="selectRobotSize('small')">Small<br><small>50cm tall</small></div>
      <div class="option" onclick="selectRobotSize('medium')">Medium<br><small>150cm tall</small></div>
      <div class="option" onclick="selectRobotSize('large')">Large<br><small>250cm tall</small></div>
    </div>
  `;
};

window.selectRobotSize = function(size) {
  state.robotBuild.size = size;
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">SIZE: ${size.toUpperCase()}

Step 3: Choose materials</div>
    <div class="optionGrid">
      <div class="option" onclick="selectRobotMaterial('metal')">üî© Metal<br><small>Durable</small></div>
      <div class="option" onclick="selectRobotMaterial('carbon')">‚ö´ Carbon Fiber<br><small>Lightweight</small></div>
      <div class="option" onclick="selectRobotMaterial('bio')">üß¨ Bio-Synthetic<br><small>Organic</small></div>
    </div>
  `;
};

window.selectRobotMaterial = function(material) {
  state.robotBuild.material = material;
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">MATERIAL: ${material.toUpperCase()}

Step 4: Design AI personality</div>
    <div class="optionGrid">
      <div class="option" onclick="selectRobotAI('friendly')">üòä Friendly<br><small>Helpful & kind</small></div>
      <div class="option" onclick="selectRobotAI('professional')">üíº Professional<br><small>Efficient</small></div>
      <div class="option" onclick="selectRobotAI('playful')">üéÆ Playful<br><small>Fun & energetic</small></div>
    </div>
  `;
};

window.selectRobotAI = function(ai) {
  state.robotBuild.ai = ai;
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="buildScreen">AI PERSONALITY: ${ai.toUpperCase()}

BUILDING YOUR ROBOT...

Body: ${state.robotBuild.body}
Size: ${state.robotBuild.size}
Material: ${state.robotBuild.material}
AI: ${state.robotBuild.ai}

ASSEMBLY IN PROGRESS...</div>
    <div class="progress"><div class="progressBar" id="buildProgress"></div></div>
  `;
  
  let progress = 0;
  const interval = setInterval(() => {
    progress += 5;
    document.getElementById('buildProgress').style.width = progress + '%';
    playSound(900 + progress * 8, 0.08);
    
    if (progress >= 100) {
      clearInterval(interval);
      document.getElementById('buildScreen').textContent = `ROBOT BUILD COMPLETE!

Your custom ${state.robotBuild.body} robot is ready!

Specifications:
- Body: ${state.robotBuild.body}
- Size: ${state.robotBuild.size}
- Material: ${state.robotBuild.material}
- AI: ${state.robotBuild.ai}
- Serial: RBT-${Math.floor(Math.random()*10000)}

ROBOT ACTIVATED AND READY TO SERVE!`;
      
      state.xp += 250;
      state.gadgetsUsed++;
      updateHUD();
      notify('‚úì Robot Built Successfully! +250 XP');
      playSound(1600, 0.6);
      setTimeout(closeGadget, 4000);
    }
  }, 120);
};

function showCarShowroom() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">FLYING CAR SHOWROOM 2077
Welcome to the Future of Transportation

SELECT VEHICLE FOR TEST DRIVE:</div>
    <div class="optionGrid">
      <div class="option" onclick="testDriveCar('aerosedan')">üöó AeroSedan<br><small>Family car</small></div>
      <div class="option" onclick="testDriveCar('racer')">üèéÔ∏è Quantum Racer<br><small>Speed demon</small></div>
      <div class="option" onclick="testDriveCar('luxury')">‚ú® Gravity Cruiser<br><small>Luxury</small></div>
    </div>
  `;
}

window.testDriveCar = function(car) {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="driveScreen">VEHICLE: ${car.toUpperCase()}

INITIALIZING VR TEST DRIVE...
Loading city environment...
Calibrating flight controls...
Starting simulation...

CONTROLS:
- Accelerate: W
- Brake: S
- Turn: A/D
- Altitude: Space/Shift

TEST DRIVE IN PROGRESS...</div>
    <div class="progress"><div class="progressBar" id="driveProgress"></div></div>
  `;
  
  let progress = 0;
  const interval = setInterval(() => {
    progress += 4;
    document.getElementById('driveProgress').style.width = progress + '%';
    playSound(850 + progress * 6, 0.08);
    
    if (progress >= 100) {
      clearInterval(interval);
      document.getElementById('driveScreen').textContent = `TEST DRIVE COMPLETE!

Vehicle: ${car.toUpperCase()}
Distance: 45.7 km
Max Speed: 487 km/h
Max Altitude: 1,250 m
Flight Time: 12 minutes

Performance Rating: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

Would you like to purchase this vehicle?
Price: $2,450,000

TEST DRIVE DATA SAVED!`;
      
      state.xp += 200;
      state.gadgetsUsed++;
      updateHUD();
      notify('‚úì Test Drive Complete! +200 XP');
      playSound(1550, 0.5);
      setTimeout(closeGadget, 4000);
    }
  }, 180);
};

function showMindUpload() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">CONSCIOUSNESS UPLOAD CENTER
Digital Immortality System

WARNING: This process will create a digital copy
of your consciousness. Original consciousness
remains in biological body.

UPLOAD PROCESS:
1. Brain scanning (5 min)
2. Neural pattern extraction (10 min)
3. Memory copying (15 min)
4. Personality analysis (8 min)
5. Digital avatar creation (2 min)

Total time: 40 minutes
Success rate: 99.7%

Ready to begin?</div>
    <div style="text-align: center;">
      <button class="actionBtn success" onclick="startMindUpload()">‚ñ∂ BEGIN UPLOAD</button>
    </div>
  `;
}

window.startMindUpload = function() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="uploadScreen">CONSCIOUSNESS UPLOAD IN PROGRESS...

Scanning brain structure...
Mapping 86 billion neurons...
Extracting neural patterns...
Copying memories...
Analyzing personality traits...
Creating digital avatar...

PLEASE REMAIN STILL...</div>
    <div class="progress"><div class="progressBar" id="uploadProgress"></div></div>
  `;
  
  let progress = 0;
  const interval = setInterval(() => {
    progress += 3;
    document.getElementById('uploadProgress').style.width = progress + '%';
    playSound(920 + progress * 7, 0.08);
    
    if (progress >= 100) {
      clearInterval(interval);
      document.getElementById('uploadScreen').textContent = `UPLOAD COMPLETE!

Your consciousness has been successfully
digitized and stored in the cloud.

Digital Avatar ID: MIND-${Math.floor(Math.random()*100000)}
Storage: Quantum Server Array
Backup: 3 redundant copies
Access: Anytime, anywhere

You are now digitally immortal!

Your digital self can:
- Live in virtual worlds
- Access infinite knowledge
- Never age or die
- Merge with other minds
- Experience multiple realities

WELCOME TO DIGITAL EXISTENCE!`;
      
      state.xp += 300;
      state.gadgetsUsed++;
      updateHUD();
      notify('‚úì Consciousness Uploaded! +300 XP');
      playSound(1700, 0.7);
      setTimeout(closeGadget, 5000);
    }
  }, 150);
};

function showGenericGadget(ud) {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="genericScreen">${ud.name.toUpperCase()} INITIALIZED
System ready for operation
All diagnostics passed

Press START to begin process...</div>
    <div class="progress"><div class="progressBar" id="genericProgress"></div></div>
    <div style="text-align: center;">
      <button class="actionBtn success" onclick="startGeneric()">‚ñ∂ START PROCESS</button>
    </div>
  `;
}

window.startGeneric = function() {
  let progress = 0;
  const interval = setInterval(() => {
    progress += 8;
    document.getElementById('genericProgress').style.width = progress + '%';
    playSound(820 + progress * 6, 0.08);
    
    if (progress >= 100) {
      clearInterval(interval);
      document.getElementById('genericScreen').textContent = `PROCESS COMPLETE!

Data collected successfully
Results analyzed and verified
All parameters within normal range

DATA SAVED TO INVENTORY`;
      state.xp += 120;
      state.gadgetsUsed++;
      updateHUD();
      notify('‚úì Process Complete! +120 XP');
      playSound(1350, 0.4);
      setTimeout(closeGadget, 2500);
    }
  }, 250);
};

window.closeGadget = function() {
  state.gadgetActive = false;
  document.getElementById('gadgetUI').style.display = 'none';
  controls.lock();
  playSound(600, 0.1);
};

function checkNearby() {
  raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
  const intersects = raycaster.intersectObjects(interactables, true);
  
  if (intersects.length > 0 && intersects[0].distance < 14) {
    let obj = intersects[0].object;
    while (obj.parent && !obj.userData.interactive && obj.userData.type !== 'entrance' && obj.userData.type !== 'exit') {
      obj = obj.parent;
    }
    state.nearInteractable = obj;
    document.getElementById('interactPrompt').style.display = 'block';
  } else {
    state.nearInteractable = null;
    document.getElementById('interactPrompt').style.display = 'none';
  }
}

function animate() {
  requestAnimationFrame(animate);
  
  const time = performance.now();
  if (controls.isLocked) {
    const delta = (time - prevTime) / 1000;
    
    velocity.x -= velocity.x * 10.0 * delta;
    velocity.z -= velocity.z * 10.0 * delta;
    
    direction.z = Number(moveForward) - Number(moveBackward);
    direction.x = Number(moveRight) - Number(moveLeft);
    direction.normalize();
    
    const speed = sprint ? 100 : 55;
    
    if (moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
    if (moveLeft || moveRight) velocity.x -= direction.x * speed * delta;
    
    controls.moveRight(-velocity.x * delta);
    controls.moveForward(-velocity.z * delta);
    
    checkNearby();
    
    if (state.mapVisible && !state.insideLab) drawMiniMap();
  }
  
  prevTime = time;
  renderer.render(scene, camera);
}

function updateHUD() {
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('xp').textContent = `${state.xp}/${state.xpMax}`;
  document.getElementById('labsVisited').textContent = `${state.labsVisited.size}/29`;
  document.getElementById('gadgetsUsed').textContent = `${state.gadgetsUsed}/500`;
  document.getElementById('currentLocation').textContent = state.insideLab ? `üî¨ ${state.currentLab}` : 'üìç Neo-City 2077';
  
  while (state.xp >= state.xpMax) {
    state.xp -= state.xpMax;
    state.lvl++;
    state.xpMax = Math.floor(state.xpMax * 1.5);
    notify(`üéâ LEVEL UP! Now Level ${state.lvl}!`);
    playSound(1700, 0.6);
  }
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 4500);
}
</script>
</body>
</html>