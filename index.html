<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse: Educational Tech Simulator</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; overflow: hidden; background: #1a1a1a; color: #e0e0e0; }
#canvas { display: block; width: 100vw; height: 100vh; }

#charSelect { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; overflow-y: auto; padding: 20px; z-index: 10000; }
#charSelect h1 { font-size: clamp(2em, 4vw, 3em); color: #ecf0f1; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 20px 0; font-weight: 600; }
.subtitle { font-size: clamp(0.9em, 1.5vw, 1.1em); color: #bdc3c7; margin-bottom: 20px; text-align: center; }
.charGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-width: 1200px; width: 100%; padding: 10px; margin-bottom: 20px; }
.charCard { background: rgba(52, 73, 94, 0.8); border: 2px solid #7f8c8d; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s; text-align: center; min-height: 160px; }
.charCard:hover { background: rgba(52, 73, 94, 1); transform: translateY(-3px); border-color: #95a5a6; }
.charCard.selected { background: rgba(46, 204, 113, 0.3); border-color: #27ae60; }
.charCard .icon { font-size: 2.5em; margin-bottom: 8px; }
.charCard h3 { color: #ecf0f1; font-size: 1.1em; margin: 8px 0; }
.charCard p { color: #95a5a6; font-size: 0.8em; line-height: 1.3; }
#startBtn { padding: 15px 50px; font-size: clamp(1em, 2vw, 1.3em); background: linear-gradient(135deg, #27ae60, #229954); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; margin: 20px 0; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
#startBtn:hover:not(:disabled) { transform: translateY(-2px); }
#startBtn:disabled { opacity: 0.4; cursor: not-allowed; }

#loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(44, 62, 80, 0.95); padding: 40px; border-radius: 10px; border: 2px solid #7f8c8d; z-index: 9999; }
#loading h2 { color: #ecf0f1; font-size: 1.8em; margin-bottom: 15px; }
.spinner { border: 4px solid rgba(127, 140, 141, 0.3); border-top: 4px solid #7f8c8d; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 15px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

#hud { position: fixed; top: 15px; left: 15px; background: rgba(44, 62, 80, 0.95); padding: 20px; border-radius: 8px; border: 2px solid #7f8c8d; min-width: 240px; z-index: 1000; }
#hud h3 { color: #ecf0f1; font-size: 1.2em; margin-bottom: 12px; border-bottom: 2px solid #7f8c8d; padding-bottom: 8px; }
.hudStat { display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.95em; color: #bdc3c7; }
.hudStat .val { color: #27ae60; font-weight: 700; }

#interact { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.98); padding: 30px 40px; border-radius: 10px; border: 2px solid #3498db; max-width: 750px; width: 90%; text-align: center; z-index: 1000; }
#interact h4 { color: #3498db; font-size: 1.8em; margin-bottom: 15px; }
#interact p { color: #bdc3c7; font-size: 1.05em; margin-bottom: 20px; line-height: 1.7; }
.actBtn { padding: 14px 30px; background: linear-gradient(135deg, #3498db, #2980b9); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; margin: 8px; font-size: 1em; transition: all 0.3s; }
.actBtn:hover { transform: translateY(-2px); }

#tutorial { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.95); z-index: 5000; overflow-y: auto; padding: 40px 20px; }
#tutorialContent { max-width: 1000px; margin: 0 auto; background: rgba(44, 62, 80, 0.98); padding: 40px; border-radius: 12px; border: 3px solid #3498db; }
#tutorialContent h2 { color: #3498db; font-size: 2.2em; margin-bottom: 20px; text-align: center; }
.tutSection { background: rgba(52, 73, 94, 0.6); padding: 25px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #27ae60; }
.tutSection h3 { color: #27ae60; font-size: 1.5em; margin-bottom: 15px; }
.tutSection p { color: #ecf0f1; font-size: 1.05em; line-height: 1.8; margin: 10px 0; }
.tutSection ul { margin: 15px 0 15px 30px; }
.tutSection li { color: #bdc3c7; margin: 8px 0; line-height: 1.6; }
.stepBox { background: rgba(41, 128, 185, 0.2); padding: 20px; margin: 15px 0; border-radius: 8px; border: 2px solid #3498db; }
.stepBox h4 { color: #3498db; font-size: 1.3em; margin-bottom: 12px; }
.stepBox p { color: #ecf0f1; line-height: 1.7; }
.highlight { color: #f39c12; font-weight: 600; }
.warning { background: rgba(231, 76, 60, 0.2); padding: 15px; border-left: 4px solid #e74c3c; margin: 15px 0; border-radius: 4px; }
.warning p { color: #e74c3c; font-weight: 600; }
.tutBtn { padding: 15px 40px; background: linear-gradient(135deg, #27ae60, #229954); border: none; border-radius: 8px; color: #fff; font-weight: 700; cursor: pointer; margin: 20px 10px; font-size: 1.1em; }
.tutBtn:hover { transform: translateY(-2px); }
.tutBtn.secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

#experiment { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.95); z-index: 5000; overflow-y: auto; padding: 20px; }
#expContent { max-width: 1200px; margin: 0 auto; background: rgba(44, 62, 80, 0.98); padding: 30px; border-radius: 12px; border: 3px solid #e74c3c; }
#expContent h2 { color: #e74c3c; font-size: 2em; margin-bottom: 20px; text-align: center; }
#expArea { background: rgba(52, 73, 94, 0.8); padding: 30px; border-radius: 10px; min-height: 400px; margin: 20px 0; border: 2px solid #7f8c8d; }
#expInstructions { background: rgba(41, 128, 185, 0.2); padding: 20px; border-radius: 8px; border-left: 4px solid #3498db; margin-bottom: 20px; }
#expInstructions h3 { color: #3498db; margin-bottom: 10px; }
#expInstructions p { color: #ecf0f1; line-height: 1.7; }
.expBtn { padding: 12px 30px; background: linear-gradient(135deg, #e74c3c, #c0392b); border: none; border-radius: 6px; color: #fff; font-weight: 600; cursor: pointer; margin: 10px 5px; font-size: 1em; }
.expBtn:hover { transform: translateY(-2px); }
.expBtn.success { background: linear-gradient(135deg, #27ae60, #229954); }

#controls { position: fixed; bottom: 30px; left: 30px; background: rgba(44, 62, 80, 0.95); padding: 18px; border-radius: 8px; border: 2px solid #7f8c8d; z-index: 1000; }
#controls h4 { color: #ecf0f1; margin-bottom: 10px; font-size: 1.05em; }
.ctrl { color: #bdc3c7; margin: 6px 0; font-size: 0.9em; }
.key { color: #27ae60; font-weight: 700; background: rgba(39, 174, 96, 0.2); padding: 3px 8px; border-radius: 4px; }

#notif { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background: rgba(39, 174, 96, 0.95); color: #fff; padding: 16px 40px; border-radius: 8px; font-weight: 600; font-size: 1.1em; opacity: 0; transition: opacity 0.3s; max-width: 85%; text-align: center; z-index: 2000; }
#notif.show { opacity: 1; }

.hide { display: none !important; }

.component { display: inline-block; padding: 15px 25px; margin: 10px; background: rgba(52, 152, 219, 0.3); border: 2px solid #3498db; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 1.1em; color: #ecf0f1; }
.component:hover { background: rgba(52, 152, 219, 0.5); transform: scale(1.05); }
.component.selected { background: rgba(39, 174, 96, 0.5); border-color: #27ae60; }
.component.placed { opacity: 0.5; cursor: not-allowed; }

#workspace { background: rgba(26, 26, 26, 0.8); border: 3px dashed #7f8c8d; border-radius: 10px; min-height: 300px; padding: 30px; margin: 20px 0; position: relative; }
.wire { position: absolute; height: 3px; background: #e74c3c; transform-origin: left center; }
.connection { width: 20px; height: 20px; background: #f39c12; border-radius: 50%; position: absolute; border: 3px solid #ecf0f1; cursor: pointer; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="charSelect">
  <h1>TechVerse: Educational Tech Simulator</h1>
  <p class="subtitle">Learn real technology through interactive experiments and tutorials</p>
  <div class="charGrid">
    <div class="charCard" data-char="Student"><div class="icon">üéì</div><h3>Student</h3><p>Learn from basics</p></div>
    <div class="charCard" data-char="Researcher"><div class="icon">üî¨</div><h3>Researcher</h3><p>Advanced experiments</p></div>
    <div class="charCard" data-char="Engineer"><div class="icon">‚öôÔ∏è</div><h3>Engineer</h3><p>Build and create</p></div>
    <div class="charCard" data-char="Scientist"><div class="icon">üß™</div><h3>Scientist</h3><p>Discover new tech</p></div>
  </div>
  <button id="startBtn" disabled>Select Role</button>
</div>

<div id="loading" class="hide">
  <h2>Loading Labs...</h2>
  <div class="spinner"></div>
  <p id="loadText">Initializing...</p>
</div>

<div id="hud" class="hide">
  <h3>PROGRESS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>Tutorials:</span><span class="val" id="tutorials">0/10</span></div>
  <div class="hudStat"><span>Experiments:</span><span class="val" id="experiments">0/15</span></div>
  <div class="hudStat"><span>Knowledge:</span><span class="val" id="knowledge">0%</span></div>
</div>

<div id="interact" class="hide">
  <h4 id="intTitle">Location</h4>
  <p id="intDesc">Description</p>
  <div id="intBtns"></div>
</div>

<div id="tutorial" class="hide">
  <div id="tutorialContent"></div>
</div>

<div id="experiment" class="hide">
  <div id="expContent"></div>
</div>

<div id="controls" class="hide">
  <h4>CONTROLS</h4>
  <div class="ctrl"><span class="key">WASD</span> Move</div>
  <div class="ctrl"><span class="key">MOUSE</span> Look</div>
  <div class="ctrl"><span class="key">E</span> Interact</div>
</div>

<div id="notif"></div>

<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"}}</script>
<script type="module">
import * as THREE from 'three';

const state = {
  char: null,
  lvl: 1,
  tutorialsCompleted: 0,
  experimentsCompleted: 0,
  knowledge: 0,
  currentExperiment: null
};

const tutorials = {
  quantum: {
    title: 'Quantum Computing Basics',
    sections: [
      {
        title: 'What is Quantum Computing?',
        content: 'Quantum computers use quantum bits (qubits) instead of classical bits. While classical bits can be either 0 or 1, qubits can exist in a superposition of both states simultaneously.',
        points: [
          'Classical bit: Either 0 OR 1',
          'Qubit: Can be 0 AND 1 at the same time (superposition)',
          'This allows quantum computers to process multiple possibilities simultaneously',
          'Quantum computers excel at optimization, cryptography, and simulation problems'
        ]
      },
      {
        title: 'Key Quantum Concepts',
        content: 'Understanding these fundamental principles is essential:',
        points: [
          '<span class="highlight">Superposition:</span> A qubit can be in multiple states at once',
          '<span class="highlight">Entanglement:</span> Qubits can be correlated - measuring one instantly affects the other',
          '<span class="highlight">Quantum Gates:</span> Operations that manipulate qubits (like Hadamard, CNOT, Pauli gates)',
          '<span class="highlight">Measurement:</span> Observing a qubit collapses it to either 0 or 1'
        ]
      },
      {
        title: 'Building a Quantum Circuit',
        steps: [
          'Step 1: Initialize qubits in |0‚ü© state',
          'Step 2: Apply Hadamard gate to create superposition',
          'Step 3: Apply CNOT gate to create entanglement',
          'Step 4: Measure the qubits to get results',
          'Step 5: Repeat many times to see probability distribution'
        ]
      }
    ]
  },
  circuit: {
    title: 'Building Electronic Circuits',
    sections: [
      {
        title: 'Circuit Basics',
        content: 'An electronic circuit is a closed path that allows electricity to flow. Understanding the components is crucial:',
        points: [
          '<span class="highlight">Power Source:</span> Provides voltage (battery, power supply)',
          '<span class="highlight">Conductors:</span> Wires that carry current',
          '<span class="highlight">Resistors:</span> Control current flow, measured in Ohms (Œ©)',
          '<span class="highlight">LEDs:</span> Light Emitting Diodes that emit light when current flows'
        ]
      },
      {
        title: 'Ohm\'s Law',
        content: 'The fundamental relationship in circuits: V = I √ó R',
        points: [
          'V (Voltage) = Electrical pressure, measured in Volts (V)',
          'I (Current) = Flow of electrons, measured in Amperes (A)',
          'R (Resistance) = Opposition to flow, measured in Ohms (Œ©)',
          'Example: 9V battery with 450Œ© resistor = 0.02A (20mA) current'
        ]
      },
      {
        title: 'Building Your First Circuit',
        steps: [
          'Step 1: Gather components - battery, resistor, LED, wires',
          'Step 2: Connect positive (+) terminal of battery to resistor',
          'Step 3: Connect resistor to long leg of LED (anode/positive)',
          'Step 4: Connect short leg of LED (cathode/negative) to battery negative (-)',
          'Step 5: LED should light up! If not, check connections'
        ],
        warning: 'Always use a resistor with LEDs to prevent burning them out!'
      }
    ]
  },
  dna: {
    title: 'DNA Sequencing & Gene Editing',
    sections: [
      {
        title: 'Understanding DNA',
        content: 'DNA (Deoxyribonucleic Acid) is the blueprint of life, containing instructions for building proteins.',
        points: [
          'DNA is made of 4 bases: A (Adenine), T (Thymine), G (Guanine), C (Cytosine)',
          'Bases pair specifically: A with T, G with C',
          'DNA is a double helix - two strands twisted together',
          'Genes are segments of DNA that code for specific proteins'
        ]
      },
      {
        title: 'CRISPR-Cas9 Gene Editing',
        content: 'CRISPR is a revolutionary tool that allows precise editing of DNA:',
        points: [
          '<span class="highlight">Guide RNA:</span> Directs Cas9 to specific DNA location',
          '<span class="highlight">Cas9 Enzyme:</span> Acts as molecular scissors to cut DNA',
          '<span class="highlight">DNA Repair:</span> Cell repairs cut, allowing insertion/deletion',
          '<span class="highlight">Applications:</span> Cure genetic diseases, improve crops, research'
        ]
      },
      {
        title: 'Performing Gene Editing',
        steps: [
          'Step 1: Design guide RNA to target specific gene sequence',
          'Step 2: Synthesize guide RNA and Cas9 enzyme',
          'Step 3: Deliver CRISPR system into cells (viral vector or electroporation)',
          'Step 4: Guide RNA finds target DNA sequence',
          'Step 5: Cas9 cuts DNA at precise location',
          'Step 6: Cell repairs DNA, incorporating desired changes'
        ]
      }
    ]
  },
  neural: {
    title: 'Neural Networks & AI',
    sections: [
      {
        title: 'How Neural Networks Work',
        content: 'Artificial neural networks are inspired by the human brain:',
        points: [
          '<span class="highlight">Neurons:</span> Basic units that process information',
          '<span class="highlight">Layers:</span> Input layer, hidden layers, output layer',
          '<span class="highlight">Weights:</span> Connections between neurons with varying strengths',
          '<span class="highlight">Activation:</span> Functions that determine neuron output (ReLU, Sigmoid)'
        ]
      },
      {
        title: 'Training a Neural Network',
        content: 'Networks learn by adjusting weights based on errors:',
        points: [
          'Forward Pass: Input data flows through network to produce output',
          'Loss Calculation: Compare output to correct answer',
          'Backpropagation: Calculate how to adjust weights',
          'Gradient Descent: Update weights to reduce error',
          'Repeat thousands of times until network is accurate'
        ]
      },
      {
        title: 'Building Your First AI',
        steps: [
          'Step 1: Prepare training data (images, text, numbers)',
          'Step 2: Design network architecture (number of layers, neurons)',
          'Step 3: Initialize random weights',
          'Step 4: Feed training data through network',
          'Step 5: Calculate loss and backpropagate errors',
          'Step 6: Update weights using optimizer (Adam, SGD)',
          'Step 7: Repeat until network achieves desired accuracy'
        ]
      }
    ]
  }
};

const experiments = {
  buildCircuit: {
    title: 'Build a Simple LED Circuit',
    description: 'Connect components to light up an LED',
    components: ['Battery (9V)', 'Resistor (470Œ©)', 'LED (Red)', 'Wire 1', 'Wire 2'],
    steps: [
      'Drag the Battery to the workspace',
      'Connect Wire 1 from Battery + to Resistor',
      'Connect Resistor to LED + (long leg)',
      'Connect LED - (short leg) to Wire 2',
      'Connect Wire 2 to Battery -',
      'Circuit complete! LED should light up'
    ]
  },
  quantumGate: {
    title: 'Apply Quantum Gates',
    description: 'Create quantum superposition and entanglement',
    components: ['Qubit 1', 'Qubit 2', 'Hadamard Gate', 'CNOT Gate', 'Measurement'],
    steps: [
      'Initialize Qubit 1 in |0‚ü© state',
      'Apply Hadamard gate to Qubit 1 (creates superposition)',
      'Initialize Qubit 2 in |0‚ü© state',
      'Apply CNOT gate with Qubit 1 as control, Qubit 2 as target',
      'Measure both qubits',
      'You\'ve created an entangled Bell state!'
    ]
  },
  editGene: {
    title: 'CRISPR Gene Editing Simulation',
    description: 'Edit a DNA sequence using CRISPR-Cas9',
    components: ['DNA Strand', 'Guide RNA', 'Cas9 Enzyme', 'Repair Template'],
    steps: [
      'Select target gene sequence on DNA',
      'Design guide RNA to match target',
      'Attach Cas9 enzyme to guide RNA',
      'Guide RNA binds to target DNA',
      'Cas9 cuts both DNA strands',
      'Insert repair template with desired sequence',
      'Cell repairs DNA with new sequence'
    ]
  },
  trainAI: {
    title: 'Train a Simple Neural Network',
    description: 'Teach AI to recognize patterns',
    components: ['Input Layer', 'Hidden Layer', 'Output Layer', 'Training Data'],
    steps: [
      'Load training dataset (images of cats and dogs)',
      'Feed image through input layer',
      'Process through hidden layers',
      'Get prediction from output layer',
      'Calculate error (how wrong was prediction)',
      'Backpropagate error through network',
      'Adjust weights to improve accuracy',
      'Repeat with more images until accurate'
    ]
  }
};

let scene, camera, renderer, buildings = [], curInteract = null;
let moveF = false, moveB = false, moveL = false, moveR = false;
const vel = new THREE.Vector3(), dir = new THREE.Vector3(), clock = new THREE.Clock();

const locations = {
  quantum: { name: 'Quantum Computing Lab', pos: [-100, 0, -100], color: 0x5a6c7d, size: 40, height: 70 },
  electronics: { name: 'Electronics Workshop', pos: [100, 0, -100], color: 0x6b8e7f, size: 40, height: 65 },
  biotech: { name: 'Biotech Laboratory', pos: [-100, 0, 100], color: 0x7d6b5a, size: 40, height: 68 },
  ai: { name: 'AI Research Center', pos: [100, 0, 100], color: 0x5a7d8e, size: 40, height: 72 },
  library: { name: 'Knowledge Library', pos: [0, 0, 0], color: 0x6d7d8e, size: 50, height: 60 }
};

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);
  scene.fog = new THREE.Fog(0x87CEEB, 100, 800);

  camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  camera.position.set(0, 5, 30);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);

  const sun = new THREE.DirectionalLight(0xffffff, 1.2);
  sun.position.set(200, 400, 200);
  sun.castShadow = true;
  scene.add(sun);

  createWorld();
  setupControls();
  animate();
  updateHUD();

  notify('Welcome! Visit labs to learn real technology through interactive tutorials.');
}

function createWorld() {
  const groundGeo = new THREE.PlaneGeometry(1000, 1000);
  const groundMat = new THREE.MeshStandardMaterial({ color: 0x3d5a3d, roughness: 0.9 });
  const ground = new THREE.Mesh(groundGeo, groundMat);
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);

  Object.entries(locations).forEach(([id, loc]) => {
    createBuilding(loc.pos[0], loc.pos[1], loc.pos[2], loc.size, loc.height, loc.size, loc.color, loc.name, id);
  });
}

function createBuilding(x, y, z, w, h, d, color, name, id) {
  const bldgGeo = new THREE.BoxGeometry(w, h, d);
  const bldgMat = new THREE.MeshStandardMaterial({ color, roughness: 0.7, metalness: 0.3 });
  const bldg = new THREE.Mesh(bldgGeo, bldgMat);
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  bldg.userData = { type: 'building', id, name };
  scene.add(bldg);
  buildings.push(bldg);

  createLabel(name, x, h + 12, z, 2.5);
}

function createLabel(text, x, y, z, scale = 1) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 1024;
  canvas.height = 256;
  ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
  ctx.fillRect(0, 0, 1024, 256);
  ctx.strokeStyle = '#7f8c8d';
  ctx.lineWidth = 4;
  ctx.strokeRect(10, 10, 1004, 236);
  ctx.font = 'Bold 70px Arial';
  ctx.fillStyle = '#ecf0f1';
  ctx.textAlign = 'center';
  ctx.fillText(text, 512, 128);
  
  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.position.set(x, y, z);
  sprite.scale.set(30 * scale, 7.5 * scale, 1);
  scene.add(sprite);
}

function setupControls() {
  addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  addEventListener('keydown', e => {
    if (e.code === 'KeyW') moveF = true;
    if (e.code === 'KeyS') moveB = true;
    if (e.code === 'KeyA') moveL = true;
    if (e.code === 'KeyD') moveR = true;
    if (e.code === 'KeyE' && curInteract) interact();
  });

  addEventListener('keyup', e => {
    if (e.code === 'KeyW') moveF = false;
    if (e.code === 'KeyS') moveB = false;
    if (e.code === 'KeyA') moveL = false;
    if (e.code === 'KeyD') moveR = false;
  });

  addEventListener('mousemove', e => {
    if (document.pointerLockElement === document.body) {
      camera.rotation.y -= (e.movementX || 0) * 0.002;
      camera.rotation.x -= (e.movementY || 0) * 0.002;
      camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
    }
  });

  document.body.addEventListener('click', () => {
    if (!document.getElementById('charSelect').classList.contains('hide')) return;
    document.body.requestPointerLock();
  });
}

function animate() {
  requestAnimationFrame(animate);
  const delta = clock.getDelta();

  vel.x -= vel.x * 10 * delta;
  vel.z -= vel.z * 10 * delta;
  dir.z = Number(moveF) - Number(moveB);
  dir.x = Number(moveR) - Number(moveL);
  dir.normalize();

  if (moveF || moveB) vel.z -= dir.z * 70 * delta;
  if (moveL || moveR) vel.x -= dir.x * 70 * delta;

  camera.position.x += vel.x * delta;
  camera.position.z += vel.z * delta;

  checkNearby();
  renderer.render(scene, camera);
}

function checkNearby() {
  let nearest = null, minDist = 35;
  
  buildings.forEach(bldg => {
    const dist = camera.position.distanceTo(bldg.position);
    if (dist < minDist) { minDist = dist; nearest = bldg; }
  });

  if (nearest && nearest !== curInteract) { curInteract = nearest; showInteract(); }
  else if (!nearest && curInteract) { curInteract = null; hideInteract(); }
}

function showInteract() {
  document.getElementById('intTitle').textContent = curInteract.userData.name;
  document.getElementById('intDesc').textContent = 'Learn real technology through interactive tutorials and experiments.';
  
  const btns = document.getElementById('intBtns');
  btns.innerHTML = '';
  
  const tutBtn = document.createElement('button');
  tutBtn.className = 'actBtn';
  tutBtn.textContent = 'START TUTORIAL';
  tutBtn.onclick = () => startTutorial(curInteract.userData.id);
  btns.appendChild(tutBtn);
  
  const expBtn = document.createElement('button');
  expBtn.className = 'actBtn';
  expBtn.textContent = 'DO EXPERIMENT';
  expBtn.onclick = () => startExperiment(curInteract.userData.id);
  btns.appendChild(expBtn);
  
  const closeBtn = document.createElement('button');
  closeBtn.className = 'actBtn';
  closeBtn.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
  closeBtn.textContent = 'EXIT';
  closeBtn.onclick = hideInteract;
  btns.appendChild(closeBtn);
  
  document.getElementById('interact').classList.remove('hide');
}

function hideInteract() {
  document.getElementById('interact').classList.add('hide');
}

function interact() {}

function startTutorial(labId) {
  hideInteract();
  const tutMap = { quantum: 'quantum', electronics: 'circuit', biotech: 'dna', ai: 'neural' };
  const tut = tutorials[tutMap[labId]];
  if (!tut) return;
  
  let html = `<h2>${tut.title}</h2>`;
  
  tut.sections.forEach(section => {
    html += `<div class="tutSection">`;
    html += `<h3>${section.title}</h3>`;
    html += `<p>${section.content}</p>`;
    
    if (section.points) {
      html += `<ul>`;
      section.points.forEach(point => {
        html += `<li>${point}</li>`;
      });
      html += `</ul>`;
    }
    
    if (section.steps) {
      section.steps.forEach((step, i) => {
        html += `<div class="stepBox">`;
        html += `<h4>Step ${i + 1}</h4>`;
        html += `<p>${step}</p>`;
        html += `</div>`;
      });
    }
    
    if (section.warning) {
      html += `<div class="warning"><p>‚ö†Ô∏è ${section.warning}</p></div>`;
    }
    
    html += `</div>`;
  });
  
  html += `<div style="text-align: center;">`;
  html += `<button class="tutBtn" onclick="window.completeTutorial()">COMPLETE TUTORIAL</button>`;
  html += `<button class="tutBtn secondary" onclick="window.closeTutorial()">CLOSE</button>`;
  html += `</div>`;
  
  document.getElementById('tutorialContent').innerHTML = html;
  document.getElementById('tutorial').classList.remove('hide');
}

window.completeTutorial = function() {
  state.tutorialsCompleted++;
  state.knowledge += 10;
  updateHUD();
  notify('‚úÖ Tutorial completed! +10% Knowledge');
  window.closeTutorial();
};

window.closeTutorial = function() {
  document.getElementById('tutorial').classList.add('hide');
};

function startExperiment(labId) {
  hideInteract();
  const expMap = { quantum: 'quantumGate', electronics: 'buildCircuit', biotech: 'editGene', ai: 'trainAI' };
  const exp = experiments[expMap[labId]];
  if (!exp) return;
  
  state.currentExperiment = { ...exp, currentStep: 0, componentsPlaced: [] };
  
  let html = `<h2>${exp.title}</h2>`;
  html += `<div id="expInstructions">`;
  html += `<h3>Instructions</h3>`;
  html += `<p>${exp.description}</p>`;
  html += `<p><strong>Current Step:</strong> <span id="currentStep">${exp.steps[0]}</span></p>`;
  html += `</div>`;
  
  html += `<div id="expArea">`;
  html += `<h3 style="color: #ecf0f1; margin-bottom: 20px;">Components</h3>`;
  html += `<div id="components">`;
  exp.components.forEach((comp, i) => {
    html += `<div class="component" onclick="window.selectComponent(${i})">${comp}</div>`;
  });
  html += `</div>`;
  html += `<div id="workspace"><p style="color: #95a5a6; text-align: center; padding: 50px;">Click components above to place them here</p></div>`;
  html += `</div>`;
  
  html += `<div style="text-align: center; margin-top: 20px;">`;
  html += `<button class="expBtn success" onclick="window.nextStep()">NEXT STEP</button>`;
  html += `<button class="expBtn" onclick="window.closeExperiment()">EXIT</button>`;
  html += `</div>`;
  
  document.getElementById('expContent').innerHTML = html;
  document.getElementById('experiment').classList.remove('hide');
}

window.selectComponent = function(index) {
  const exp = state.currentExperiment;
  if (!exp) return;
  
  if (!exp.componentsPlaced.includes(index)) {
    exp.componentsPlaced.push(index);
    const workspace = document.getElementById('workspace');
    if (exp.componentsPlaced.length === 1) {
      workspace.innerHTML = '';
    }
    const comp = document.createElement('div');
    comp.className = 'component placed';
    comp.textContent = exp.components[index];
    comp.style.margin = '10px';
    workspace.appendChild(comp);
    
    document.querySelectorAll('.component')[index].classList.add('placed');
    notify(`Added: ${exp.components[index]}`);
  }
};

window.nextStep = function() {
  const exp = state.currentExperiment;
  if (!exp) return;
  
  exp.currentStep++;
  if (exp.currentStep >= exp.steps.length) {
    state.experimentsCompleted++;
    state.knowledge += 15;
    updateHUD();
    notify('üéâ Experiment completed! +15% Knowledge');
    window.closeExperiment();
  } else {
    document.getElementById('currentStep').textContent = exp.steps[exp.currentStep];
    notify(`Step ${exp.currentStep + 1}/${exp.steps.length}`);
  }
};

window.closeExperiment = function() {
  document.getElementById('experiment').classList.add('hide');
  state.currentExperiment = null;
};

function updateHUD() {
  document.getElementById('role').textContent = state.char || '-';
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('tutorials').textContent = `${state.tutorialsCompleted}/10`;
  document.getElementById('experiments').textContent = `${state.experimentsCompleted}/15`;
  document.getElementById('knowledge').textContent = `${state.knowledge}%`;
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 3500);
}

let selChar = null;
document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selChar = card.dataset.char;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'START LEARNING';
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!selChar) return;
  state.char = selChar;
  document.getElementById('charSelect').classList.add('hide');
  document.getElementById('loading').classList.remove('hide');
  
  const msgs = ['Loading labs...', 'Preparing tutorials...', 'Setting up experiments...', 'Ready!'];
  let i = 0;
  const interval = setInterval(() => {
    document.getElementById('loadText').textContent = msgs[i++];
    if (i >= msgs.length) {
      clearInterval(interval);
      document.getElementById('loading').classList.add('hide');
      document.getElementById('hud').classList.remove('hide');
      document.getElementById('controls').classList.remove('hide');
      init();
    }
  }, 600);
});
</script>
</body>
</html>