<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse: Innovation Odyssey</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; color: #fff; }
#canvas { display: block; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }

/* Character Selection - FULLY RESPONSIVE */
#charSelect { 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100vw; 
  height: 100vh; 
  background: linear-gradient(135deg, #000428 0%, #004e92 100%); 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  justify-content: flex-start;
  overflow-y: auto; 
  padding: 20px;
  z-index: 10000;
}

#charSelect h1 { 
  font-size: clamp(1.8em, 4vw, 3.5em); 
  color: #0ff; 
  text-shadow: 0 0 30px #0ff; 
  margin: 20px 0 10px 0; 
  animation: glow 2s infinite; 
  text-align: center;
}

@keyframes glow { 
  0%, 100% { text-shadow: 0 0 20px #0ff; } 
  50% { text-shadow: 0 0 50px #0ff; } 
}

.subtitle { 
  font-size: clamp(0.9em, 1.5vw, 1.2em); 
  color: #aaa; 
  margin-bottom: 20px; 
  text-align: center; 
  padding: 0 10px;
}

.charGrid { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
  gap: 15px; 
  max-width: 1200px; 
  width: 100%; 
  padding: 10px;
  margin-bottom: 20px;
}

.charCard { 
  background: rgba(0, 255, 255, 0.15); 
  border: 2px solid #0ff; 
  border-radius: 12px; 
  padding: 15px; 
  cursor: pointer; 
  transition: all 0.3s; 
  text-align: center;
  min-height: 180px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.charCard:hover { 
  background: rgba(0, 255, 255, 0.3); 
  transform: translateY(-5px); 
  box-shadow: 0 8px 30px rgba(0, 255, 255, 0.5); 
}

.charCard.selected { 
  background: rgba(0, 255, 0, 0.3); 
  border-color: #0f0; 
  box-shadow: 0 0 40px rgba(0, 255, 0, 0.7); 
}

.charCard .icon { font-size: 3em; margin-bottom: 10px; }
.charCard h3 { color: #0ff; font-size: 1.2em; margin: 10px 0; }
.charCard p { color: #aaa; font-size: 0.85em; line-height: 1.4; }

#startBtn { 
  padding: 15px 50px; 
  font-size: clamp(1em, 2vw, 1.3em); 
  background: linear-gradient(135deg, #0ff, #0f0); 
  border: none; 
  border-radius: 12px; 
  color: #000; 
  font-weight: bold; 
  cursor: pointer; 
  margin: 20px 0; 
  transition: all 0.3s; 
  text-transform: uppercase; 
  letter-spacing: 2px;
}

#startBtn:hover:not(:disabled) { 
  transform: scale(1.05); 
  box-shadow: 0 8px 40px rgba(0, 255, 255, 0.7); 
}

#startBtn:disabled { opacity: 0.3; cursor: not-allowed; }

/* Loading */
#loading { 
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  text-align: center; 
  background: rgba(0, 0, 0, 0.95); 
  padding: 40px; 
  border-radius: 15px; 
  border: 3px solid #0ff;
  z-index: 9999;
}

#loading h2 { color: #0ff; font-size: 1.8em; margin-bottom: 15px; }
.spinner { 
  border: 4px solid rgba(0, 255, 255, 0.3); 
  border-top: 4px solid #0ff; 
  border-radius: 50%; 
  width: 60px; 
  height: 60px; 
  animation: spin 1s linear infinite; 
  margin: 15px auto; 
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#loadText { color: #aaa; font-size: 1em; margin-top: 10px; }

/* HUD */
#hud { 
  position: fixed; 
  top: 15px; 
  left: 15px; 
  background: rgba(0, 0, 0, 0.9); 
  padding: 20px; 
  border-radius: 12px; 
  border: 2px solid #0ff; 
  min-width: 240px;
  z-index: 1000;
}

#hud h3 { color: #0ff; font-size: 1.2em; margin-bottom: 12px; border-bottom: 2px solid #0ff; padding-bottom: 8px; }
.hudStat { display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.95em; color: #aaa; }
.hudStat .val { color: #0f0; font-weight: bold; }

/* Inventory */
#inventory { 
  position: fixed; 
  top: 15px; 
  right: 15px; 
  background: rgba(0, 0, 0, 0.9); 
  padding: 20px; 
  border-radius: 12px; 
  border: 2px solid #f80; 
  max-width: 320px; 
  max-height: 70vh; 
  overflow-y: auto;
  z-index: 1000;
}

#inventory h3 { color: #f80; font-size: 1.2em; margin-bottom: 12px; border-bottom: 2px solid #f80; padding-bottom: 8px; }
.invItem { background: rgba(255, 136, 0, 0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border: 2px solid #f80; }
.invName { color: #0ff; font-weight: bold; font-size: 1em; margin-bottom: 5px; }
.invDesc { color: #888; font-size: 0.85em; margin-bottom: 8px; line-height: 1.4; }
.invBtn { padding: 8px 15px; background: #0ff; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-size: 0.85em; }
.invBtn:hover { background: #0f0; transform: scale(1.05); }

/* Interaction */
#interact { 
  position: fixed; 
  bottom: 20px; 
  left: 50%; 
  transform: translateX(-50%); 
  background: rgba(0, 0, 0, 0.95); 
  padding: 25px 35px; 
  border-radius: 15px; 
  border: 3px solid #0ff; 
  max-width: 650px; 
  width: 90%; 
  text-align: center;
  z-index: 1000;
}

#interact h4 { color: #0ff; font-size: 1.6em; margin-bottom: 12px; }
#interact p { color: #aaa; font-size: 1em; margin-bottom: 15px; line-height: 1.6; }
.actBtn { padding: 12px 28px; background: linear-gradient(135deg, #0ff, #08f); border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer; margin: 6px; font-size: 1em; text-transform: uppercase; }
.actBtn:hover { transform: scale(1.08); box-shadow: 0 5px 20px rgba(0, 255, 255, 0.6); }

/* Controls */
#controls { 
  position: fixed; 
  bottom: 20px; 
  right: 20px; 
  background: rgba(0, 0, 0, 0.9); 
  padding: 15px; 
  border-radius: 10px; 
  border: 2px solid #0ff;
  z-index: 1000;
}

#controls h4 { color: #0ff; margin-bottom: 8px; font-size: 1em; }
.ctrl { color: #aaa; margin: 6px 0; font-size: 0.9em; }
.key { color: #0f0; font-weight: bold; background: rgba(0, 255, 0, 0.2); padding: 3px 8px; border-radius: 4px; margin-right: 5px; }

/* Notification */
#notif { 
  position: fixed; 
  top: 100px; 
  left: 50%; 
  transform: translateX(-50%); 
  background: rgba(0, 255, 0, 0.95); 
  color: #000; 
  padding: 15px 35px; 
  border-radius: 12px; 
  font-weight: bold; 
  font-size: 1.1em; 
  opacity: 0; 
  transition: opacity 0.3s; 
  max-width: 85%; 
  text-align: center; 
  z-index: 2000;
}

#notif.show { opacity: 1; }

/* VR Mode */
#vrMode { 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: linear-gradient(135deg, #001a33 0%, #003366 100%); 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  justify-content: center;
  z-index: 9999;
}

#vrMode h2 { color: #0ff; font-size: 2.5em; margin-bottom: 15px; text-shadow: 0 0 40px #0ff; animation: pulse 2s infinite; }
#vrMode p { color: #aaa; font-size: 1.2em; margin: 10px 0; }
.vrBtn { padding: 15px 40px; background: #0ff; border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer; margin-top: 25px; font-size: 1.1em; }
.vrBtn:hover { background: #0f0; transform: scale(1.05); }

.hide { display: none !important; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.5); }
::-webkit-scrollbar-thumb { background: #0ff; border-radius: 4px; }

@media (max-width: 768px) {
  .charGrid { grid-template-columns: 1fr; gap: 12px; }
  #hud, #inventory, #controls { font-size: 0.9em; padding: 15px; }
  #interact { padding: 20px; }
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="charSelect">
  <h1>üöÄ TechVerse: Innovation Odyssey</h1>
  <p class="subtitle">Choose your role and explore the high-tech cyberpunk city</p>
  <div class="charGrid">
    <div class="charCard" data-char="netrunner"><div class="icon">üíª</div><h3>Netrunner</h3><p>Elite hacker, VR specialist</p></div>
    <div class="charCard" data-char="bioengineer"><div class="icon">üß¨</div><h3>Bioengineer</h3><p>Gene editing expert</p></div>
    <div class="charCard" data-char="quantum"><div class="icon">‚öõÔ∏è</div><h3>Quantum Physicist</h3><p>Reality manipulator</p></div>
    <div class="charCard" data-char="neurohacker"><div class="icon">üß†</div><h3>Neurohacker</h3><p>Mind engineer</p></div>
    <div class="charCard" data-char="nanoengineer"><div class="icon">üî¨</div><h3>Nanoengineer</h3><p>Atomic builder</p></div>
    <div class="charCard" data-char="aiarchitect"><div class="icon">ü§ñ</div><h3>AI Architect</h3><p>Synthetic mind creator</p></div>
    <div class="charCard" data-char="spacesystems"><div class="icon">üöÄ</div><h3>Space Engineer</h3><p>Orbital specialist</p></div>
    <div class="charCard" data-char="fusionengineer"><div class="icon">‚ö°</div><h3>Fusion Engineer</h3><p>Energy pioneer</p></div>
  </div>
  <button id="startBtn" disabled>Select a Character</button>
</div>

<div id="loading" class="hide">
  <h2>Initializing TechVerse...</h2>
  <div class="spinner"></div>
  <p id="loadText">Loading...</p>
</div>

<div id="hud" class="hide">
  <h3>‚ö° STATUS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>XP:</span><span class="val" id="xp">0/100</span></div>
  <div class="hudStat"><span>Rep:</span><span class="val" id="rep">0</span></div>
  <div class="hudStat"><span>Fund:</span><span class="val" id="fund">$250K</span></div>
  <div class="hudStat"><span>Tech:</span><span class="val" id="techOwned">0</span></div>
</div>

<div id="inventory" class="hide">
  <h3>üîß INVENTORY</h3>
  <div id="invList"></div>
</div>

<div id="interact" class="hide">
  <h4 id="intTitle">Tech</h4>
  <p id="intDesc">Description</p>
  <div id="intBtns"></div>
</div>

<div id="controls" class="hide">
  <h4>CONTROLS</h4>
  <div class="ctrl"><span class="key">WASD</span> Move</div>
  <div class="ctrl"><span class="key">MOUSE</span> Look</div>
  <div class="ctrl"><span class="key">E</span> Interact</div>
  <div class="ctrl"><span class="key">SHIFT</span> Sprint</div>
</div>

<div id="vrMode" class="hide">
  <h2>ü•Ω VR ACTIVE</h2>
  <p>Neural link established</p>
  <p style="color:#0f0">Sensory override engaged</p>
  <button class="vrBtn" onclick="window.exitVR()">DISCONNECT</button>
</div>

<div id="notif"></div>

<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"}}</script>
<script type="module">
import * as THREE from 'three';

const state = { char: null, lvl: 1, xp: 0, xpMax: 100, rep: 0, fund: 250000, inventory: [], inVR: false, sprint: false };

const techs = {
  vr: { name: 'VR Headset', cost: 15000, desc: 'Full immersion VR with haptic feedback', effect: 'Enter VR mode', color: 0x00ffff },
  quantum: { name: 'Quantum Computer', cost: 90000, desc: 'Quantum processor - solve impossible problems', effect: '+120 Rep, +$70k, +150 XP', color: 0xff00ff },
  neural: { name: 'Neural Interface', cost: 150000, desc: 'Brain-computer interface', effect: '+100 Rep, +200 XP', color: 0x00ff00 },
  ar: { name: 'AR Glasses', cost: 20000, desc: 'Mixed reality display', effect: '+70 Rep, +90 XP', color: 0xffff00 },
  nanobot: { name: 'Nanobots', cost: 180000, desc: 'Molecular machines', effect: '+250 Rep, +$90k, +220 XP', color: 0xff8800 },
  fusion: { name: 'Fusion Reactor', cost: 400000, desc: 'Unlimited clean energy', effect: '+400 Rep, +$700k, +350 XP', color: 0xff4400 },
  ai: { name: 'AGI Core', cost: 70000, desc: 'Superintelligent AI', effect: '+90 Rep, +170 XP', color: 0xff0088 },
  crispr: { name: 'CRISPR Lab', cost: 110000, desc: 'Gene editing suite', effect: '+180 Rep, +$60k, +200 XP', color: 0x00ff88 }
};

let scene, camera, renderer, techObjs = [], curInteract = null;
let moveF = false, moveB = false, moveL = false, moveR = false;
const vel = new THREE.Vector3(), dir = new THREE.Vector3(), clock = new THREE.Clock();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000510);
  scene.fog = new THREE.Fog(0x000510, 50, 500);

  camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  camera.position.set(0, 3, 20);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;

  // Lights
  scene.add(new THREE.AmbientLight(0x404060, 0.8));
  const sun = new THREE.DirectionalLight(0xffffff, 1.5);
  sun.position.set(80, 150, 80);
  sun.castShadow = true;
  scene.add(sun);

  // Neon city lights
  addLight(-40, 15, -80, 0x00ffff, 3);
  addLight(40, 15, -80, 0xff00ff, 3);
  addLight(-70, 15, 40, 0x00ff00, 3);
  addLight(70, 15, 40, 0xff8800, 3);
  addLight(0, 15, 80, 0x0088ff, 3);
  addLight(-80, 20, 0, 0xff4400, 3.5);
  addLight(80, 20, 0, 0x4400ff, 3.5);

  createCity();
  setupControls();
  animate();
  updateHUD();
  updateInv();

  notify('Welcome to TechVerse! Explore the cyberpunk city!');
  setTimeout(() => notify('Walk to glowing tech and press E!'), 4000);
}

function addLight(x, y, z, color, intensity) {
  const light = new THREE.PointLight(color, intensity, 100);
  light.position.set(x, y, z);
  scene.add(light);
  
  const glow = new THREE.Mesh(
    new THREE.SphereGeometry(1, 16, 16),
    new THREE.MeshBasicMaterial({ color })
  );
  glow.position.set(x, y, z);
  scene.add(glow);
}

function createCity() {
  // Ground - cyberpunk street
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(600, 600),
    new THREE.MeshStandardMaterial({ color: 0x0a0a1e, roughness: 0.8 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);

  // Grid roads
  const grid = new THREE.GridHelper(600, 120, 0x00ffff, 0x003344);
  scene.add(grid);

  // CYBERPUNK SKYSCRAPERS
  createSkyscraper(-45, 0, -90, 25, 60, 25, 0x16213e, 'QUANTUM TOWER');
  createSkyscraper(45, 0, -90, 25, 70, 25, 0x1a1a2e, 'AI NEXUS');
  createSkyscraper(-75, 0, 40, 35, 50, 35, 0x0f3460, 'BIOTECH SPIRE');
  createSkyscraper(75, 0, 40, 30, 60, 30, 0x16213e, 'NANOTECH HQ');
  createSkyscraper(0, 0, 90, 40, 40, 40, 0x1a2e1a, 'YOUR PENTHOUSE');
  createSkyscraper(-85, 0, 0, 22, 80, 22, 0x2e1a1a, 'FUSION CORE');
  createSkyscraper(85, 0, 0, 22, 75, 22, 0x1a1a3e, 'SPACE STATION');
  createSkyscraper(0, 0, -45, 28, 55, 28, 0x2e1a2e, 'NEURAL CENTER');

  // Smaller buildings
  createBuilding(-30, 0, -50, 15, 30, 15, 0x1a1a3e);
  createBuilding(30, 0, -50, 15, 35, 15, 0x1a2e1a);
  createBuilding(-50, 0, 20, 18, 25, 18, 0x2e1a1a);
  createBuilding(50, 0, 20, 18, 28, 18, 0x16213e);
  createBuilding(-20, 0, 60, 12, 20, 12, 0x1a1a2e);
  createBuilding(20, 0, 60, 12, 22, 12, 0x0f3460);

  // Holographic billboards
  createBillboard(-60, 35, -70, 'TECHVERSE', 0x00ffff);
  createBillboard(60, 40, -70, 'INNOVATION', 0xff00ff);
  createBillboard(0, 25, 70, 'FUTURE NOW', 0x00ff00);

  // Stars
  const stars = new THREE.BufferGeometry();
  const verts = [];
  for (let i = 0; i < 35000; i++) {
    verts.push((Math.random() - 0.5) * 6000, Math.random() * 3000, (Math.random() - 0.5) * 6000);
  }
  stars.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
  scene.add(new THREE.Points(stars, new THREE.PointsMaterial({ color: 0xffffff, size: 1 })));

  // Tech stations
  const positions = [
    { x: -32, z: -85, tech: 'vr' },
    { x: 32, z: -85, tech: 'quantum' },
    { x: -65, z: 35, tech: 'neural' },
    { x: 65, z: 35, tech: 'ar' },
    { x: 0, z: 80, tech: 'nanobot' },
    { x: -75, z: 0, tech: 'fusion' },
    { x: 75, z: 0, tech: 'ai' },
    { x: 0, z: -40, tech: 'crispr' }
  ];

  positions.forEach(p => createTech(p.x, p.z, p.tech));
}

function createSkyscraper(x, y, z, w, h, d, color, label) {
  const bldg = new THREE.Mesh(
    new THREE.BoxGeometry(w, h, d),
    new THREE.MeshStandardMaterial({
      color,
      roughness: 0.4,
      metalness: 0.6,
      emissive: 0x00ffff,
      emissiveIntensity: 0.35
    })
  );
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  bldg.receiveShadow = true;
  scene.add(bldg);

  // Neon edges
  const edges = new THREE.EdgesGeometry(bldg.geometry);
  const lines = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ffff, linewidth: 2 }));
  bldg.add(lines);

  // Windows
  for (let i = 0; i < 10; i++) {
    const window = new THREE.Mesh(
      new THREE.PlaneGeometry(w * 0.8, h / 12),
      new THREE.MeshBasicMaterial({ color: 0xffff00, transparent: true, opacity: 0.6 })
    );
    window.position.set(0, -h / 2 + (i + 1) * (h / 11), d / 2 + 0.1);
    bldg.add(window);
  }

  createLbl(label, x, h + 6, z);
}

function createBuilding(x, y, z, w, h, d, color) {
  const bldg = new THREE.Mesh(
    new THREE.BoxGeometry(w, h, d),
    new THREE.MeshStandardMaterial({ color, roughness: 0.5, metalness: 0.5, emissive: 0x00ffff, emissiveIntensity: 0.25 })
  );
  bldg.position.set(x, h / 2, z);
  bldg.castShadow = true;
  scene.add(bldg);

  const edges = new THREE.EdgesGeometry(bldg.geometry);
  bldg.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ffff })));
}

function createBillboard(x, y, z, text, color) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 512;
  canvas.height = 128;
  ctx.fillStyle = 'rgba(0,0,0,0.9)';
  ctx.fillRect(0, 0, 512, 128);
  ctx.font = 'Bold 50px Arial';
  ctx.fillStyle = `#${color.toString(16).padStart(6, '0')}`;
  ctx.textAlign = 'center';
  ctx.fillText(text, 256, 80);
  
  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.position.set(x, y, z);
  sprite.scale.set(20, 5, 1);
  scene.add(sprite);
}

function createLbl(text, x, y, z) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 512;
  canvas.height = 128;
  ctx.fillStyle = 'rgba(0,0,0,0.85)';
  ctx.fillRect(0, 0, 512, 128);
  ctx.font = 'Bold 44px Arial';
  ctx.fillStyle = '#00ffff';
  ctx.textAlign = 'center';
  ctx.fillText(text, 256, 70);
  
  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.position.set(x, y, z);
  sprite.scale.set(18, 4.5, 1);
  scene.add(sprite);
}

function createTech(x, z, id) {
  const tech = techs[id];
  const y = 3.5;

  const platform = new THREE.Mesh(
    new THREE.CylinderGeometry(5, 5, 1.2, 32),
    new THREE.MeshStandardMaterial({ color: 0x1a1a2e, emissive: tech.color, emissiveIntensity: 0.5, metalness: 0.9, roughness: 0.1 })
  );
  platform.position.set(x, 0.6, z);
  scene.add(platform);

  const obj = new THREE.Mesh(
    new THREE.BoxGeometry(5, 5, 5),
    new THREE.MeshStandardMaterial({ color: tech.color, emissive: tech.color, emissiveIntensity: 0.9, metalness: 0.95, roughness: 0.05, transparent: true, opacity: 0.95 })
  );
  obj.position.set(x, y, z);
  obj.castShadow = true;
  obj.userData = { id, y, speed: Math.random() * 0.8 + 0.4 };
  scene.add(obj);
  techObjs.push(obj);

  const glow = new THREE.Mesh(
    new THREE.SphereGeometry(4, 32, 32),
    new THREE.MeshBasicMaterial({ color: tech.color, transparent: true, opacity: 0.3 })
  );
  obj.add(glow);

  const ring = new THREE.Mesh(
    new THREE.TorusGeometry(4.5, 0.2, 16, 100),
    new THREE.MeshBasicMaterial({ color: tech.color })
  );
  ring.rotation.x = Math.PI / 2;
  ring.position.y = -2;
  obj.add(ring);

  createLbl(tech.name.toUpperCase(), x, y + 7, z);
}

function setupControls() {
  addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  addEventListener('keydown', e => {
    if (e.code === 'KeyW') moveF = true;
    if (e.code === 'KeyS') moveB = true;
    if (e.code === 'KeyA') moveL = true;
    if (e.code === 'KeyD') moveR = true;
    if (e.code === 'ShiftLeft') state.sprint = true;
    if (e.code === 'KeyE' && curInteract) interact();
  });

  addEventListener('keyup', e => {
    if (e.code === 'KeyW') moveF = false;
    if (e.code === 'KeyS') moveB = false;
    if (e.code === 'KeyA') moveL = false;
    if (e.code === 'KeyD') moveR = false;
    if (e.code === 'ShiftLeft') state.sprint = false;
  });

  addEventListener('mousemove', e => {
    if (document.pointerLockElement === document.body) {
      camera.rotation.y -= (e.movementX || 0) * 0.002;
      camera.rotation.x -= (e.movementY || 0) * 0.002;
      camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
    }
  });

  document.body.addEventListener('click', () => {
    if (!document.getElementById('charSelect').classList.contains('hide')) return;
    document.body.requestPointerLock();
  });
}

function animate() {
  requestAnimationFrame(animate);
  const delta = clock.getDelta();
  const speed = state.sprint ? 100 : 60;

  vel.x -= vel.x * 10 * delta;
  vel.z -= vel.z * 10 * delta;

  dir.z = Number(moveF) - Number(moveB);
  dir.x = Number(moveR) - Number(moveL);
  dir.normalize();

  if (moveF || moveB) vel.z -= dir.z * speed * delta;
  if (moveL || moveR) vel.x -= dir.x * speed * delta;

  camera.position.x += vel.x * delta;
  camera.position.z += vel.z * delta;

  techObjs.forEach(obj => {
    obj.rotation.y += delta * 0.8;
    obj.rotation.x += delta * 0.4;
    obj.position.y = obj.userData.y + Math.sin(Date.now() * 0.001 * obj.userData.speed) * 0.8;
    
    if (obj.children[0]) obj.children[0].material.opacity = 0.3 + Math.sin(Date.now() * 0.003) * 0.2;
    if (obj.children[1]) obj.children[1].rotation.z += delta * 2;
  });

  checkNearby();
  renderer.render(scene, camera);
}

function checkNearby() {
  let nearest = null, minDist = 15;
  techObjs.forEach(obj => {
    const dist = camera.position.distanceTo(obj.position);
    if (dist < minDist) { minDist = dist; nearest = obj; }
  });

  if (nearest && nearest !== curInteract) { curInteract = nearest; showInteract(); }
  else if (!nearest && curInteract) { curInteract = null; hideInteract(); }
}

function showInteract() {
  const tech = techs[curInteract.userData.id];
  const owned = state.inventory.includes(curInteract.userData.id);
  
  document.getElementById('intTitle').textContent = tech.name;
  document.getElementById('intDesc').textContent = `${tech.desc}\nCost: $${tech.cost.toLocaleString()} | Effect: ${tech.effect}`;
  
  const btns = document.getElementById('intBtns');
  btns.innerHTML = '';
  
  const btn = document.createElement('button');
  btn.className = 'actBtn';
  btn.textContent = owned ? 'USE' : `BUY $${tech.cost.toLocaleString()}`;
  btn.onclick = () => owned ? useTech(curInteract.userData.id) : buyTech(curInteract.userData.id);
  btns.appendChild(btn);
  
  document.getElementById('interact').classList.remove('hide');
}

function hideInteract() { document.getElementById('interact').classList.add('hide'); }

function interact() {
  const owned = state.inventory.includes(curInteract.userData.id);
  owned ? useTech(curInteract.userData.id) : buyTech(curInteract.userData.id);
}

function buyTech(id) {
  const tech = techs[id];
  if (state.fund >= tech.cost) {
    state.fund -= tech.cost;
    state.inventory.push(id);
    addXP(80);
    updateHUD();
    updateInv();
    notify(`‚úÖ BOUGHT: ${tech.name}! +80 XP`);
    hideInteract();
  } else {
    notify(`‚ùå Need $${(tech.cost - state.fund).toLocaleString()} more!`);
  }
}

function useTech(id) {
  const tech = techs[id];
  
  if (id === 'vr') {
    state.inVR = true;
    document.getElementById('vrMode').classList.remove('hide');
    scene.background = new THREE.Color(0x001a33);
    notify('ü•Ω VR ACTIVATED!');
  } else if (id === 'quantum') {
    state.rep += 120; state.fund += 70000; addXP(150);
    notify('‚öõÔ∏è Quantum solving! +120 Rep, +$70k, +150 XP!');
  } else if (id === 'fusion') {
    state.fund += 700000; state.rep += 400; addXP(350);
    notify('‚ö° Fusion online! +$700k, +400 Rep, +350 XP!');
  } else {
    state.rep += 70; addXP(100);
    notify(`‚ö° Using ${tech.name}! +70 Rep, +100 XP!`);
  }
  
  updateHUD();
  hideInteract();
}

window.exitVR = function() {
  state.inVR = false;
  document.getElementById('vrMode').classList.add('hide');
  scene.background = new THREE.Color(0x000510);
  notify('VR disconnected');
};

function addXP(amt) {
  state.xp += amt;
  while (state.xp >= state.xpMax) {
    state.xp -= state.xpMax; state.lvl++; state.xpMax = Math.floor(state.xpMax * 1.5); state.fund += 100000;
    notify(`üéâ LEVEL ${state.lvl}! +$100k!`);
  }
  updateHUD();
}

function updateHUD() {
  document.getElementById('role').textContent = state.char || '-';
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('xp').textContent = `${state.xp}/${state.xpMax}`;
  document.getElementById('rep').textContent = state.rep;
  document.getElementById('fund').textContent = '$' + (state.fund / 1000).toFixed(0) + 'K';
  document.getElementById('techOwned').textContent = state.inventory.length;
}

function updateInv() {
  const list = document.getElementById('invList');
  list.innerHTML = state.inventory.length === 0 ? '<p style="color:#888;text-align:center;padding:20px">No tech yet</p>' : '';
  
  state.inventory.forEach(id => {
    const tech = techs[id];
    const div = document.createElement('div');
    div.className = 'invItem';
    div.innerHTML = `<div class="invName">${tech.name}</div><div class="invDesc">${tech.desc}</div><button class="invBtn" onclick="window.useTechFromInv('${id}')">USE</button>`;
    list.appendChild(div);
  });
}

window.useTechFromInv = function(id) { useTech(id); };

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 3500);
}

let selChar = null;
document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selChar = card.dataset.char;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'START JOURNEY';
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!selChar) return;
  state.char = selChar;
  document.getElementById('charSelect').classList.add('hide');
  document.getElementById('loading').classList.remove('hide');
  
  const msgs = ['Initializing...', 'Loading city...', 'Rendering...', 'Ready!'];
  let i = 0;
  const interval = setInterval(() => {
    document.getElementById('loadText').textContent = msgs[i++];
    if (i >= msgs.length) {
      clearInterval(interval);
      document.getElementById('loading').classList.add('hide');
      document.getElementById('hud').classList.remove('hide');
      document.getElementById('inventory').classList.remove('hide');
      document.getElementById('controls').classList.remove('hide');
      init();
    }
  }, 600);
});
</script>
</body>
</html>