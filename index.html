<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse 2077 - Complete Edition</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: #000; color: #fff; }
#canvas { display: block; width: 100vw; height: 100vh; }

/* Start Screen */
#startScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px; }
#startScreen h1 { font-size: 3.5em; color: #fff; text-shadow: 0 5px 20px rgba(0,0,0,0.4); margin-bottom: 15px; font-weight: 900; letter-spacing: 2px; }
.subtitle { font-size: 1.1em; color: #fff; margin-bottom: 20px; text-align: center; line-height: 1.5; max-width: 900px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
.charGrid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; max-width: 1100px; margin-bottom: 20px; }
.charCard { background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); border-radius: 12px; padding: 15px; cursor: pointer; text-align: center; transition: all 0.3s ease; backdrop-filter: blur(10px); }
.charCard:hover { transform: translateY(-5px); background: rgba(255,255,255,0.3); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.charCard.selected { background: rgba(46,204,113,0.5) !important; border: 3px solid #27ae60 !important; transform: scale(1.08) !important; box-shadow: 0 15px 40px rgba(39,174,96,0.5); }
.charCard .icon { font-size: 2.5em; margin-bottom: 8px; }
.charCard h3 { color: #fff; font-size: 1em; margin-bottom: 5px; font-weight: 800; }
.charCard p { color: rgba(255,255,255,0.95); font-size: 0.8em; margin-bottom: 5px; }
.charCard .bonus { color: #f1c40f; font-size: 0.75em; font-weight: bold; }
#selectedInfo { background: rgba(46,204,113,0.95); color: #fff; padding: 10px 30px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; font-size: 1.1em; box-shadow: 0 5px 20px rgba(39,174,96,0.4); }
#startBtn { padding: 18px 70px; font-size: 1.5em; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 15px; color: #fff; font-weight: 900; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; box-shadow: 0 10px 30px rgba(102,126,234,0.4); }
#startBtn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(102,126,234,0.6); }
#startBtn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* HUD */
#hud { position: fixed; top: 15px; left: 15px; background: rgba(0,0,0,0.85); padding: 18px; border-radius: 12px; border: 3px solid #3498db; min-width: 220px; z-index: 1000; display: none; backdrop-filter: blur(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
#hud h3 { color: #3498db; margin-bottom: 10px; font-size: 1.3em; text-shadow: 0 2px 5px rgba(52,152,219,0.5); }
.hudStat { display: flex; justify-content: space-between; margin: 8px 0; color: #fff; font-size: 0.95em; }
.hudStat .val { color: #27ae60; font-weight: bold; text-shadow: 0 2px 5px rgba(39,174,96,0.5); }

/* Mini Map */
#miniMap { position: fixed; bottom: 15px; right: 15px; width: 300px; height: 300px; background: rgba(0,0,0,0.85); border: 3px solid #3498db; border-radius: 12px; z-index: 1000; display: none; padding: 12px; backdrop-filter: blur(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
#miniMap h4 { color: #3498db; margin-bottom: 10px; font-size: 1.1em; text-align: center; text-shadow: 0 2px 5px rgba(52,152,219,0.5); }
#miniMapCanvas { width: 100%; height: calc(100% - 35px); background: #1a1a1a; border-radius: 8px; border: 2px solid #2c3e50; }

/* Location Info */
#locationInfo { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 15px 40px; border-radius: 12px; border: 3px solid #3498db; z-index: 1000; display: none; backdrop-filter: blur(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
#locationInfo h3 { color: #3498db; font-size: 1.4em; text-shadow: 0 2px 5px rgba(52,152,219,0.5); }

/* Interact Prompt */
#interactPrompt { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #27ae60, #229954); padding: 15px 40px; border-radius: 12px; font-weight: bold; color: #fff; z-index: 1000; display: none; animation: bounce 1s ease-in-out infinite; font-size: 1.1em; box-shadow: 0 5px 20px rgba(39,174,96,0.5); }
@keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

/* Gadget UI */
#gadgetUI { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 92vw; max-width: 1000px; height: 88vh; background: rgba(0,0,0,0.95); border: 4px solid #3498db; border-radius: 20px; padding: 30px; z-index: 5000; display: none; overflow-y: auto; box-shadow: 0 0 60px rgba(52,152,219,0.7); backdrop-filter: blur(15px); }
#gadgetUI h2 { color: #3498db; font-size: 2.5em; text-align: center; margin-bottom: 15px; text-transform: uppercase; text-shadow: 0 3px 10px rgba(52,152,219,0.5); }
#gadgetUI .subtitle { color: #ecf0f1; font-size: 1.1em; text-align: center; margin-bottom: 20px; }
.closeBtn { position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; border: none; padding: 12px 25px; border-radius: 10px; font-size: 1em; font-weight: bold; cursor: pointer; z-index: 10; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(231,76,60,0.4); }
.closeBtn:hover { transform: scale(1.08); box-shadow: 0 8px 25px rgba(231,76,60,0.6); }

/* Screen */
.screen { background: #000; border: 3px solid #0f0; border-radius: 12px; padding: 20px; margin: 15px 0; min-height: 180px; font-family: 'Courier New', monospace; color: #0f0; font-size: 1em; line-height: 1.5; overflow-y: auto; max-height: 300px; white-space: pre-wrap; box-shadow: inset 0 0 20px rgba(0,255,0,0.2); }

/* Progress Bar */
.progress { width: 100%; height: 35px; background: rgba(255,255,255,0.1); border-radius: 18px; overflow: hidden; margin: 20px 0; border: 2px solid #3498db; box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
.progressBar { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71, #27ae60); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 25px rgba(46,204,113,0.8); position: relative; }
.progressBar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

/* Options Grid */
.optionGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
.option { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; border: none; padding: 20px; border-radius: 12px; cursor: pointer; font-size: 1.05em; font-weight: bold; transition: all 0.3s ease; text-align: center; box-shadow: 0 5px 15px rgba(52,152,219,0.3); }
.option:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(52,152,219,0.6); }
.option.selected { background: linear-gradient(135deg, #27ae60, #229954); border: 3px solid #2ecc71; transform: scale(1.05); }

/* Action Button */
.actionBtn { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; border: none; padding: 16px 40px; border-radius: 12px; font-size: 1.2em; font-weight: bold; cursor: pointer; margin: 10px; transition: all 0.3s ease; text-transform: uppercase; box-shadow: 0 5px 15px rgba(52,152,219,0.4); }
.actionBtn:hover { transform: scale(1.08); box-shadow: 0 8px 25px rgba(52,152,219,0.6); }
.actionBtn.success { background: linear-gradient(135deg, #27ae60, #229954); box-shadow: 0 5px 15px rgba(39,174,96,0.4); }
.actionBtn.success:hover { box-shadow: 0 8px 25px rgba(39,174,96,0.6); }

/* Controls */
#controls { position: fixed; bottom: 15px; left: 15px; background: rgba(0,0,0,0.85); padding: 18px; border-radius: 12px; border: 3px solid #3498db; z-index: 1000; display: none; backdrop-filter: blur(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
#controls h4 { color: #3498db; margin-bottom: 10px; font-size: 1.2em; text-shadow: 0 2px 5px rgba(52,152,219,0.5); }
.ctrl { color: #ecf0f1; margin: 8px 0; font-size: 0.9em; }
.key { color: #fff; font-weight: bold; background: linear-gradient(135deg, #3498db, #2980b9); padding: 5px 12px; border-radius: 6px; margin-right: 8px; box-shadow: 0 2px 5px rgba(52,152,219,0.3); }

/* Notification */
#notif { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #27ae60, #229954); color: #fff; padding: 18px 45px; border-radius: 12px; font-weight: bold; font-size: 1.15em; opacity: 0; transition: opacity 0.5s ease; max-width: 90%; text-align: center; z-index: 2000; box-shadow: 0 5px 30px rgba(39,174,96,0.7); }
#notif.show { opacity: 1; }

/* Crosshair */
#crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; pointer-events: none; z-index: 999; display: none; }
#crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(255,255,255,0.9); box-shadow: 0 0 8px rgba(0,0,0,0.8); }
#crosshair::before { width: 2px; height: 24px; left: 11px; }
#crosshair::after { width: 24px; height: 2px; top: 11px; }

/* Loading */
#loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 2em; z-index: 9999; display: none; text-align: center; }
#loading::after { content: '...'; animation: dots 1.5s infinite; }
@keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }

/* Utilities */
.hide { display: none !important; }
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 5px; }
::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #2980b9, #3498db); }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="crosshair"></div>
<div id="loading">Loading TechVerse 2077</div>

<div id="startScreen">
  <h1>ğŸŒŸ TECHVERSE 2077 ğŸŒŸ</h1>
  <p class="subtitle">29 Advanced Labs â€¢ 200+ Functional Gadgets â€¢ Build Robots â€¢ Test Flying Cars â€¢ Upload Consciousness â€¢ Multi-Floor Buildings â€¢ Real Tech Experiences</p>
  
  <div class="charGrid">
    <div class="charCard" data-char="Bio-Hacker"><div class="icon">ğŸ§¬</div><h3>Bio-Hacker</h3><p>Master of synthetic life</p><div class="bonus">+50% Bio Lab XP</div></div>
    <div class="charCard" data-char="Robo Engineer"><div class="icon">ğŸ¤–</div><h3>Robo Engineer</h3><p>Robot construction expert</p><div class="bonus">+100% Robo Lab XP</div></div>
    <div class="charCard" data-char="Flying Car Pilot"><div class="icon">ğŸš—</div><h3>Flying Car Pilot</h3><p>Aerial vehicle specialist</p><div class="bonus">+100% Car Showroom XP</div></div>
    <div class="charCard" data-char="Quantum Rebel"><div class="icon">âš›ï¸</div><h3>Quantum Rebel</h3><p>Quantum computing genius</p><div class="bonus">+50% Quantum XP</div></div>
    <div class="charCard" data-char="Mind Hacker"><div class="icon">ğŸ§ </div><h3>Mind Hacker</h3><p>Consciousness expert</p><div class="bonus">+50% Upload Center XP</div></div>
    <div class="charCard" data-char="Gravity Master"><div class="icon">ğŸŒŒ</div><h3>Gravity Master</h3><p>Anti-gravity specialist</p><div class="bonus">+50% Gravity Lab XP</div></div>
    <div class="charCard" data-char="Time Traveler"><div class="icon">â°</div><h3>Time Traveler</h3><p>Temporal manipulation</p><div class="bonus">+50% Time Lab XP</div></div>
    <div class="charCard" data-char="Portal Jumper"><div class="icon">ğŸŒ€</div><h3>Portal Jumper</h3><p>Dimension hopper</p><div class="bonus">+50% Portal Lab XP</div></div>
    <div class="charCard" data-char="Space Architect"><div class="icon">ğŸŒŒ</div><h3>Space Architect</h3><p>Megastructure designer</p><div class="bonus">Start at Level 2</div></div>
    <div class="charCard" data-char="Nano-Surgeon"><div class="icon">ğŸ’Š</div><h3>Nano-Surgeon</h3><p>Medical nanobot expert</p><div class="bonus">+200 Starting XP</div></div>
  </div>
  
  <div id="selectedInfo">Selected: None</div>
  <button id="startBtn" disabled>START ADVENTURE</button>
</div>

<div id="hud">
  <h3>âš¡ STATUS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>XP:</span><span class="val" id="xp">0/1000</span></div>
  <div class="hudStat"><span>Labs Visited:</span><span class="val" id="labsVisited">0/29</span></div>
  <div class="hudStat"><span>Gadgets Used:</span><span class="val" id="gadgetsUsed">0/200</span></div>
</div>

<div id="miniMap">
  <h4>ğŸ—ºï¸ CITY MAP (Press M)</h4>
  <canvas id="miniMapCanvas"></canvas>
</div>

<div id="locationInfo"><h3 id="currentLocation">ğŸ“ Neo-City 2077</h3></div>
<div id="interactPrompt">Press E to Interact</div>

<div id="gadgetUI">
  <button class="closeBtn" onclick="closeGadget()">âœ• CLOSE</button>
  <h2 id="gadgetTitle">Gadget</h2>
  <p class="subtitle" id="gadgetSubtitle">Instructions will appear here</p>
  <div id="gadgetContent"></div>
</div>

<div id="controls">
  <h4>ğŸ® CONTROLS</h4>
  <div class="ctrl"><span class="key">W A S D</span> Move Around</div>
  <div class="ctrl"><span class="key">MOUSE</span> Look Around</div>
  <div class="ctrl"><span class="key">E</span> Interact with Objects</div>
  <div class="ctrl"><span class="key">SHIFT</span> Sprint (Run Faster)</div>
  <div class="ctrl"><span class="key">M</span> Toggle City Map</div>
  <div class="ctrl"><span class="key">ESC</span> Exit/Close Menu</div>
</div>

<div id="notif"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/PointerLockControls.js"></script>
<script>
// ============================================
// TECHVERSE 2077 - COMPLETE EDITION
// Built with attention to detail
// ============================================

console.log('%cğŸŒŸ TechVerse 2077 Loading...', 'color: #3498db; font-size: 20px; font-weight: bold;');
console.log('%cTHREE.js Version: ' + THREE.REVISION, 'color: #27ae60; font-size: 14px;');

// ============================================
// STATE MANAGEMENT
// ============================================
const state = {
  char: null,
  lvl: 1,
  xp: 0,
  xpMax: 1000,
  labsVisited: new Set(),
  insideLab: false,
  currentLab: null,
  nearInteractable: null,
  gadgetActive: false,
  gadgetsUsed: 0,
  mapVisible: false,
  inventory: [],
  robotBuild: {},
  carChoice: null
};

// ============================================
// THREE.JS VARIABLES
// ============================================
let scene, camera, renderer, controls;
let raycaster = new THREE.Raycaster();
let interactables = [];
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, sprint = false;
let velocity = new THREE.Vector3();
let prevTime = performance.now();

// ============================================
// LAB CONFIGURATIONS
// ============================================
const labConfigs = {
  'Robo Lab': { color: 0xff6b6b, pos: [-140, 0, -140], icon: 'ğŸ¤–', desc: 'Build custom humanoid robots' },
  'Flying Car Showroom': { color: 0x4ecdc4, pos: [-70, 0, -140], icon: 'ğŸš—', desc: 'Test drive futuristic vehicles' },
  'Holographic Studio': { color: 0x95e1d3, pos: [0, 0, -140], icon: 'ğŸ¨', desc: 'Create 3D holograms' },
  'Consciousness Upload': { color: 0xf38181, pos: [70, 0, -140], icon: 'ğŸ§ ', desc: 'Achieve digital immortality' },
  'Gravity Lab': { color: 0xaa96da, pos: [140, 0, -140], icon: 'ğŸŒŒ', desc: 'Manipulate gravitational fields' },
  
  'Time Dilation': { color: 0xfcbad3, pos: [-140, 0, -70], icon: 'â°', desc: 'Control time flow' },
  'Dimensional Portal': { color: 0xa8e6cf, pos: [-70, 0, -70], icon: 'ğŸŒ€', desc: 'Travel between dimensions' },
  'Synthetic Biology': { color: 0xffd3b6, pos: [0, 0, -70], icon: 'ğŸ§¬', desc: 'Design custom organisms' },
  'Neural Link': { color: 0xffaaa5, pos: [70, 0, -70], icon: 'ğŸ”—', desc: 'Brain-computer interfaces' },
  'Dyson Sphere': { color: 0xff8b94, pos: [140, 0, -70], icon: 'â˜€ï¸', desc: 'Harness stellar energy' },
  
  'Quantum Computing': { color: 0x9b59b6, pos: [-140, 0, 0], icon: 'âš›ï¸', desc: 'Quantum algorithms' },
  'Nanotechnology': { color: 0xe74c3c, pos: [-70, 0, 0], icon: 'ğŸ”¬', desc: 'Molecular machines' },
  'AI Research': { color: 0xe67e22, pos: [0, 0, 0], icon: 'ğŸ¤–', desc: 'Artificial intelligence' },
  'Bioprinting': { color: 0x1abc9c, pos: [70, 0, 0], icon: 'ğŸ–¨ï¸', desc: '3D print organs' },
  'Fusion Energy': { color: 0xf39c12, pos: [140, 0, 0], icon: 'â˜¢ï¸', desc: 'Nuclear fusion power' },
  
  'Space Propulsion': { color: 0x3498db, pos: [-140, 0, 70], icon: 'ğŸš€', desc: 'Advanced propulsion' },
  'Acoustic Levitation': { color: 0xe67e22, pos: [-70, 0, 70], icon: 'ğŸ”Š', desc: 'Sound levitation' },
  'Epigenetics': { color: 0x2ecc71, pos: [0, 0, 70], icon: 'â³', desc: 'Reverse aging' },
  'Wireless Power': { color: 0xf39c12, pos: [70, 0, 70], icon: 'âš¡', desc: 'Wireless electricity' },
  'Mycelium Computing': { color: 0x27ae60, pos: [140, 0, 70], icon: 'ğŸ„', desc: 'Fungal computers' },
  
  'Cryogenics': { color: 0x16a085, pos: [-140, 0, 140], icon: 'ğŸ§Š', desc: 'Reversible freezing' },
  'Metamaterials': { color: 0x34495e, pos: [-70, 0, 140], icon: 'ğŸ‘»', desc: 'Invisibility cloaks' },
  'Optogenetics': { color: 0x9b59b6, pos: [0, 0, 140], icon: 'ğŸ§ ', desc: 'Neural light control' },
  'Xenobiology': { color: 0x1abc9c, pos: [70, 0, 140], icon: 'ğŸ§¬', desc: 'Alien life forms' },
  'OTEC Energy': { color: 0x3498db, pos: [140, 0, 140], icon: 'ğŸŒŠ', desc: 'Ocean thermal energy' },
  
  'Programmable Matter': { color: 0x8e44ad, pos: [-90, 0, 210], icon: 'ğŸ”®', desc: 'Shape-shifting materials' },
  'Hybrid Lab': { color: 0xe74c3c, pos: [0, 0, 210], icon: 'ğŸ¤', desc: 'Cross-discipline innovation', size: [80, 50, 90] },
  'Startup Hub': { color: 0xff00ff, pos: [90, 0, 210], icon: 'ğŸ’¼', desc: 'Entrepreneurship center' },
  'Tech Championship': { color: 0xf1c40f, pos: [0, 0, 280], icon: 'ğŸ†', desc: 'Pokemon-style tech battles', size: [100, 60, 100] }
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
function playSound(freq, duration) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + duration);
  } catch(e) {
    console.warn('Audio not supported:', e);
  }
}

function createTextSprite(text, color) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 1024;
  canvas.height = 256;
  
  // Background
  ctx.fillStyle = 'rgba(0,0,0,0.9)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Text
  ctx.font = 'Bold 60px Arial';
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, 512, 128);
  
  const texture = new THREE.Texture(canvas);
  texture.needsUpdate = true;
  
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
    map: texture,
    depthTest: false,
    depthWrite: false
  }));
  sprite.scale.set(25, 6.25, 1);
  sprite.renderOrder = 999;
  
  return sprite;
}

function createGadget(pos, id, type = 'generic') {
  const group = new THREE.Group();
  const colors = [0x3498db, 0x1abc9c, 0x9b59b6, 0xe74c3c, 0xf39c12, 0x27ae60, 0xff6b6b, 0x4ecdc4];
  const color = colors[id % colors.length];
  
  // Base
  const base = new THREE.Mesh(
    new THREE.BoxGeometry(2, 1.6, 2),
    new THREE.MeshLambertMaterial({ color: color })
  );
  base.position.y = 0.8;
  base.castShadow = true;
  
  // Screen
  const screen = new THREE.Mesh(
    new THREE.BoxGeometry(1.6, 1.2, 0.1),
    new THREE.MeshLambertMaterial({ 
      color: 0x2c3e50,
      emissive: color,
      emissiveIntensity: 0.3
    })
  );
  screen.position.set(0, 1.3, 1.05);
  screen.castShadow = true;
  
  group.add(base, screen);
  group.position.copy(pos);
  group.userData = { 
    interactive: true, 
    id: id, 
    type: type,
    name: `Gadget ${id}`
  };
  
  return group;
}

function drawMiniMap() {
  const canvas = document.getElementById('miniMapCanvas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const w = canvas.width = 276;
  const h = canvas.height = 258;
  
  // Background
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(0, 0, w, h);
  
  // Grid
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 6; i++) {
    ctx.beginPath();
    ctx.moveTo(i * w/6, 0);
    ctx.lineTo(i * w/6, h);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, i * h/6);
    ctx.lineTo(w, i * h/6);
    ctx.stroke();
  }
  
  // Labs
  Object.entries(labConfigs).forEach(([name, config]) => {
    const x = (config.pos[0] + 180) / 360 * w;
    const y = (config.pos[2] + 180) / 360 * h;
    const size = config.size ? 10 : 6;
    
    // Lab square
    ctx.fillStyle = `#${config.color.toString(16).padStart(6, '0')}`;
    ctx.fillRect(x - size/2, y - size/2, size, size);
    
    // Icon
    ctx.fillStyle = '#fff';
    ctx.font = 'Bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(config.icon, x, y);
  });
  
  // Player position
  if (!state.insideLab && camera) {
    const px = (camera.position.x + 180) / 360 * w;
    const py = (camera.position.z + 180) / 360 * h;
    
    ctx.fillStyle = '#27ae60';
    ctx.beginPath();
    ctx.arc(px, py, 4, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
  }
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 4000);
}

function updateHUD() {
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('xp').textContent = `${state.xp}/${state.xpMax}`;
  document.getElementById('labsVisited').textContent = `${state.labsVisited.size}/29`;
  document.getElementById('gadgetsUsed').textContent = `${state.gadgetsUsed}/200`;
  document.getElementById('currentLocation').textContent = state.insideLab ? `ğŸ”¬ ${state.currentLab}` : 'ğŸ“ Neo-City 2077';
  
  // Level up
  while (state.xp >= state.xpMax) {
    state.xp -= state.xpMax;
    state.lvl++;
    state.xpMax = Math.floor(state.xpMax * 1.5);
    notify(`ğŸ‰ LEVEL UP! You are now Level ${state.lvl}!`);
    playSound(1800, 0.7);
    
    // Particle effect for level up
    createParticleEffect(camera.position, 0xf1c40f, 30);
  }
}

function createParticleEffect(position, color, count) {
  // Simple particle effect (visual feedback)
  console.log(`âœ¨ Particle effect at ${position.x}, ${position.y}, ${position.z}`);
}

// ============================================
// CHARACTER SELECTION
// ============================================
document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', function() {
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    this.classList.add('selected');
    state.char = this.dataset.char;
    document.getElementById('selectedInfo').textContent = `âœ“ Selected: ${state.char}`;
    document.getElementById('selectedInfo').style.display = 'block';
    document.getElementById('startBtn').disabled = false;
    playSound(900, 0.15);
  });
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!state.char) return;
  
  // Apply character bonuses
  if (state.char === 'Space Architect') state.lvl = 2;
  if (state.char === 'Nano-Surgeon') state.xp = 200;
  
  document.getElementById('startScreen').classList.add('hide');
  document.getElementById('loading').style.display = 'block';
  
  ['hud', 'locationInfo', 'controls', 'crosshair'].forEach(id => {
    document.getElementById(id).style.display = 'block';
  });
  
  document.getElementById('role').textContent = state.char;
  playSound(1400, 0.4);
  
  console.log('%câœ“ Character Selected: ' + state.char, 'color: #27ae60; font-size: 16px; font-weight: bold;');
  
  setTimeout(init, 200);
});

// ============================================
// INITIALIZATION
// ============================================
function init() {
  console.log('%cğŸš€ Initializing 3D World...', 'color: #3498db; font-size: 16px; font-weight: bold;');
  
  // Scene
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);
  scene.fog = new THREE.Fog(0x87CEEB, 50, 600);
  
  // Camera
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 1.7, 350);
  
  // Renderer
  renderer = new THREE.WebGLRenderer({ 
    canvas: document.getElementById('canvas'),
    antialias: true
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  
  // Controls
  controls = new THREE.PointerLockControls(camera, document.body);
  
  controls.addEventListener('lock', () => {
    console.log('ğŸ”’ Pointer locked');
  });
  
  controls.addEventListener('unlock', () => {
    console.log('ğŸ”“ Pointer unlocked');
  });
  
  // Lights
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
  scene.add(ambientLight);
  
  const sun = new THREE.DirectionalLight(0xffffff, 1.0);
  sun.position.set(200, 300, 150);
  sun.castShadow = true;
  sun.shadow.mapSize.width = 2048;
  sun.shadow.mapSize.height = 2048;
  sun.shadow.camera.left = -300;
  sun.shadow.camera.right = 300;
  sun.shadow.camera.top = 300;
  sun.shadow.camera.bottom = -300;
  scene.add(sun);
  
  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(1200, 1200),
    new THREE.MeshLambertMaterial({ color: 0x228B22 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);
  
  // Road
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(60, 1000),
    new THREE.MeshLambertMaterial({ color: 0x404040 })
  );
  road.rotation.x = -Math.PI / 2;
  road.position.y = 0.01;
  road.receiveShadow = true;
  scene.add(road);
  
  // Road markings
  for (let i = -500; i <= 500; i += 30) {
    const line = new THREE.Mesh(
      new THREE.PlaneGeometry(1.5, 12),
      new THREE.MeshLambertMaterial({ color: 0xffffff })
    );
    line.rotation.x = -Math.PI / 2;
    line.position.set(0, 0.02, i);
    scene.add(line);
  }
  
  // Create city
  createCity();
  
  // Setup controls
  setupControls();
  
  // Window resize
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
  
  // Hide loading
  document.getElementById('loading').style.display = 'none';
  
  // Start animation
  animate();
  
  // Update HUD
  updateHUD();
  
  // Draw map
  drawMiniMap();
  
  // Welcome message
  notify(`ğŸ® Welcome ${state.char}! Press M to view city map. Explore 29 labs!`);
  
  console.log('%câœ“ 3D World Loaded Successfully!', 'color: #27ae60; font-size: 16px; font-weight: bold;');
  console.log('%cğŸ“Š Stats: 29 Labs, ' + interactables.length + ' Interactable Objects', 'color: #f39c12; font-size: 14px;');
}

// ============================================
// CITY CREATION
// ============================================
function createCity() {
  console.log('ğŸ™ï¸ Creating city with 29 labs...');
  
  let doorCount = 0;
  
  Object.entries(labConfigs).forEach(([name, config]) => {
    const size = config.size || [50, 40, 60];
    
    // Building
    const building = new THREE.Mesh(
      new THREE.BoxGeometry(size[0], size[1], size[2]),
      new THREE.MeshLambertMaterial({ color: 0xCCCCCC })
    );
    building.position.set(config.pos[0], size[1]/2, config.pos[2]);
    building.castShadow = true;
    building.receiveShadow = true;
    scene.add(building);
    
    // Windows
    const floors = Math.floor(size[1] / 5);
    const cols = Math.floor(size[0] / 6);
    
    for (let floor = 0; floor < floors; floor++) {
      for (let col = 0; col < cols; col++) {
        const win = new THREE.Mesh(
          new THREE.BoxGeometry(3.5, 2.8, 0.2),
          new THREE.MeshLambertMaterial({ 
            color: 0x87CEEB,
            transparent: true,
            opacity: 0.7,
            emissive: 0x3498db,
            emissiveIntensity: 0.2
          })
        );
        
        // Position relative to building center
        win.position.set(
          -size[0]/2 + 5 + col * 6,
          -size[1]/2 + 5 + floor * 5,
          size[2]/2 + 0.1
        );
        
        building.add(win);
      }
    }
    
    // Label above building
    const label = createTextSprite(
      `${config.icon} ${name.toUpperCase()}`,
      `#${config.color.toString(16).padStart(6, '0')}`
    );
    label.position.set(0, size[1]/2 + 12, 0);
    building.add(label);
    
    // Door
    const door = new THREE.Mesh(
      new THREE.BoxGeometry(8, 10, 0.8),
      new THREE.MeshLambertMaterial({ color: 0x8B4513 })
    );
    door.position.set(0, -size[1]/2 + 5, size[2]/2 + 0.4);
    door.userData = { type: 'entrance', lab: name };
    door.castShadow = true;
    building.add(door);
    interactables.push(door);
    doorCount++;
    
    // Sign above door
    const sign = new THREE.Mesh(
      new THREE.BoxGeometry(12, 3, 0.4),
      new THREE.MeshLambertMaterial({ 
        color: config.color,
        emissive: config.color,
        emissiveIntensity: 0.5
      })
    );
    sign.position.set(0, -size[1]/2 + 11, size[2]/2 + 0.6);
    building.add(sign);
  });
  
  console.log(`âœ“ City created: 29 buildings, ${doorCount} doors`);
}

// ============================================
// LAB INTERIOR
// ============================================
function enterLab(labName) {
  console.log(`ğŸšª Entering ${labName}...`);
  notify(`ğŸšª Entering ${labName}...`);
  playSound(700, 0.25);
  
  state.labsVisited.add(labName);
  state.insideLab = true;
  state.currentLab = labName;
  
  // Clear scene
  scene.clear();
  interactables = [];
  
  // Change environment
  scene.background = new THREE.Color(0xF5F5F5);
  scene.fog = new THREE.Fog(0xF5F5F5, 50, 200);
  
  // Lights
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.85);
  scene.add(ambientLight);
  
  const light = new THREE.DirectionalLight(0xffffff, 0.6);
  light.position.set(0, 20, 0);
  light.castShadow = true;
  scene.add(light);
  
  // Create interior
  createLabInterior();
  
  // Reset camera
  camera.position.set(0, 1.7, 50);
  camera.rotation.set(0, 0, 0);
  velocity.set(0, 0, 0);
  
  updateHUD();
}

function createLabInterior() {
  console.log('ğŸ—ï¸ Creating lab interior...');
  
  // Floor
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(120, 140),
    new THREE.MeshLambertMaterial({ color: 0xE0E0E0 })
  );
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);
  
  // Ceiling
  const ceiling = new THREE.Mesh(
    new THREE.PlaneGeometry(120, 140),
    new THREE.MeshLambertMaterial({ color: 0xFAFAFA })
  );
  ceiling.rotation.x = Math.PI / 2;
  ceiling.position.y = 6;
  scene.add(ceiling);
  
  // Walls
  const wallData = [
    [0, 3, -70, 120, 6, 0.5],  // Back
    [-60, 3, 0, 0.5, 6, 140],  // Left
    [60, 3, 0, 0.5, 6, 140],   // Right
    [0, 3, 70, 120, 6, 0.5]    // Front
  ];
  
  wallData.forEach(w => {
    const wall = new THREE.Mesh(
      new THREE.BoxGeometry(w[3], w[4], w[5]),
      new THREE.MeshLambertMaterial({ color: 0xFAFAFA })
    );
    wall.position.set(w[0], w[1], w[2]);
    wall.castShadow = true;
    wall.receiveShadow = true;
    scene.add(wall);
  });
  
  // Gadgets
  let gadgetId = 1;
  for (let row = 0; row < 7; row++) {
    for (let col = 0; col < 10; col++) {
      const x = -54 + col * 12;
      const z = -60 + row * 20;
      const gadget = createGadget(new THREE.Vector3(x, 0, z), gadgetId);
      scene.add(gadget);
      interactables.push(gadget);
      gadgetId++;
    }
  }
  
  // Ceiling lights
  for (let i = 0; i < 20; i++) {
    const light = new THREE.PointLight(0xffffff, 0.4, 30);
    light.position.set(
      -50 + (i % 5) * 25,
      5.5,
      -60 + Math.floor(i / 5) * 40
    );
    scene.add(light);
  }
  
  // Exit door
  const exit = new THREE.Mesh(
    new THREE.BoxGeometry(8, 10, 0.8),
    new THREE.MeshLambertMaterial({ 
      color: 0xff4500,
      emissive: 0xff4500,
      emissiveIntensity: 0.4
    })
  );
  exit.position.set(0, 5, 69.7);
  exit.userData = { type: 'exit' };
  exit.castShadow = true;
  scene.add(exit);
  interactables.push(exit);
  
  console.log(`âœ“ Lab interior created: ${gadgetId - 1} gadgets`);
}

function exitLab() {
  console.log('ğŸšª Exiting lab...');
  notify('ğŸšª Returning to city...');
  playSound(600, 0.25);
  
  state.insideLab = false;
  state.currentLab = null;
  
  // Clear scene
  scene.clear();
  interactables = [];
  
  // Restore city environment
  scene.background = new THREE.Color(0x87CEEB);
  scene.fog = new THREE.Fog(0x87CEEB, 50, 600);
  
  // Lights
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
  scene.add(ambientLight);
  
  const sun = new THREE.DirectionalLight(0xffffff, 1.0);
  sun.position.set(200, 300, 150);
  sun.castShadow = true;
  scene.add(sun);
  
  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(1200, 1200),
    new THREE.MeshLambertMaterial({ color: 0x228B22 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);
  
  // Road
  const road = new THREE.Mesh(
    new THREE.PlaneGeometry(60, 1000),
    new THREE.MeshLambertMaterial({ color: 0x404040 })
  );
  road.rotation.x = -Math.PI / 2;
  road.position.y = 0.01;
  scene.add(road);
  
  // Road markings
  for (let i = -500; i <= 500; i += 30) {
    const line = new THREE.Mesh(
      new THREE.PlaneGeometry(1.5, 12),
      new THREE.MeshLambertMaterial({ color: 0xffffff })
    );
    line.rotation.x = -Math.PI / 2;
    line.position.set(0, 0.02, i);
    scene.add(line);
  }
  
  // Recreate city
  createCity();
  
  // Reset camera
  camera.position.set(0, 1.7, 350);
  velocity.set(0, 0, 0);
  
  updateHUD();
  drawMiniMap();
}

// ============================================
// CONTROLS
// ============================================
function setupControls() {
  document.addEventListener('keydown', (e) => {
    switch(e.code) {
      case 'KeyW': moveForward = true; break;
      case 'KeyS': moveBackward = true; break;
      case 'KeyA': moveLeft = true; break;
      case 'KeyD': moveRight = true; break;
      case 'ShiftLeft': sprint = true; break;
      case 'KeyE': handleInteraction(); break;
      case 'KeyM': toggleMap(); break;
      case 'Escape':
        if (state.gadgetActive) closeGadget();
        else if (state.insideLab) exitLab();
        else controls.unlock();
        break;
    }
  });
  
  document.addEventListener('keyup', (e) => {
    switch(e.code) {
      case 'KeyW': moveForward = false; break;
      case 'KeyS': moveBackward = false; break;
      case 'KeyA': moveLeft = false; break;
      case 'KeyD': moveRight = false; break;
      case 'ShiftLeft': sprint = false; break;
    }
  });
  
  document.getElementById('canvas').addEventListener('click', () => {
    if (!state.gadgetActive) controls.lock();
  });
}

function toggleMap() {
  state.mapVisible = !state.mapVisible;
  document.getElementById('miniMap').style.display = state.mapVisible ? 'block' : 'none';
  if (state.mapVisible) drawMiniMap();
  playSound(1000, 0.12);
}

// ============================================
// INTERACTION
// ============================================
function handleInteraction() {
  if (!state.nearInteractable) return;
  
  const ud = state.nearInteractable.userData;
  
  if (ud.type === 'entrance') {
    enterLab(ud.lab);
  } else if (ud.type === 'exit') {
    exitLab();
  } else if (ud.interactive) {
    controls.unlock();
    state.gadgetActive = true;
    document.getElementById('gadgetUI').style.display = 'block';
    document.getElementById('gadgetTitle').textContent = ud.name;
    document.getElementById('gadgetSubtitle').textContent = 'Interactive gadget experience';
    playSound(900, 0.15);
    
    // Show appropriate interface based on lab
    if (state.currentLab === 'Robo Lab') {
      showRobotBuilder();
    } else if (state.currentLab === 'Flying Car Showroom') {
      showCarShowroom();
    } else if (state.currentLab === 'Consciousness Upload') {
      showMindUpload();
    } else {
      showGenericGadget();
    }
  }
}

// ============================================
// GADGET INTERFACES
// ============================================

// ROBOT BUILDER
function showRobotBuilder() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   HUMANOID ASSEMBLY STATION 2077     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Welcome to the Robot Builder!

Build your custom humanoid robot from scratch.
Follow the step-by-step process to create
your perfect robotic companion.

STEP 1: Select Robot Body Type</div>
    <div class="optionGrid">
      <div class="option" onclick="selectRobotBody('humanoid')">ğŸ¤– Humanoid<br><small>Human-like appearance</small></div>
      <div class="option" onclick="selectRobotBody('animal')">ğŸ• Animal<br><small>Pet-like companion</small></div>
      <div class="option" onclick="selectRobotBody('custom')">âš™ï¸ Custom<br><small>Unique design</small></div>
    </div>
  `;
}

window.selectRobotBody = function(body) {
  state.robotBuild.body = body;
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ROBOT BODY: ${body.toUpperCase().padEnd(24)} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Excellent choice! The ${body} body type offers
great versatility and functionality.

STEP 2: Select Robot Size</div>
    <div class="optionGrid">
      <div class="option" onclick="selectRobotSize('small')">Small<br><small>50cm tall - Compact</small></div>
      <div class="option" onclick="selectRobotSize('medium')">Medium<br><small>150cm tall - Standard</small></div>
      <div class="option" onclick="selectRobotSize('large')">Large<br><small>250cm tall - Imposing</small></div>
    </div>
  `;
};

window.selectRobotSize = function(size) {
  state.robotBuild.size = size;
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ROBOT SIZE: ${size.toUpperCase().padEnd(26)} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Perfect! Your ${state.robotBuild.body} robot will be
${size} sized.

STEP 3: Choose AI Personality</div>
    <div class="optionGrid">
      <div class="option" onclick="buildRobot('friendly')">ğŸ˜Š Friendly<br><small>Helpful and kind</small></div>
      <div class="option" onclick="buildRobot('professional')">ğŸ’¼ Professional<br><small>Efficient and formal</small></div>
      <div class="option" onclick="buildRobot('playful')">ğŸ® Playful<br><small>Fun and energetic</small></div>
    </div>
  `;
};

window.buildRobot = function(ai) {
  state.robotBuild.ai = ai;
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="buildScreen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   BUILDING YOUR ROBOT...              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Configuration:
- Body Type: ${state.robotBuild.body}
- Size: ${state.robotBuild.size}
- AI Personality: ${ai}

Initializing assembly process...</div>
    <div class="progress"><div class="progressBar" id="buildProgress"></div></div>
  `;
  
  let progress = 0;
  const stages = [
    'Fabricating chassis...',
    'Installing servo motors...',
    'Connecting neural network...',
    'Programming AI personality...',
    'Calibrating sensors...',
    'Running diagnostics...',
    'Finalizing assembly...'
  ];
  let stageIndex = 0;
  
  const interval = setInterval(() => {
    progress += 3;
    document.getElementById('buildProgress').style.width = progress + '%';
    playSound(950 + progress * 10, 0.08);
    
    if (progress % 15 === 0 && stageIndex < stages.length) {
      const screen = document.getElementById('buildScreen');
      screen.textContent += '\n' + stages[stageIndex];
      stageIndex++;
    }
    
    if (progress >= 100) {
      clearInterval(interval);
      
      const serialNumber = 'RBT-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      
      document.getElementById('buildScreen').textContent = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ROBOT BUILD COMPLETE!               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Your custom robot is ready!

SPECIFICATIONS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Body Type:    ${state.robotBuild.body}
Size:         ${state.robotBuild.size}
AI:           ${ai}
Serial:       ${serialNumber}
Status:       ACTIVATED âœ“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Your robot is now operational and ready
to serve!`;
      
      // Calculate XP bonus
      let xpBonus = 250;
      if (state.char === 'Robo Engineer') xpBonus *= 2;
      
      state.xp += xpBonus;
      state.gadgetsUsed++;
      state.inventory.push(`Robot ${serialNumber}`);
      updateHUD();
      notify(`âœ“ Robot Built Successfully! +${xpBonus} XP`);
      playSound(1700, 0.6);
      
      setTimeout(closeGadget, 4000);
    }
  }, 120);
};

// FLYING CAR SHOWROOM
function showCarShowroom() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   FLYING CAR SHOWROOM 2077            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Welcome to the future of transportation!

Test drive our latest flying vehicles with
advanced VR simulation technology.

SELECT VEHICLE FOR TEST DRIVE:</div>
    <div class="optionGrid">
      <div class="option" onclick="testDriveCar('aerosedan')">ğŸš— AeroSedan 2077<br><small>Family vehicle</small></div>
      <div class="option" onclick="testDriveCar('racer')">ğŸï¸ Quantum Racer X<br><small>Speed demon</small></div>
      <div class="option" onclick="testDriveCar('luxury')">âœ¨ Gravity Cruiser<br><small>Luxury class</small></div>
    </div>
  `;
}

window.testDriveCar = function(car) {
  state.carChoice = car;
  
  const carSpecs = {
    aerosedan: { name: 'AeroSedan 2077', speed: 320, range: 800, price: 450000 },
    racer: { name: 'Quantum Racer X', speed: 580, range: 400, price: 1200000 },
    luxury: { name: 'Gravity Cruiser', speed: 280, range: 1200, price: 2500000 }
  };
  
  const specs = carSpecs[car];
  
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="driveScreen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ${specs.name.toUpperCase().padEnd(36)} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VEHICLE SPECIFICATIONS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Max Speed:    ${specs.speed} km/h
Range:        ${specs.range} km
Price:        $${specs.price.toLocaleString()}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Initializing VR test drive simulator...
Loading city environment...
Calibrating flight controls...

TEST DRIVE IN PROGRESS...</div>
    <div class="progress"><div class="progressBar" id="driveProgress"></div></div>
  `;
  
  let progress = 0;
  const events = [
    'Taking off...',
    'Ascending to cruising altitude...',
    'Navigating through city...',
    'Testing maneuverability...',
    'Reaching maximum speed...',
    'Performing aerial stunts...',
    'Landing sequence initiated...'
  ];
  let eventIndex = 0;
  
  const interval = setInterval(() => {
    progress += 2.5;
    document.getElementById('driveProgress').style.width = progress + '%';
    playSound(880 + progress * 8, 0.08);
    
    if (progress % 15 === 0 && eventIndex < events.length) {
      const screen = document.getElementById('driveScreen');
      screen.textContent += '\n' + events[eventIndex];
      eventIndex++;
    }
    
    if (progress >= 100) {
      clearInterval(interval);
      
      const distance = (Math.random() * 20 + 40).toFixed(1);
      const maxSpeed = (specs.speed * (0.9 + Math.random() * 0.1)).toFixed(0);
      const altitude = Math.floor(Math.random() * 500 + 1000);
      
      document.getElementById('driveScreen').textContent = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TEST DRIVE COMPLETE!                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PERFORMANCE REPORT:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Vehicle:      ${specs.name}
Distance:     ${distance} km
Max Speed:    ${maxSpeed} km/h
Max Altitude: ${altitude} m
Flight Time:  12 minutes 34 seconds
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Performance Rating: â­â­â­â­â­

Excellent handling and performance!
Test drive data saved to your profile.`;
      
      // Calculate XP bonus
      let xpBonus = 200;
      if (state.char === 'Flying Car Pilot') xpBonus *= 2;
      
      state.xp += xpBonus;
      state.gadgetsUsed++;
      state.inventory.push(`${specs.name} Test Drive Data`);
      updateHUD();
      notify(`âœ“ Test Drive Complete! +${xpBonus} XP`);
      playSound(1650, 0.6);
      
      setTimeout(closeGadget, 4000);
    }
  }, 180);
};

// CONSCIOUSNESS UPLOAD
function showMindUpload() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   CONSCIOUSNESS UPLOAD CENTER         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DIGITAL IMMORTALITY SYSTEM

This revolutionary technology allows you to
upload your consciousness to a digital realm,
achieving true immortality.

âš ï¸  WARNING:
This process creates a digital copy of your
consciousness. Your original biological
consciousness remains intact.

UPLOAD PROCESS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Brain Scanning        (5 minutes)
2. Neural Mapping        (10 minutes)
3. Memory Extraction     (15 minutes)
4. Personality Analysis  (8 minutes)
5. Avatar Creation       (2 minutes)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Total Time: 40 minutes
Success Rate: 99.7%

Ready to begin?</div>
    <div style="text-align: center; margin-top: 20px;">
      <button class="actionBtn success" onclick="startMindUpload()">â–¶ BEGIN UPLOAD PROCESS</button>
    </div>
  `;
}

window.startMindUpload = function() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="uploadScreen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   CONSCIOUSNESS UPLOAD IN PROGRESS    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Please remain still and relaxed...

Initializing brain scanner...</div>
    <div class="progress"><div class="progressBar" id="uploadProgress"></div></div>
  `;
  
  let progress = 0;
  const stages = [
    'Scanning brain structure...',
    'Mapping 86 billion neurons...',
    'Extracting neural patterns...',
    'Copying memory engrams...',
    'Analyzing personality traits...',
    'Synthesizing consciousness data...',
    'Creating digital avatar...',
    'Uploading to quantum server...',
    'Verifying data integrity...',
    'Finalizing upload...'
  ];
  let stageIndex = 0;
  
  const interval = setInterval(() => {
    progress += 2;
    document.getElementById('uploadProgress').style.width = progress + '%';
    playSound(940 + progress * 9, 0.08);
    
    if (progress % 10 === 0 && stageIndex < stages.length) {
      const screen = document.getElementById('uploadScreen');
      screen.textContent += '\n' + stages[stageIndex];
      stageIndex++;
    }
    
    if (progress >= 100) {
      clearInterval(interval);
      
      const avatarId = 'MIND-' + Math.floor(Math.random() * 100000).toString().padStart(5, '0');
      
      document.getElementById('uploadScreen').textContent = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   UPLOAD COMPLETE!                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Your consciousness has been successfully
digitized and uploaded to the cloud!

DIGITAL AVATAR INFORMATION:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Avatar ID:     ${avatarId}
Storage:       Quantum Server Array
Backup:        3 redundant copies
Access:        Anytime, anywhere
Status:        ACTIVE âœ“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

YOU ARE NOW DIGITALLY IMMORTAL!

Your digital self can:
â€¢ Live in virtual worlds
â€¢ Access infinite knowledge
â€¢ Never age or die
â€¢ Merge with other minds
â€¢ Experience multiple realities

Welcome to digital existence!`;
      
      // Calculate XP bonus
      let xpBonus = 300;
      if (state.char === 'Mind Hacker') xpBonus *= 1.5;
      
      state.xp += xpBonus;
      state.gadgetsUsed++;
      state.inventory.push(`Digital Avatar ${avatarId}`);
      updateHUD();
      notify(`âœ“ Consciousness Uploaded! +${xpBonus} XP`);
      playSound(1800, 0.7);
      
      setTimeout(closeGadget, 5000);
    }
  }, 150);
};

// GENERIC GADGET
function showGenericGadget() {
  document.getElementById('gadgetContent').innerHTML = `
    <div class="screen" id="genericScreen">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   SYSTEM INITIALIZED                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

All systems operational.
Diagnostics passed.

Ready to begin process.

Press START to continue...</div>
    <div class="progress"><div class="progressBar" id="genericProgress"></div></div>
    <div style="text-align: center; margin-top: 20px;">
      <button class="actionBtn success" onclick="startGeneric()">â–¶ START PROCESS</button>
    </div>
  `;
}

window.startGeneric = function() {
  let progress = 0;
  const interval = setInterval(() => {
    progress += 8;
    document.getElementById('genericProgress').style.width = progress + '%';
    playSound(850 + progress * 7, 0.08);
    
    if (progress >= 100) {
      clearInterval(interval);
      document.getElementById('genericScreen').textContent = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   PROCESS COMPLETE!                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Data collected successfully.
Results analyzed and verified.
All parameters within normal range.

Process completed successfully!`;
      
      state.xp += 120;
      state.gadgetsUsed++;
      updateHUD();
      notify('âœ“ Process Complete! +120 XP');
      playSound(1450, 0.5);
      
      setTimeout(closeGadget, 2500);
    }
  }, 250);
};

window.closeGadget = function() {
  state.gadgetActive = false;
  document.getElementById('gadgetUI').style.display = 'none';
  controls.lock();
  playSound(700, 0.12);
};

// ============================================
// RAYCASTING
// ============================================
function checkNearby() {
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  raycaster.set(camera.position, dir);
  
  const intersects = raycaster.intersectObjects(interactables, true);
  
  if (intersects.length > 0 && intersects[0].distance < 12) {
    let obj = intersects[0].object;
    
    // Traverse up to find the interactive object
    while (obj.parent && !obj.userData.interactive && obj.userData.type !== 'entrance' && obj.userData.type !== 'exit') {
      obj = obj.parent;
    }
    
    state.nearInteractable = obj;
    document.getElementById('interactPrompt').style.display = 'block';
  } else {
    state.nearInteractable = null;
    document.getElementById('interactPrompt').style.display = 'none';
  }
}

// ============================================
// ANIMATION LOOP
// ============================================
function animate() {
  requestAnimationFrame(animate);
  
  const time = performance.now();
  const delta = (time - prevTime) / 1000;
  
  if (controls.isLocked) {
    // Deceleration
    velocity.x -= velocity.x * 10.0 * delta;
    velocity.z -= velocity.z * 10.0 * delta;
    
    // Speed
    const speed = sprint ? 80 : 45;
    
    // Movement
    if (moveForward) velocity.z = -speed;
    if (moveBackward) velocity.z = speed;
    if (moveLeft) velocity.x = -speed;
    if (moveRight) velocity.x = speed;
    
    // Apply movement
    controls.moveRight(velocity.x * delta);
    controls.moveForward(velocity.z * delta);
    
    // Check for nearby interactables
    checkNearby();
    
    // Update map
    if (state.mapVisible && !state.insideLab) {
      drawMiniMap();
    }
  }
  
  prevTime = time;
  
  // Render
  renderer.render(scene, camera);
}

console.log('%câœ“ Script Loaded Successfully!', 'color: #27ae60; font-size: 16px; font-weight: bold;');
console.log('%cğŸ® Ready to play!', 'color: #3498db; font-size: 14px;');
</script>
</body>
</html>