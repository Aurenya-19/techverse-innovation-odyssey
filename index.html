<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechVerse 2077 - 15 Characters</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
body { font-family: 'Courier New', monospace; overflow: hidden; background: #000; color: #0ff; }
#canvas { display: block; width: 100vw; height: 100vh; }

#startScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #0a0a0a, #1a0a2e); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px; }
#startScreen h1 { font-size: clamp(2em, 6vw, 4em); color: #0ff; text-shadow: 0 0 30px #0ff, 0 0 60px #f0f; margin-bottom: 15px; animation: glow 2s ease-in-out infinite; letter-spacing: 3px; }
@keyframes glow { 0%, 100% { text-shadow: 0 0 30px #0ff, 0 0 60px #f0f; } 50% { text-shadow: 0 0 50px #0ff, 0 0 100px #f0f; } }
.subtitle { font-size: clamp(0.9em, 2vw, 1.1em); color: #f0f; margin-bottom: 20px; text-align: center; max-width: 90%; line-height: 1.5; }
.charGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-width: 1200px; width: 95%; margin-bottom: 15px; }
.charCard { background: rgba(0, 255, 255, 0.1); border: 2px solid #0ff; border-radius: 12px; padding: 15px; cursor: pointer; text-align: center; transition: all 0.3s; min-height: 140px; display: flex; flex-direction: column; justify-content: center; }
.charCard:hover { transform: scale(1.05); box-shadow: 0 0 25px #0ff; background: rgba(0, 255, 255, 0.2); }
.charCard.selected { background: rgba(255, 0, 255, 0.4) !important; border: 4px solid #f0f !important; box-shadow: 0 0 40px #f0f !important; transform: scale(1.08) !important; }
.charCard .icon { font-size: 2.5em; margin-bottom: 10px; pointer-events: none; }
.charCard h3 { color: #0ff; font-size: clamp(0.95em, 1.8vw, 1.15em); margin-bottom: 8px; pointer-events: none; font-weight: 800; }
.charCard p { color: #f0f; font-size: clamp(0.75em, 1.4vw, 0.85em); pointer-events: none; line-height: 1.3; }
.charCard .bonus { color: #0f0; font-size: clamp(0.7em, 1.3vw, 0.8em); margin-top: 5px; pointer-events: none; font-weight: bold; }
#selectedInfo { background: rgba(255, 0, 255, 0.9); color: #000; padding: 8px 25px; border-radius: 8px; font-size: clamp(0.95em, 1.8vw, 1.05em); font-weight: bold; margin-bottom: 15px; display: none; box-shadow: 0 0 20px #f0f; }
#startBtn { padding: clamp(12px, 2.5vw, 18px) clamp(40px, 8vw, 70px); font-size: clamp(1.1em, 2.2vw, 1.4em); background: linear-gradient(135deg, #0ff, #f0f); border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer; box-shadow: 0 0 30px #0ff; transition: all 0.3s; text-transform: uppercase; letter-spacing: 2px; }
#startBtn:hover { transform: scale(1.1); box-shadow: 0 0 50px #f0f; }
#startBtn:disabled { opacity: 0.5; cursor: not-allowed; }

#hud { position: fixed; top: 15px; left: 15px; background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 10px; border: 2px solid #0ff; min-width: 250px; z-index: 1000; display: none; backdrop-filter: blur(10px); }
#hud h3 { color: #0ff; margin-bottom: 10px; text-shadow: 0 0 10px #0ff; font-size: 1.3em; }
.hudStat { display: flex; justify-content: space-between; margin: 8px 0; color: #0ff; font-size: 1em; }
.hudStat .val { color: #f0f; font-weight: bold; text-shadow: 0 0 5px #f0f; }

#locationInfo { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); padding: 15px 35px; border-radius: 10px; border: 2px solid #f0f; z-index: 1000; display: none; backdrop-filter: blur(10px); }
#locationInfo h3 { color: #f0f; text-shadow: 0 0 10px #f0f; font-size: 1.4em; }

#interactPrompt { position: fixed; bottom: 150px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0ff, #f0f); padding: 15px 40px; border-radius: 10px; font-weight: bold; color: #000; z-index: 1000; display: none; animation: bounce 1s ease-in-out infinite; font-size: 1.1em; box-shadow: 0 0 30px #0ff; }
@keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

#infoPanel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: clamp(350px, 90vw, 900px); max-height: 85vh; overflow-y: auto; background: rgba(0, 0, 0, 0.95); padding: 40px; border-radius: 15px; border: 3px solid #0ff; z-index: 6000; display: none; box-shadow: 0 0 50px #0ff, 0 0 100px #f0f; backdrop-filter: blur(20px); }
#infoPanel h2 { color: #0ff; font-size: 2.5em; margin-bottom: 20px; text-align: center; text-shadow: 0 0 20px #0ff; }
#infoPanel p { color: #f0f; font-size: 1.1em; line-height: 1.8; margin: 15px 0; }
.infoBox { background: rgba(0, 255, 255, 0.1); padding: 18px; border-radius: 10px; margin: 18px 0; border-left: 5px solid #0ff; }
.successBox { background: rgba(255, 0, 255, 0.1); border-left-color: #f0f; }
.infoBtn { padding: 15px 35px; background: linear-gradient(135deg, #0ff, #f0f); border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer; margin: 10px; font-size: 1em; box-shadow: 0 0 20px #0ff; transition: all 0.3s; text-transform: uppercase; }
.infoBtn:hover { transform: scale(1.05); box-shadow: 0 0 40px #f0f; }

#controls { position: fixed; bottom: 25px; left: 25px; background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 10px; border: 2px solid #0ff; z-index: 1000; display: none; backdrop-filter: blur(10px); }
#controls h4 { color: #0ff; margin-bottom: 10px; text-shadow: 0 0 10px #0ff; font-size: 1.2em; }
.ctrl { color: #f0f; margin: 8px 0; font-size: 0.95em; }
.key { color: #000; font-weight: bold; background: linear-gradient(135deg, #0ff, #f0f); padding: 5px 12px; border-radius: 5px; margin-right: 8px; box-shadow: 0 0 10px #0ff; }

#notif { position: fixed; top: 150px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0ff, #f0f); color: #000; padding: 20px 50px; border-radius: 10px; font-weight: bold; font-size: 1.2em; opacity: 0; transition: opacity 0.5s; max-width: 90%; text-align: center; z-index: 2000; box-shadow: 0 0 40px #0ff, 0 0 80px #f0f; }
#notif.show { opacity: 1; }

#crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25px; height: 25px; pointer-events: none; z-index: 999; display: none; }
#crosshair::before, #crosshair::after { content: ''; position: absolute; background: #0ff; box-shadow: 0 0 10px #0ff; }
#crosshair::before { width: 3px; height: 25px; left: 11px; }
#crosshair::after { width: 25px; height: 3px; top: 11px; }

.hide { display: none !important; }
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.4); }
::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #0ff, #f0f); border-radius: 5px; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="crosshair"></div>

<div id="startScreen">
  <h1>‚ö° TECHVERSE 2077 ‚ö°</h1>
  <p class="subtitle">üåü Choose Your Character ‚Ä¢ 15 Unique Specialists ‚Ä¢ Underground Tech Labs üåü</p>
  
  <div class="charGrid">
    <div class="charCard" data-char="Bio-Hacker" data-bonus="+50% XP in Biology Lab"><div class="icon">üß¨</div><h3>Bio-Hacker</h3><p>Synthetic life expert</p><div class="bonus">+50% Bio XP</div></div>
    <div class="charCard" data-char="Quantum Rebel" data-bonus="+50% XP in Quantum Lab"><div class="icon">‚öõÔ∏è</div><h3>Quantum Rebel</h3><p>Underground physicist</p><div class="bonus">+50% Quantum XP</div></div>
    <div class="charCard" data-char="Neuro-Engineer" data-bonus="+50% XP in Optogenetics Lab"><div class="icon">üß†</div><h3>Neuro-Engineer</h3><p>Brain-tech specialist</p><div class="bonus">+50% Neuro XP</div></div>
    <div class="charCard" data-char="Startup Founder" data-bonus="+100% XP in Startup Hub"><div class="icon">üöÄ</div><h3>Startup Founder</h3><p>Tech entrepreneur</p><div class="bonus">+100% Hub XP</div></div>
    <div class="charCard" data-char="Ocean Engineer" data-bonus="+50% XP in OTEC Lab"><div class="icon">üåä</div><h3>Ocean Engineer</h3><p>OTEC power specialist</p><div class="bonus">+50% Ocean XP</div></div>
    <div class="charCard" data-char="Matter Sculptor" data-bonus="+50% XP in Programmable Matter Lab"><div class="icon">üîÆ</div><h3>Matter Sculptor</h3><p>Claytronics expert</p><div class="bonus">+50% Matter XP</div></div>
    <div class="charCard" data-char="Energy Anarchist" data-bonus="+50% XP in Wireless Power Lab"><div class="icon">‚ö°</div><h3>Energy Anarchist</h3><p>Wireless power hacker</p><div class="bonus">+50% Energy XP</div></div>
    <div class="charCard" data-char="Myco-Technologist" data-bonus="+50% XP in Mycelium Lab"><div class="icon">üçÑ</div><h3>Myco-Technologist</h3><p>Fungal computing researcher</p><div class="bonus">+50% Myco XP</div></div>
    <div class="charCard" data-char="Cryo-Scientist" data-bonus="+50% XP in Cryogenics Lab"><div class="icon">üßä</div><h3>Cryo-Scientist</h3><p>Reversible freezing expert</p><div class="bonus">+50% Cryo XP</div></div>
    <div class="charCard" data-char="Stealth Engineer" data-bonus="+50% XP in Metamaterials Lab"><div class="icon">üëª</div><h3>Stealth Engineer</h3><p>Invisibility specialist</p><div class="bonus">+50% Stealth XP</div></div>
    <div class="charCard" data-char="Acoustic Physicist" data-bonus="+50% XP in Acoustic Lab"><div class="icon">üîä</div><h3>Acoustic Physicist</h3><p>Sound levitation expert</p><div class="bonus">+50% Acoustic XP</div></div>
    <div class="charCard" data-char="Age Hacker" data-bonus="+50% XP in Epigenetics Lab"><div class="icon">‚è≥</div><h3>Age Hacker</h3><p>Longevity researcher</p><div class="bonus">+50% Age XP</div></div>
    <div class="charCard" data-char="Cyborg Mechanic" data-bonus="+25% XP in ALL Labs"><div class="icon">ü§ñ</div><h3>Cyborg Mechanic</h3><p>Augmentation specialist</p><div class="bonus">+25% All XP</div></div>
    <div class="charCard" data-char="Space Architect" data-bonus="Start Level 2"><div class="icon">üåå</div><h3>Space Architect</h3><p>Megastructure designer</p><div class="bonus">Start Lv2</div></div>
    <div class="charCard" data-char="Nano-Surgeon" data-bonus="+200 Starting XP"><div class="icon">üíä</div><h3>Nano-Surgeon</h3><p>Medical nanobot engineer</p><div class="bonus">+200 Start XP</div></div>
  </div>
  
  <div id="selectedInfo">Selected: None</div>
  <button id="startBtn" disabled>JACK IN</button>
</div>

<div id="hud">
  <h3>‚ö° STATUS</h3>
  <div class="hudStat"><span>Role:</span><span class="val" id="role">-</span></div>
  <div class="hudStat"><span>Level:</span><span class="val" id="lvl">1</span></div>
  <div class="hudStat"><span>XP:</span><span class="val" id="xp">0/1000</span></div>
  <div class="hudStat"><span>Labs:</span><span class="val" id="labsVisited">0/11</span></div>
  <div class="hudStat"><span>Items:</span><span class="val" id="itemsFound">0</span></div>
</div>

<div id="locationInfo"><h3 id="currentLocation">üìç Neo-City</h3></div>
<div id="interactPrompt">Press E to Hack</div>
<div id="infoPanel"><h2 id="panelTitle">Tech</h2><div id="panelContent"></div></div>

<div id="controls">
  <h4>‚ö° CONTROLS</h4>
  <div class="ctrl"><span class="key">WASD</span> Move</div>
  <div class="ctrl"><span class="key">MOUSE</span> Look Around</div>
  <div class="ctrl"><span class="key">E</span> Interact</div>
  <div class="ctrl"><span class="key">SHIFT</span> Sprint</div>
  <div class="ctrl"><span class="key">ESC</span> Exit/Close</div>
</div>

<div id="notif"></div>

<script type="importmap">
{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}
</script>

<script type="module">
import * as THREE from 'three';
import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

const state = { char: null, charBonus: null, lvl: 1, xp: 0, xpMax: 1000, labsVisited: new Set(), itemsFound: 0, insideLab: false, currentLab: null, nearInteractable: null };
let scene, camera, renderer, controls, raycaster = new THREE.Raycaster(), interactables = [];
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, sprint = false;
let velocity = new THREE.Vector3(), direction = new THREE.Vector3(), prevTime = performance.now();

const labConfigs = {
  'Startup Hub': { icon: 'üöÄ', color: 0xff00ff, pos: [0, 0, 0], desc: 'Garage-style innovation hub with whiteboards, prototypes, pitch stage, investor area, funding board, patent wall. Raw startup energy meets cutting-edge tech.' },
  'Xenobiology': { icon: 'üß¨', color: 0x00ff88, pos: [-60, 0, -80], desc: 'Synthetic life with non-natural DNA (XNA). Create alien organisms. Controversial but revolutionary. Equipment: DNA synthesizers, bio-reactors, gene sequencers.' },
  'OTEC Energy': { icon: 'üåä', color: 0x0088ff, pos: [60, 0, -80], desc: 'Ocean Thermal Energy Conversion. Unlimited clean power from temperature differences. Hawaii pilot plant. Equipment: Heat exchangers, turbines, power generators.' },
  'Optogenetics': { icon: 'üß†', color: 0xff0088, pos: [-60, 0, -20], desc: 'Control neurons with light pulses. Cure blindness, Parkinson\'s. Upload skills to brain. Stanford/MIT research. Equipment: Optogenetic implants, neural interfaces, light stimulators.' },
  'Programmable Matter': { icon: 'üîÆ', color: 0x8800ff, pos: [60, 0, -20], desc: 'Shape-shifting materials (Claytronics). Carnegie Mellon catoms. Instant manufacturing. Equipment: Catom assemblers, reconfiguration controllers, matter programmers.' },
  'Wireless Power': { icon: '‚ö°', color: 0xffff00, pos: [-60, 0, 40], desc: 'Electricity through air without wires. MIT WiTricity. No more charging. Power anywhere. Equipment: Resonant coils, power transmitters, wireless receivers.' },
  'Mycelium Computing': { icon: 'üçÑ', color: 0x88ff00, pos: [60, 0, 40], desc: 'Fungal networks as bio-computers. Living buildings. Nature\'s internet. Equipment: Mycelium substrates, bio-sensors, fungal processors.' },
  'Cryogenics': { icon: 'üßä', color: 0x00ffff, pos: [-60, 0, 100], desc: 'Reversible freezing of organs/bodies. 21st Century Medicine - rabbit kidney revival. Space travel, immortality. Equipment: Cryo-chambers, vitrification systems, revival protocols.' },
  'Metamaterials': { icon: 'üëª', color: 0xff00ff, pos: [60, 0, 100], desc: 'Invisibility cloaks. Duke University electromagnetic cloaking. Military classified. Perfect lenses. Equipment: Metamaterial fabricators, cloaking devices, optical manipulators.' },
  'Acoustic Levitation': { icon: 'üîä', color: 0xff8800, pos: [-60, 0, 160], desc: 'Levitate objects using sound waves. ETH Zurich, NASA. Contactless manufacturing. 3D printing in air. Equipment: Acoustic levitators, ultrasonic arrays, levitation chambers.' },
  'Epigenetics': { icon: '‚è≥', color: 0x00ff00, pos: [60, 0, 160], desc: 'Reverse aging by resetting cell age markers. Harvard - David Sinclair. Altos Labs. Live 200+ years. Equipment: Epigenetic reprogrammers, age reversal chambers, cellular clocks.' }
};

// Character selection
document.querySelectorAll('.charCard').forEach(card => {
  card.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    document.querySelectorAll('.charCard').forEach(c => c.classList.remove('selected'));
    this.classList.add('selected');
    state.char = this.dataset.char;
    state.charBonus = this.dataset.bonus;
    document.getElementById('selectedInfo').textContent = `‚úì Selected: ${state.char} | ${state.charBonus}`;
    document.getElementById('selectedInfo').style.display = 'block';
    document.getElementById('startBtn').disabled = false;
  });
  card.addEventListener('mousedown', e => e.preventDefault());
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!state.char) return alert('‚ö†Ô∏è Select a character first!');
  
  // Apply character bonuses
  if (state.char === 'Space Architect') state.lvl = 2;
  if (state.char === 'Nano-Surgeon') state.xp = 200;
  
  document.getElementById('startScreen').classList.add('hide');
  ['hud', 'locationInfo', 'controls', 'crosshair'].forEach(id => document.getElementById(id).style.display = 'block');
  document.getElementById('role').textContent = state.char;
  init();
});

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0a1a);
  scene.fog = new THREE.FogExp2(0x0a0a1a, 0.0015);
  
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 1.7, 100);
  
  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  
  controls = new PointerLockControls(camera, document.body);
  
  scene.add(new THREE.AmbientLight(0x0088ff, 0.3));
  
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({ color: 0x0a0a0a, roughness: 0.9 }));
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);
  
  createCyberpunkCity();
  setupControls();
  window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
  animate();
  updateHUD();
  updateLocation();
  notify(`‚ö° Welcome ${state.char}! ${state.charBonus}`);
}

function createCyberpunkCity() {
  for (let i = 0; i < 100; i++) {
    const light = new THREE.PointLight(Math.random() > 0.5 ? 0x00ffff : 0xff00ff, 2, 30);
    light.position.set((Math.random() - 0.5) * 400, 10 + Math.random() * 30, (Math.random() - 0.5) * 400);
    scene.add(light);
  }
  
  for (let i = 0; i < 10; i++) {
    const car = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 5), new THREE.MeshStandardMaterial({ color: 0x1a1a2e, emissive: 0x00ffff, emissiveIntensity: 0.5 }));
    car.position.set((Math.random() - 0.5) * 300, 15 + Math.random() * 20, (Math.random() - 0.5) * 300);
    car.rotation.y = Math.random() * Math.PI * 2;
    scene.add(car);
  }
  
  for (let i = 0; i < 15; i++) {
    const ad = new THREE.Mesh(new THREE.PlaneGeometry(8, 5), new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.8, transparent: true, opacity: 0.7 }));
    ad.position.set((Math.random() - 0.5) * 350, 20 + Math.random() * 15, (Math.random() - 0.5) * 350);
    ad.rotation.y = Math.random() * Math.PI * 2;
    scene.add(ad);
  }
  
  Object.entries(labConfigs).forEach(([name, config]) => {
    const size = name === 'Startup Hub' ? [60, 35, 70] : [40, 25, 50];
    const building = new THREE.Mesh(new THREE.BoxGeometry(...size), new THREE.MeshStandardMaterial({ color: 0x1a1a2e, emissive: config.color, emissiveIntensity: 0.2, roughness: 0.7, metalness: 0.3 }));
    building.position.set(config.pos[0], size[1] / 2, config.pos[2]);
    building.castShadow = true;
    building.receiveShadow = true;
    scene.add(building);
    
    for (let i = 0; i < 6; i++) {
      const bar = new THREE.Mesh(new THREE.BoxGeometry(size[0] * 0.8, 0.5, 0.5), new THREE.MeshStandardMaterial({ color: config.color, emissive: config.color, emissiveIntensity: 1 }));
      bar.position.set(config.pos[0], 4 + i * 4, config.pos[2] + size[2] / 2 + 0.3);
      scene.add(bar);
    }
    
    const door = new THREE.Mesh(new THREE.BoxGeometry(5, 7, 0.5), new THREE.MeshStandardMaterial({ color: 0x000000, emissive: config.color, emissiveIntensity: 0.5, roughness: 0.4, metalness: 0.6 }));
    door.position.set(config.pos[0], 3.5, config.pos[2] + size[2] / 2 + 0.3);
    door.userData = { type: 'entrance', lab: name, desc: config.desc };
    scene.add(door);
    interactables.push(door);
    
    const handle = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.8), new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.2, metalness: 0.9 }));
    handle.rotation.z = Math.PI / 2;
    handle.position.set(config.pos[0] - 1.5, 3.5, config.pos[2] + size[2] / 2 + 0.6);
    scene.add(handle);
    
    const doorLight = new THREE.PointLight(config.color, 3, 15);
    doorLight.position.set(config.pos[0], 7, config.pos[2] + size[2] / 2 + 2);
    doorLight.castShadow = true;
    scene.add(doorLight);
  });
}

function enterLab(labName, desc) {
  notify(`‚ö° Entering ${labName}...`);
  let xpBonus = 150;
  
  // Apply character bonuses
  if (state.char === 'Startup Founder' && labName === 'Startup Hub') xpBonus *= 2;
  if (state.char === 'Bio-Hacker' && labName === 'Xenobiology') xpBonus *= 1.5;
  if (state.char === 'Ocean Engineer' && labName === 'OTEC Energy') xpBonus *= 1.5;
  if (state.char === 'Neuro-Engineer' && labName === 'Optogenetics') xpBonus *= 1.5;
  if (state.char === 'Matter Sculptor' && labName === 'Programmable Matter') xpBonus *= 1.5;
  if (state.char === 'Energy Anarchist' && labName === 'Wireless Power') xpBonus *= 1.5;
  if (state.char === 'Myco-Technologist' && labName === 'Mycelium Computing') xpBonus *= 1.5;
  if (state.char === 'Cryo-Scientist' && labName === 'Cryogenics') xpBonus *= 1.5;
  if (state.char === 'Stealth Engineer' && labName === 'Metamaterials') xpBonus *= 1.5;
  if (state.char === 'Acoustic Physicist' && labName === 'Acoustic Levitation') xpBonus *= 1.5;
  if (state.char === 'Age Hacker' && labName === 'Epigenetics') xpBonus *= 1.5;
  if (state.char === 'Cyborg Mechanic') xpBonus *= 1.25;
  
  addXP(Math.floor(xpBonus));
  state.labsVisited.add(labName);
  state.insideLab = true;
  state.currentLab = labName;
  
  scene.clear();
  interactables = [];
  scene.background = new THREE.Color(0x0a0a0a);
  scene.add(new THREE.AmbientLight(0x0088ff, 0.2));
  
  if (labName === 'Startup Hub') createDetailedStartupHub();
  else createDetailedLabInterior(labName, desc);
  
  camera.position.set(0, 1.7, 28);
  camera.rotation.set(0, 0, 0);
  velocity.set(0, 0, 0);
  updateLocation();
  updateHUD();
}

function createDetailedStartupHub() {
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(60, 70), new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.9 }));
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);
  
  [[0, 2.5, -35, 60, 5, 0.3], [-30, 2.5, 0, 0.3, 5, 70], [30, 2.5, 0, 0.3, 5, 70], [0, 2.5, 35, 60, 5, 0.3]].forEach(w => {
    const wall = new THREE.Mesh(new THREE.BoxGeometry(w[3], w[4], w[5]), new THREE.MeshStandardMaterial({ color: 0x3a3a3a, roughness: 0.9 }));
    wall.position.set(w[0], w[1], w[2]);
    wall.castShadow = true;
    wall.receiveShadow = true;
    scene.add(wall);
  });
  
  for (let x = -20; x <= 20; x += 10) {
    for (let z = -25; z <= 25; z += 12.5) {
      const light = new THREE.PointLight(Math.random() > 0.5 ? 0x00ffff : 0xff00ff, 1.5, 20);
      light.position.set(x, 4.5, z);
      light.castShadow = true;
      scene.add(light);
      
      const fixture = new THREE.Mesh(new THREE.BoxGeometry(3, 0.2, 0.3), new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffaa, emissiveIntensity: 1 }));
      fixture.position.set(x, 4.85, z);
      scene.add(fixture);
    }
  }
  
  const wbTopics = ['XNA Synthesis', 'OTEC Calculations', 'Neural Pathways', 'Catom Algorithms', 'Power Transmission', 'Mycelium Networks', 'Cryo Protocols', 'Metamaterial Design', 'Acoustic Waves', 'Epigenetic Markers'];
  for (let i = 0; i < 10; i++) {
    const wb = new THREE.Mesh(new THREE.PlaneGeometry(8, 4), new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 }));
    wb.position.set(-29.8, 2.5, -30 + i * 6.5);
    wb.rotation.y = Math.PI / 2;
    wb.userData = { type: 'whiteboard', topic: wbTopics[i] };
    scene.add(wb);
    interactables.push(wb);
  }
  
  const prototypes = ['Bio-Reactor', 'Heat Exchanger', 'Neural Implant', 'Catom Unit', 'Power Coil', 'Fungal Substrate', 'Cryo-Chamber', 'Cloaking Device'];
  for (let i = 0; i < 8; i++) {
    const angle = (i / 8) * Math.PI * 2;
    const radius = 20;
    
    const base = new THREE.Mesh(new THREE.BoxGeometry(4, 0.3, 4), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.5, metalness: 0.5 }));
    base.position.set(Math.cos(angle) * radius, 0.15, Math.sin(angle) * radius);
    base.castShadow = true;
    scene.add(base);
    
    const body = new THREE.Mesh(new THREE.BoxGeometry(3, 2, 3), new THREE.MeshStandardMaterial({ color: 0x1a1a2e, emissive: 0xff00ff, emissiveIntensity: 0.4, roughness: 0.3, metalness: 0.7 }));
    body.position.set(Math.cos(angle) * radius, 1.15, Math.sin(angle) * radius);
    body.castShadow = true;
    body.userData = { type: 'prototype', name: prototypes[i] };
    scene.add(body);
    interactables.push(body);
    
    const screen = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 0.1), new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0x00ff88, emissiveIntensity: 0.8, roughness: 0.2, metalness: 0.8 }));
    screen.position.set(Math.cos(angle) * radius, 1.5, Math.sin(angle) * radius + 1.55);
    scene.add(screen);
    
    const protoLight = new THREE.PointLight(0xff00ff, 1, 8);
    protoLight.position.set(Math.cos(angle) * radius, 2.5, Math.sin(angle) * radius);
    scene.add(protoLight);
  }
  
  const stage = new THREE.Mesh(new THREE.CylinderGeometry(10, 10, 0.3), new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.5, roughness: 0.6, metalness: 0.4 }));
  stage.position.set(0, 0.15, 0);
  stage.userData = { type: 'pitch' };
  scene.add(stage);
  interactables.push(stage);
  
  const podium = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.2, 1), new THREE.MeshStandardMaterial({ color: 0x1a1a2e, roughness: 0.7, metalness: 0.3 }));
  podium.position.set(0, 0.6, 0);
  scene.add(podium);
  
  const fundingBoard = new THREE.Mesh(new THREE.PlaneGeometry(12, 6), new THREE.MeshStandardMaterial({ color: 0x000000, emissive: 0x00ffff, emissiveIntensity: 0.6 }));
  fundingBoard.position.set(29.8, 3, 0);
  fundingBoard.rotation.y = -Math.PI / 2;
  fundingBoard.userData = { type: 'funding' };
  scene.add(fundingBoard);
  interactables.push(fundingBoard);
  
  for (let i = 0; i < 6; i++) {
    const patent = new THREE.Mesh(new THREE.PlaneGeometry(3, 4), new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 }));
    patent.position.set(-12 + i * 4.8, 2.5, -34.8);
    patent.userData = { type: 'patent', id: i };
    scene.add(patent);
    interactables.push(patent);
  }
  
  addExitDoor(0, 2.5, 34.8);
}

function createDetailedLabInterior(labName, desc) {
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(40, 50), new THREE.MeshStandardMaterial({ color: 0xd0d0d0, roughness: 0.7, metalness: 0.3 }));
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);
  
  [[0, 2.5, -25, 40, 5, 0.3], [-20, 2.5, 0, 0.3, 5, 50], [20, 2.5, 0, 0.3, 5, 50], [0, 2.5, 25, 40, 5, 0.3]].forEach(w => {
    const wall = new THREE.Mesh(new THREE.BoxGeometry(w[3], w[4], w[5]), new THREE.MeshStandardMaterial({ color: 0xf0f0f0, roughness: 0.85, metalness: 0.15 }));
    wall.position.set(w[0], w[1], w[2]);
    wall.castShadow = true;
    wall.receiveShadow = true;
    scene.add(wall);
  });
  
  const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(40, 50), new THREE.MeshStandardMaterial({ color: 0xfafafa, roughness: 0.8, metalness: 0.2 }));
  ceiling.rotation.x = Math.PI / 2;
  ceiling.position.y = 5;
  ceiling.receiveShadow = true;
  scene.add(ceiling);
  
  for (let x = -15; x <= 15; x += 10) {
    for (let z = -15; z <= 15; z += 10) {
      const light = new THREE.PointLight(0xfff8e1, 1.5, 25);
      light.position.set(x, 4.5, z);
      light.castShadow = true;
      scene.add(light);
      
      const tube = new THREE.Mesh(new THREE.BoxGeometry(3.5, 0.3, 0.4), new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffcc, emissiveIntensity: 1.2, roughness: 0.3, metalness: 0.7 }));
      tube.position.set(x, 4.85, z);
      tube.castShadow = true;
      scene.add(tube);
    }
  }
  
  for (let shelfNum = 0; shelfNum < 4; shelfNum++) {
    const shelfX = -17;
    const shelfZ = -15 + shelfNum * 10;
    
    const back = new THREE.Mesh(new THREE.BoxGeometry(0.2, 4.5, 3.5), new THREE.MeshStandardMaterial({ color: 0x6b4423, roughness: 0.8, metalness: 0.2 }));
    back.position.set(shelfX, 2.25, shelfZ);
    back.castShadow = true;
    scene.add(back);
    
    for (let i = 0; i < 5; i++) {
      const shelf = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 3.5), new THREE.MeshStandardMaterial({ color: 0x8b6f47, roughness: 0.7, metalness: 0.3 }));
      shelf.position.set(shelfX - 0.15, -0.25 + i * 1, shelfZ);
      shelf.castShadow = true;
      scene.add(shelf);
      
      for (let j = 0; j < 8; j++) {
        const bookWidth = 0.15 + Math.random() * 0.1;
        const bookHeight = 0.7 + Math.random() * 0.2;
        const bookColors = [0xcc3333, 0x3366cc, 0x33cc66, 0xcc9933, 0x9933cc, 0x33cccc];
        const book = new THREE.Mesh(new THREE.BoxGeometry(bookWidth, bookHeight, 0.3), new THREE.MeshStandardMaterial({ color: bookColors[Math.floor(Math.random() * bookColors.length)], roughness: 0.7, metalness: 0.3 }));
        book.position.set(shelfX - 0.3, -0.2 + i * 1 + bookHeight / 2, shelfZ - 1.5 + j * 0.4);
        book.rotation.y = (Math.random() - 0.5) * 0.1;
        book.castShadow = true;
        book.userData = { type: 'book' };
        scene.add(book);
        interactables.push(book);
      }
    }
  }
  
  for (let i = 0; i < 4; i++) {
    const eqX = 15;
    const eqZ = -12 + i * 8;
    
    const base = new THREE.Mesh(new THREE.BoxGeometry(3.5, 0.3, 3.5), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.5, metalness: 0.5 }));
    base.position.set(eqX, 0.15, eqZ);
    base.castShadow = true;
    scene.add(base);
    
    const body = new THREE.Mesh(new THREE.BoxGeometry(3, 2.5, 3), new THREE.MeshStandardMaterial({ color: labConfigs[state.currentLab].color, roughness: 0.3, metalness: 0.7, emissive: labConfigs[state.currentLab].color, emissiveIntensity: 0.4 }));
    body.position.set(eqX, 1.65, eqZ);
    body.castShadow = true;
    body.userData = { type: 'equipment', id: i };
    scene.add(body);
    interactables.push(body);
    
    const screen = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 0.1), new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0x00ff88, emissiveIntensity: 0.8, roughness: 0.2, metalness: 0.8 }));
    screen.position.set(eqX, 2, eqZ + 1.55);
    scene.add(screen);
    
    const screenLight = new THREE.PointLight(0x00ff88, 0.5, 5);
    screenLight.position.set(eqX, 2, eqZ + 2);
    scene.add(screenLight);
    
    const eqLight = new THREE.PointLight(labConfigs[state.currentLab].color, 1, 10);
    eqLight.position.set(eqX, 3, eqZ);
    eqLight.castShadow = true;
    scene.add(eqLight);
  }
  
  for (let i = 0; i < 2; i++) {
    const deskX = -5 + i * 10;
    const deskZ = -10;
    
    const top = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.1, 2), new THREE.MeshStandardMaterial({ color: 0x8b6f47, roughness: 0.6, metalness: 0.4 }));
    top.position.set(deskX, 1, deskZ);
    top.castShadow = true;
    scene.add(top);
    
    for (let j = 0; j < 4; j++) {
      const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 1), new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.4, metalness: 0.6 }));
      leg.position.set(deskX + (j % 2 === 0 ? -1 : 1), 0.5, deskZ + (j < 2 ? -0.8 : 0.8));
      leg.castShadow = true;
      scene.add(leg);
    }
    
    const monitorStand = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.15, 0.3), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.5, metalness: 0.5 }));
    monitorStand.position.set(deskX, 1.25, deskZ);
    scene.add(monitorStand);
    
    const monitor = new THREE.Mesh(new THREE.BoxGeometry(1.8, 1.2, 0.1), new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0x2266ff, emissiveIntensity: 0.6, roughness: 0.2, metalness: 0.8 }));
    monitor.position.set(deskX, 1.8, deskZ);
    monitor.castShadow = true;
    scene.add(monitor);
    
    const monitorLight = new THREE.PointLight(0x2266ff, 0.5, 4);
    monitorLight.position.set(deskX, 1.8, deskZ + 0.5);
    scene.add(monitorLight);
  }
  
  const info = new THREE.Mesh(new THREE.PlaneGeometry(10, 6), new THREE.MeshStandardMaterial({ color: 0x000000, emissive: 0x00ffff, emissiveIntensity: 0.5 }));
  info.position.set(0, 3, -24.8);
  info.userData = { type: 'info', lab: labName, desc: desc };
  scene.add(info);
  interactables.push(info);
  
  addExitDoor(0, 2.5, 24.8);
}

function addExitDoor(x, y, z) {
  const exit = new THREE.Mesh(new THREE.BoxGeometry(4, 5, 0.4), new THREE.MeshStandardMaterial({ color: 0xcc3333, emissive: 0x661111, emissiveIntensity: 0.6, roughness: 0.4, metalness: 0.6 }));
  exit.position.set(x, y, z);
  exit.userData = { type: 'exit' };
  exit.castShadow = true;
  scene.add(exit);
  interactables.push(exit);
  
  const handle = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.6), new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.2, metalness: 0.9 }));
  handle.rotation.z = Math.PI / 2;
  handle.position.set(x - 1.2, y, z + 0.3);
  scene.add(handle);
  
  const exitLight = new THREE.SpotLight(0xff3333, 1, 12, Math.PI / 4);
  exitLight.position.set(x, y + 2, z - 1);
  exitLight.target.position.set(x, y, z);
  exitLight.castShadow = true;
  scene.add(exitLight);
  scene.add(exitLight.target);
}

function exitLab() {
  notify('‚ö° Exiting to Neo-City...');
  state.insideLab = false;
  state.currentLab = null;
  scene.clear();
  interactables = [];
  scene.background = new THREE.Color(0x0a0a1a);
  scene.fog = new THREE.FogExp2(0x0a0a1a, 0.0015);
  scene.add(new THREE.AmbientLight(0x0088ff, 0.3));
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({ color: 0x0a0a0a, roughness: 0.9 }));
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);
  createCyberpunkCity();
  camera.position.set(0, 1.7, 100);
  camera.rotation.set(0, 0, 0);
  velocity.set(0, 0, 0);
  updateLocation();
}

function setupControls() {
  document.addEventListener('keydown', (e) => {
    if (e.code === 'KeyW') moveForward = true;
    if (e.code === 'KeyS') moveBackward = true;
    if (e.code === 'KeyA') moveLeft = true;
    if (e.code === 'KeyD') moveRight = true;
    if (e.code === 'ShiftLeft') sprint = true;
    if (e.code === 'KeyE') handleInteraction();
    if (e.code === 'Escape') {
      if (document.getElementById('infoPanel').style.display === 'block') closeInfoPanel();
      else if (state.insideLab) exitLab();
    }
  });
  
  document.addEventListener('keyup', (e) => {
    if (e.code === 'KeyW') moveForward = false;
    if (e.code === 'KeyS') moveBackward = false;
    if (e.code === 'KeyA') moveLeft = false;
    if (e.code === 'KeyD') moveRight = false;
    if (e.code === 'ShiftLeft') sprint = false;
  });
  
  document.getElementById('canvas').addEventListener('click', () => {
    if (document.getElementById('infoPanel').style.display !== 'block') controls.lock();
  });
}

function handleInteraction() {
  if (!state.nearInteractable) return;
  const ud = state.nearInteractable.userData;
  
  let xpBonus = 1;
  if (state.char === 'Cyborg Mechanic') xpBonus = 1.25;
  
  if (ud.type === 'entrance') enterLab(ud.lab, ud.desc);
  else if (ud.type === 'exit') exitLab();
  else if (ud.type === 'info') showInfo(ud.lab, ud.desc);
  else if (ud.type === 'whiteboard') { notify(`üìù Whiteboard: ${ud.topic} | +${Math.floor(30 * xpBonus)} XP`); addXP(Math.floor(30 * xpBonus)); state.itemsFound++; }
  else if (ud.type === 'prototype') { notify(`üîß Prototype: ${ud.name} | +${Math.floor(40 * xpBonus)} XP`); addXP(Math.floor(40 * xpBonus)); state.itemsFound++; }
  else if (ud.type === 'pitch') showPitch();
  else if (ud.type === 'funding') { notify(`üí∞ Funding Board | +${Math.floor(25 * xpBonus)} XP`); addXP(Math.floor(25 * xpBonus)); state.itemsFound++; }
  else if (ud.type === 'patent') { notify(`üìú Patent #${ud.id + 1} | +${Math.floor(20 * xpBonus)} XP`); addXP(Math.floor(20 * xpBonus)); state.itemsFound++; }
  else if (ud.type === 'equipment') { notify(`‚ö° Using equipment | +${Math.floor(50 * xpBonus)} XP`); addXP(Math.floor(50 * xpBonus)); state.itemsFound++; }
  else if (ud.type === 'book') { notify(`üìö Reading research | +${Math.floor(15 * xpBonus)} XP`); addXP(Math.floor(15 * xpBonus)); state.itemsFound++; }
  updateHUD();
}

function showInfo(lab, desc) {
  document.getElementById('panelTitle').textContent = lab;
  document.getElementById('panelContent').innerHTML = `<div class="infoBox"><strong>‚ö° UNDERGROUND TECH:</strong><br><br>${desc}</div><div class="successBox"><strong>üî¨ WHY HIDDEN:</strong><br>Too controversial, expensive, or ahead of its time. But holds massive potential to revolutionize everything.</div><button class="infoBtn" onclick="closeInfoPanel()">CLOSE</button>`;
  document.getElementById('infoPanel').style.display = 'block';
  controls.unlock();
}

function showPitch() {
  document.getElementById('panelTitle').textContent = 'üöÄ PITCH STAGE';
  document.getElementById('panelContent').innerHTML = `<div class="infoBox"><strong>STARTUP PITCH AREA</strong><br><br>Present revolutionary ideas to investors. Get funding, build prototypes, change the world. This is where billion-dollar companies are born.</div><div class="successBox"><strong>üí∞ FUNDING ROUNDS:</strong><br>‚Ä¢ Seed: $500K<br>‚Ä¢ Series A: $5M<br>‚Ä¢ Series B: $20M<br>‚Ä¢ Series C: $50M<br>‚Ä¢ IPO: $500M+</div><button class="infoBtn" onclick="pitchIdea()">PITCH IDEA (+100 XP)</button><button class="infoBtn" onclick="closeInfoPanel()">CLOSE</button>`;
  document.getElementById('infoPanel').style.display = 'block';
  controls.unlock();
}

window.pitchIdea = () => { 
  let xpBonus = state.char === 'Startup Founder' ? 2 : (state.char === 'Cyborg Mechanic' ? 1.25 : 1);
  addXP(Math.floor(100 * xpBonus)); 
  state.itemsFound++; 
  notify(`üöÄ Pitch successful! +${Math.floor(100 * xpBonus)} XP`); 
  closeInfoPanel(); 
  updateHUD(); 
};
window.closeInfoPanel = () => { document.getElementById('infoPanel').style.display = 'none'; };

function checkNearby() {
  raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
  const intersects = raycaster.intersectObjects(interactables);
  if (intersects.length > 0 && intersects[0].distance < 6) {
    state.nearInteractable = intersects[0].object;
    document.getElementById('interactPrompt').style.display = 'block';
  } else {
    state.nearInteractable = null;
    document.getElementById('interactPrompt').style.display = 'none';
  }
}

function animate() {
  requestAnimationFrame(animate);
  const time = performance.now();
  if (controls.isLocked) {
    const delta = (time - prevTime) / 1000;
    velocity.x -= velocity.x * 8.0 * delta;
    velocity.z -= velocity.z * 8.0 * delta;
    direction.z = Number(moveForward) - Number(moveBackward);
    direction.x = Number(moveRight) - Number(moveLeft);
    direction.normalize();
    const speed = sprint ? 50 : 30;
    if (moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
    if (moveLeft || moveRight) velocity.x -= direction.x * speed * delta;
    controls.moveRight(-velocity.x * delta);
    controls.moveForward(-velocity.z * delta);
    checkNearby();
  }
  prevTime = time;
  renderer.render(scene, camera);
}

function updateLocation() {
  document.getElementById('currentLocation').textContent = state.insideLab ? `${labConfigs[state.currentLab].icon} ${state.currentLab}` : 'üìç Neo-City 2077';
}

function addXP(amount) {
  state.xp += amount;
  while (state.xp >= state.xpMax) { state.xp -= state.xpMax; state.lvl++; state.xpMax = Math.floor(state.xpMax * 1.5); notify(`‚ö° LEVEL UP! Level ${state.lvl}!`); }
  updateHUD();
}

function updateHUD() {
  document.getElementById('lvl').textContent = state.lvl;
  document.getElementById('xp').textContent = `${state.xp}/${state.xpMax}`;
  document.getElementById('labsVisited').textContent = `${state.labsVisited.size}/11`;
  document.getElementById('itemsFound').textContent = state.itemsFound;
}

function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 4000);
}
</script>
</body>
</html>